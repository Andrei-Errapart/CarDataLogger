<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>AVR32 UC3 - TC Driver: tc_example2.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>tc_example2.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
Timer/Counter example 2. 
<p>
This example involves 2 timer/counter channels, one configured in capture mode(input) and the other configured in Waveform mode(output) to generate a PWM on the output.<p>
<ul>
<li>Compiler: IAR EWAVR32 and GNU GCC for AVR32</li><li>Supported devices: All AVR32 devices with a TC module can be used.</li><li>AppNote:</li></ul>
<p>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support and FAQ: <a href="http://support.atmel.no/">http://support.atmel.no/</a> </dd></dl>

<p>
Definition in file <a class="el" href="a00009.html">tc_example2.c</a>.
<p>
<code>#include &lt;avr32/io.h&gt;</code><br>
<code>#include &quot;compiler.h&quot;</code><br>
<code>#include &quot;board.h&quot;</code><br>
<code>#include &quot;pm.h&quot;</code><br>
<code>#include &quot;gpio.h&quot;</code><br>
<code>#include &quot;<a class="el" href="a00008.html">tc.h</a>&quot;</code><br>

<p>
<a href="a00009.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00006.html#3cae1237ec68bcc74789e36ecb33d722">init_tc_input</a> (volatile avr32_tc_t *tc, unsigned int channel)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the timer/counter capture.  <a href="#3cae1237ec68bcc74789e36ecb33d722"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00006.html#b7dc76c0a7bf55d48864c1ec906834de">init_tc_output</a> (volatile avr32_tc_t *tc, unsigned int channel)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the timer/counter waveform.  <a href="#b7dc76c0a7bf55d48864c1ec906834de"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00006.html#840291bc02cba5474a4cb46a9b9566fe">main</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Main function. Execution starts here.  <a href="#840291bc02cba5474a4cb46a9b9566fe"></a><br></td></tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="3cae1237ec68bcc74789e36ecb33d722"></a><!-- doxytag: member="tc_example2.c::init_tc_input" ref="3cae1237ec68bcc74789e36ecb33d722" args="(volatile avr32_tc_t *tc, unsigned int channel)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void init_tc_input           </td>
          <td>(</td>
          <td class="paramtype">volatile avr32_tc_t *&nbsp;</td>
          <td class="paramname"> <em>tc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>channel</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initializes the timer/counter capture. 
<p>

<p>
Definition at line <a class="el" href="a00009.html#l00113">113</a> of file <a class="el" href="a00009.html">tc_example2.c</a>.
<p>
References <a class="el" href="a00008.html#l00137">TC_BURST_NOT_GATED</a>, <a class="el" href="a00008.html#l00146">TC_CLOCK_RISING_EDGE</a>, <a class="el" href="a00008.html#l00157">TC_CLOCK_SOURCE_TC5</a>, <a class="el" href="a00008.html#l00112">TC_EXT_TRIG_SEL_TIOA</a>, <a class="el" href="a00007.html#l00104">tc_init_capture()</a>, <a class="el" href="a00008.html#l00096">TC_NO_TRIGGER_COMPARE_RC</a>, <a class="el" href="a00008.html#l00130">TC_SEL_FALLING_EDGE</a>, and <a class="el" href="a00008.html#l00128">TC_SEL_NO_EDGE</a>.
<p>
Referenced by <a class="el" href="a00009.html#l00178">main()</a>.<div class="fragment"><pre class="fragment"><a name="l00114"></a>00114 {
<a name="l00115"></a>00115   <span class="comment">// Options for capture mode.</span>
<a name="l00116"></a>00116   <a class="code" href="a00001.html">tc_capture_opt_t</a> capture_opt =
<a name="l00117"></a>00117   {
<a name="l00118"></a>00118     .channel  = channel,                      <span class="comment">// Channel selection.</span>
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     .ldrb     = <a class="code" href="a00005.html#70b6c234a55fa7723831fe80f635a0f8">TC_SEL_NO_EDGE</a>,               <span class="comment">// RB loading selection.</span>
<a name="l00121"></a>00121     .ldra     = <a class="code" href="a00005.html#17a81d6ac9326847007bc5336a93a677">TC_SEL_FALLING_EDGE</a>,          <span class="comment">// RA loading selection.</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     .cpctrg   = <a class="code" href="a00005.html#59e8524de65dd2f4d6a3c01b429e12da">TC_NO_TRIGGER_COMPARE_RC</a>,     <span class="comment">// RC compare trigger enable.</span>
<a name="l00124"></a>00124     .abetrg   = <a class="code" href="a00005.html#bf85f69a9af0bbf0ae11497ecd6d9ac4">TC_EXT_TRIG_SEL_TIOA</a>,         <span class="comment">// TIOA or TIOB external trigger selection.</span>
<a name="l00125"></a>00125     .etrgedg  = <a class="code" href="a00005.html#17a81d6ac9326847007bc5336a93a677">TC_SEL_FALLING_EDGE</a>,          <span class="comment">// External trigger edge selection.</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     .ldbdis   = FALSE,                        <span class="comment">// Counter clock disable with RB loading.</span>
<a name="l00128"></a>00128     .ldbstop  = FALSE,                        <span class="comment">// Counter clock stopped with RB loading.</span>
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     .burst    = <a class="code" href="a00005.html#b1443daf817c1547cd8b65ece0d424c6">TC_BURST_NOT_GATED</a>,           <span class="comment">// Burst signal selection.</span>
<a name="l00131"></a>00131     .clki     = <a class="code" href="a00005.html#1cb24106c1d531e6d663a5341743f56f">TC_CLOCK_RISING_EDGE</a>,         <span class="comment">// Clock inversion.</span>
<a name="l00132"></a>00132     .tcclks   = <a class="code" href="a00005.html#f0d39eba1cb5ed0c836cf9f82e923b1e">TC_CLOCK_SOURCE_TC5</a>           <span class="comment">// Internal source clock 5  - connected to PBA/32</span>
<a name="l00133"></a>00133   };
<a name="l00134"></a>00134 
<a name="l00135"></a>00135   <span class="comment">// Initialize the timer/counter capture.</span>
<a name="l00136"></a>00136   <a class="code" href="a00004.html#7f7de7c088e7f22f5bef00c568d6dcd5">tc_init_capture</a>(tc, &amp;capture_opt);
<a name="l00137"></a>00137 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b7dc76c0a7bf55d48864c1ec906834de"></a><!-- doxytag: member="tc_example2.c::init_tc_output" ref="b7dc76c0a7bf55d48864c1ec906834de" args="(volatile avr32_tc_t *tc, unsigned int channel)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void init_tc_output           </td>
          <td>(</td>
          <td class="paramtype">volatile avr32_tc_t *&nbsp;</td>
          <td class="paramname"> <em>tc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>channel</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initializes the timer/counter waveform. 
<p>

<p>
Definition at line <a class="el" href="a00009.html#l00142">142</a> of file <a class="el" href="a00009.html">tc_example2.c</a>.
<p>
References <a class="el" href="a00008.html#l00137">TC_BURST_NOT_GATED</a>, <a class="el" href="a00008.html#l00146">TC_CLOCK_RISING_EDGE</a>, <a class="el" href="a00008.html#l00156">TC_CLOCK_SOURCE_TC4</a>, <a class="el" href="a00008.html#l00089">TC_EVT_EFFECT_CLEAR</a>, <a class="el" href="a00008.html#l00087">TC_EVT_EFFECT_NOOP</a>, <a class="el" href="a00008.html#l00088">TC_EVT_EFFECT_SET</a>, <a class="el" href="a00008.html#l00119">TC_EXT_EVENT_SEL_TIOB_INPUT</a>, <a class="el" href="a00007.html#l00127">tc_init_waveform()</a>, <a class="el" href="a00008.html#l00128">TC_SEL_NO_EDGE</a>, and <a class="el" href="a00008.html#l00103">TC_WAVEFORM_SEL_UP_MODE</a>.
<p>
Referenced by <a class="el" href="a00009.html#l00178">main()</a>.<div class="fragment"><pre class="fragment"><a name="l00143"></a>00143 {
<a name="l00144"></a>00144   <span class="comment">// Options for waveform generation.</span>
<a name="l00145"></a>00145   <a class="code" href="a00003.html">tc_waveform_opt_t</a> waveform_opt =
<a name="l00146"></a>00146   {
<a name="l00147"></a>00147     .channel  = channel,                      <span class="comment">// Channel selection.</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     .bswtrg   = <a class="code" href="a00005.html#9ac4003ce73061727d1fbc0954bdf47b">TC_EVT_EFFECT_NOOP</a>,           <span class="comment">// Software trigger effect on TIOB.</span>
<a name="l00150"></a>00150     .beevt    = <a class="code" href="a00005.html#9ac4003ce73061727d1fbc0954bdf47b">TC_EVT_EFFECT_NOOP</a>,           <span class="comment">// External event effect on TIOB.</span>
<a name="l00151"></a>00151     .bcpc     = <a class="code" href="a00005.html#9ac4003ce73061727d1fbc0954bdf47b">TC_EVT_EFFECT_NOOP</a>,           <span class="comment">// RC compare effect on TIOB.</span>
<a name="l00152"></a>00152     .bcpb     = <a class="code" href="a00005.html#9ac4003ce73061727d1fbc0954bdf47b">TC_EVT_EFFECT_NOOP</a>,           <span class="comment">// RB compare effect on TIOB.</span>
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     .aswtrg   = <a class="code" href="a00005.html#9ac4003ce73061727d1fbc0954bdf47b">TC_EVT_EFFECT_NOOP</a>,           <span class="comment">// Software trigger effect on TIOA.</span>
<a name="l00155"></a>00155     .aeevt    = <a class="code" href="a00005.html#9ac4003ce73061727d1fbc0954bdf47b">TC_EVT_EFFECT_NOOP</a>,           <span class="comment">// External event effect on TIOA.</span>
<a name="l00156"></a>00156     .acpc     = <a class="code" href="a00005.html#e62d917b399192d509c41bef013deb09">TC_EVT_EFFECT_SET</a>,            <span class="comment">// RC compare effect on TIOA.</span>
<a name="l00157"></a>00157     .acpa     = <a class="code" href="a00005.html#5db380f2d6fe34394ee3070ab9456287">TC_EVT_EFFECT_CLEAR</a>,          <span class="comment">// RA compare effect on TIOA.</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     .wavsel   = <a class="code" href="a00005.html#2983d578ac021da2eb2a1f1abd5ffc23">TC_WAVEFORM_SEL_UP_MODE</a>,      <span class="comment">// Waveform selection: Up mode without automatic trigger on RC compare.</span>
<a name="l00160"></a>00160     .enetrg   = FALSE,                        <span class="comment">// External event trigger enable.</span>
<a name="l00161"></a>00161     .eevt     = <a class="code" href="a00005.html#65c60b291295f6a62d0e6f7d4118a7ca">TC_EXT_EVENT_SEL_TIOB_INPUT</a>,  <span class="comment">// External event selection.</span>
<a name="l00162"></a>00162     .eevtedg  = <a class="code" href="a00005.html#70b6c234a55fa7723831fe80f635a0f8">TC_SEL_NO_EDGE</a>,               <span class="comment">// External event edge selection.</span>
<a name="l00163"></a>00163     .cpcdis   = FALSE,                        <span class="comment">// Counter disable when RC compare.</span>
<a name="l00164"></a>00164     .cpcstop  = FALSE,                        <span class="comment">// Counter clock stopped with RC compare.</span>
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     .burst    = <a class="code" href="a00005.html#b1443daf817c1547cd8b65ece0d424c6">TC_BURST_NOT_GATED</a>,           <span class="comment">// Burst signal selection.</span>
<a name="l00167"></a>00167     .clki     = <a class="code" href="a00005.html#1cb24106c1d531e6d663a5341743f56f">TC_CLOCK_RISING_EDGE</a>,         <span class="comment">// Clock inversion.</span>
<a name="l00168"></a>00168     .tcclks   = <a class="code" href="a00005.html#95b9ccfbb8910496a24bef405ea59c2c">TC_CLOCK_SOURCE_TC4</a>           <span class="comment">// Internal source clock 4 -  - connected to PBA/16</span>
<a name="l00169"></a>00169   };
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   <span class="comment">// Initialize the timer/counter waveform.</span>
<a name="l00172"></a>00172   <a class="code" href="a00004.html#e2afd26bf53af1e04f58a2027fc39166">tc_init_waveform</a>(tc, &amp;waveform_opt);
<a name="l00173"></a>00173 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="840291bc02cba5474a4cb46a9b9566fe"></a><!-- doxytag: member="tc_example2.c::main" ref="840291bc02cba5474a4cb46a9b9566fe" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Main function. Execution starts here. 
<p>

<p>
Definition at line <a class="el" href="a00009.html#l00178">178</a> of file <a class="el" href="a00009.html">tc_example2.c</a>.
<p>
References <a class="el" href="a00009.html#l00113">init_tc_input()</a>, <a class="el" href="a00009.html#l00142">init_tc_output()</a>, <a class="el" href="a00007.html#l00223">tc_read_ra()</a>, <a class="el" href="a00007.html#l00157">tc_start()</a>, and <a class="el" href="a00007.html#l00253">tc_write_ra()</a>.<div class="fragment"><pre class="fragment"><a name="l00179"></a>00179 {
<a name="l00180"></a>00180   <span class="keyword">static</span> <span class="keyword">const</span> gpio_map_t TC_GPIO_MAP =
<a name="l00181"></a>00181   {
<a name="l00182"></a>00182     <span class="comment">// Assign I/O to timer/counter TIOA1 pin function (input):</span>
<a name="l00183"></a>00183     <span class="comment">// optional as far as the port pin is not driven by the MCU.</span>
<a name="l00184"></a>00184     {AVR32_TC_A1_0_PIN, AVR32_TC_A1_0_FUNCTION},
<a name="l00185"></a>00185     <span class="comment">// On the AT32UC3A0512, the input pin TIOA1 is mapped on PB25.</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="comment">// Assign I/O to timer/counter TIOA0 pin function (output).</span>
<a name="l00188"></a>00188     {AVR32_TC_A0_0_PIN, AVR32_TC_A0_0_FUNCTION}
<a name="l00189"></a>00189     <span class="comment">// On the AT32UC3A0512, the output pin TIOA0 is mapped on PB23.</span>
<a name="l00190"></a>00190   };
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <span class="comment">// The timer/counter instance and channel numbers are used in several functions.</span>
<a name="l00193"></a>00193   <span class="comment">// It's defined as local variable for ease-of-use causes and readability.</span>
<a name="l00194"></a>00194   <span class="keyword">volatile</span> avr32_tc_t *tc = &amp;AVR32_TC;
<a name="l00195"></a>00195   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> input_channel = 1;
<a name="l00196"></a>00196   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> output_channel = 0;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   <span class="comment">// Used to read the RA value for the input timer/counter instance.</span>
<a name="l00199"></a>00199   <span class="keywordtype">int</span> ra = 0;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201   <span class="comment">// Switch main clock to external oscillator 0 (crystal).</span>
<a name="l00202"></a>00202   pm_switch_to_osc0(&amp;AVR32_PM, FOSC0, OSC0_STARTUP);
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   <span class="comment">// Assign I/Os to timer/counter.</span>
<a name="l00205"></a>00205   gpio_enable_module(TC_GPIO_MAP, <span class="keyword">sizeof</span>(TC_GPIO_MAP) / <span class="keyword">sizeof</span>(TC_GPIO_MAP[0]));
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="comment">// Initialize the timers/counters.</span>
<a name="l00208"></a>00208   <a class="code" href="a00006.html#3cae1237ec68bcc74789e36ecb33d722">init_tc_input</a>(tc, input_channel);
<a name="l00209"></a>00209   <a class="code" href="a00006.html#b7dc76c0a7bf55d48864c1ec906834de">init_tc_output</a>(tc, output_channel);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211   <span class="comment">// Set the compare trigger.</span>
<a name="l00212"></a>00212   <a class="code" href="a00004.html#529c79daae84704176fcf99b6d7a0992">tc_write_ra</a>(tc, output_channel, 0x2000);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="comment">// Start the timers/counters.</span>
<a name="l00215"></a>00215   <a class="code" href="a00004.html#6f96b37061410b0f2241588f7c77d45a">tc_start</a>(tc, input_channel);
<a name="l00216"></a>00216   <a class="code" href="a00004.html#6f96b37061410b0f2241588f7c77d45a">tc_start</a>(tc, output_channel);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="keywordflow">while</span> (TRUE)
<a name="l00219"></a>00219   {
<a name="l00220"></a>00220     ra = <a class="code" href="a00004.html#7a6f1b188ba606cab3f84aeacef7ee88">tc_read_ra</a>(tc, input_channel);
<a name="l00221"></a>00221     <span class="keywordflow">if</span> (ra &gt; 0)
<a name="l00222"></a>00222     {
<a name="l00223"></a>00223       <span class="comment">// RA of the input channel has changed, so it has detected a falling edge.</span>
<a name="l00224"></a>00224       <span class="comment">// Update the RA of the output channel.</span>
<a name="l00225"></a>00225       <a class="code" href="a00004.html#529c79daae84704176fcf99b6d7a0992">tc_write_ra</a>(tc, output_channel, ra);
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227   }
<a name="l00228"></a>00228 }
</pre></div>
<p>

</div>
</div><p>
<hr size="1"><address style="align: right;"><small>Generated on Thu Sep 20 12:16:51 2007 for AVR32 UC3 - TC Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>
