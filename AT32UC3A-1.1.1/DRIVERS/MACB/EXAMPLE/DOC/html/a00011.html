<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>AVR32 - MACB Driver: macb_example.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>macb_example.c</h1><a href="a00007.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="preprocessor">#include &lt;avr32/io.h&gt;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include "print_funcs.h"</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include "usart.h"</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include "board.h"</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include "<a class="code" href="a00006.html">macb.h</a>"</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include "gpio.h"</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include "compiler.h"</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include "<a class="code" href="a00004.html">conf_eth.h</a>"</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include "flashc.h"</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include "pm.h"</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include "intc.h"</span>
<a name="l00093"></a>00093 
<a name="l00095"></a><a class="code" href="a00007.html#15255f153c27d5d061fba4e2e15be27b">00095</a> <span class="preprocessor">#define SEQ_NUM_START 0x2546</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="a00007.html#a19045b9c0823bb8273eda6b8460538f">00098</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="a00007.html#a19045b9c0823bb8273eda6b8460538f">seqnum</a> = <a class="code" href="a00007.html#15255f153c27d5d061fba4e2e15be27b">SEQ_NUM_START</a>;
<a name="l00099"></a>00099 
<a name="l00101"></a><a class="code" href="a00007.html#fcce98df54739c1f56865982abb040da">00101</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="a00007.html#fcce98df54739c1f56865982abb040da">local_ipaddr</a>[4] = {<a class="code" href="a00004.html#888c9a4892da2161eb48b30703913884">ETHERNET_CONF_IPADDR0</a>,<a class="code" href="a00004.html#a96fe1aaa7d36db2a9126b0ab2b87711">ETHERNET_CONF_IPADDR1</a>,<a class="code" href="a00004.html#50b872ac980780198745fb87ecdec793">ETHERNET_CONF_IPADDR2</a>,<a class="code" href="a00004.html#82f5ca9e78fca7199474378fbd3c1585">ETHERNET_CONF_IPADDR3</a>};
<a name="l00102"></a>00102 
<a name="l00104"></a><a class="code" href="a00007.html#fbb45e213a80239af122d54826472eca">00104</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="a00007.html#fbb45e213a80239af122d54826472eca">ARP_FRAME</a>[42] = {
<a name="l00105"></a>00105 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
<a name="l00106"></a>00106 <a class="code" href="a00004.html#baddce1004acb7dfb06c4cc551d38370">ETHERNET_CONF_ETHADDR0</a>,<a class="code" href="a00004.html#6586583f19701a4d523c926869366dbc">ETHERNET_CONF_ETHADDR1</a>,<a class="code" href="a00004.html#78e1caad0dc34cacf99e2e62957d8155">ETHERNET_CONF_ETHADDR2</a>,<a class="code" href="a00004.html#2038e8417534ca46c118763baaef8184">ETHERNET_CONF_ETHADDR3</a>,<a class="code" href="a00004.html#0c2d9e6c42334849306be108b7439435">ETHERNET_CONF_ETHADDR4</a>,<a class="code" href="a00004.html#6dac933e5a2d16b470da7396dd29c510">ETHERNET_CONF_ETHADDR5</a>,
<a name="l00107"></a>00107 0x08,0x06,0x00,0x01,0x08,0x00,0x06,0x04,0x00,0x01,
<a name="l00108"></a>00108 <a class="code" href="a00004.html#baddce1004acb7dfb06c4cc551d38370">ETHERNET_CONF_ETHADDR0</a>,ETHERNET_CONF_ETHADDR1,ETHERNET_CONF_ETHADDR2,ETHERNET_CONF_ETHADDR3,ETHERNET_CONF_ETHADDR4,ETHERNET_CONF_ETHADDR5,
<a name="l00109"></a>00109 <a class="code" href="a00004.html#888c9a4892da2161eb48b30703913884">ETHERNET_CONF_IPADDR0</a>,<a class="code" href="a00004.html#a96fe1aaa7d36db2a9126b0ab2b87711">ETHERNET_CONF_IPADDR1</a>,<a class="code" href="a00004.html#50b872ac980780198745fb87ecdec793">ETHERNET_CONF_IPADDR2</a>,<a class="code" href="a00004.html#82f5ca9e78fca7199474378fbd3c1585">ETHERNET_CONF_IPADDR3</a>,
<a name="l00110"></a>00110 0x00,0x00,0x00,0x00,0x00,0x00,
<a name="l00111"></a>00111 <a class="code" href="a00004.html#9f010b41aa3833ee766d5da6236fb627">ETHERNET_CONF_GATEWAY_ADDR0</a>,<a class="code" href="a00004.html#795cf51102463321a2bd92b7cc73f6ba">ETHERNET_CONF_GATEWAY_ADDR1</a>,<a class="code" href="a00004.html#523e8ecb8ab1717831a11e39518f995f">ETHERNET_CONF_GATEWAY_ADDR2</a>,<a class="code" href="a00004.html#9d21e3a99d994903cff06f29a718ebf4">ETHERNET_CONF_GATEWAY_ADDR3</a>
<a name="l00112"></a>00112 };
<a name="l00113"></a>00113                            
<a name="l00115"></a><a class="code" href="a00007.html#c24b8dbe47757bf3dd3679b87acdda80">00115</a> <span class="keywordtype">char</span> <a class="code" href="a00007.html#c24b8dbe47757bf3dd3679b87acdda80">data</a>[<a class="code" href="a00004.html#8b1ddb8402abef501c15c0517dbde60d">ETHERNET_CONF_TX_BUFFER_SIZE</a>];
<a name="l00116"></a>00116 <span class="comment">/* The IP and Ethernet addresses are read from the header files. */</span>
<a name="l00117"></a><a class="code" href="a00007.html#0d0b70fd57855674015607bac314e932">00117</a> <span class="keywordtype">char</span> <a class="code" href="a00007.html#0d0b70fd57855674015607bac314e932">hwaddr</a>[ 6 ] = { <a class="code" href="a00004.html#baddce1004acb7dfb06c4cc551d38370">ETHERNET_CONF_ETHADDR0</a>,<a class="code" href="a00004.html#6586583f19701a4d523c926869366dbc">ETHERNET_CONF_ETHADDR1</a>,<a class="code" href="a00004.html#78e1caad0dc34cacf99e2e62957d8155">ETHERNET_CONF_ETHADDR2</a>,<a class="code" href="a00004.html#2038e8417534ca46c118763baaef8184">ETHERNET_CONF_ETHADDR3</a>,<a class="code" href="a00004.html#0c2d9e6c42334849306be108b7439435">ETHERNET_CONF_ETHADDR4</a>,<a class="code" href="a00004.html#6dac933e5a2d16b470da7396dd29c510">ETHERNET_CONF_ETHADDR5</a> };
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 
<a name="l00128"></a><a class="code" href="a00007.html#5e4cd95c89adfdd7e4bdad48b0b7aa9f">00128</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="a00007.html#5e4cd95c89adfdd7e4bdad48b0b7aa9f">in_cksum</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> * addr, <span class="keywordtype">int</span> len)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130 <span class="keywordtype">int</span> nleft, sum;
<a name="l00131"></a>00131 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *w;
<a name="l00132"></a>00132 <span class="keyword">union </span>{
<a name="l00133"></a>00133   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> us;
<a name="l00134"></a>00134   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  uc[2];
<a name="l00135"></a>00135 } last;
<a name="l00136"></a>00136 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> answer;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138   nleft = len;
<a name="l00139"></a>00139   sum = 0;
<a name="l00140"></a>00140   w = addr;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="comment">/*</span>
<a name="l00143"></a>00143 <span class="comment">   * Algorithm is simple, using a 32 bit accumulator (sum) :</span>
<a name="l00144"></a>00144 <span class="comment">   * add sequential 16 bit words to it, and at the end, fold back all the</span>
<a name="l00145"></a>00145 <span class="comment">   * carry bits from the top 16 bits into the lower 16 bits.</span>
<a name="l00146"></a>00146 <span class="comment">   */</span>
<a name="l00147"></a>00147   <span class="keywordflow">while</span> (nleft &gt; 1)
<a name="l00148"></a>00148   {
<a name="l00149"></a>00149     sum += *w++;
<a name="l00150"></a>00150     nleft -= 2;
<a name="l00151"></a>00151   }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153   <span class="comment">// mop up an odd byte, if necessary</span>
<a name="l00154"></a>00154   <span class="keywordflow">if</span> (nleft == 1)
<a name="l00155"></a>00155   {
<a name="l00156"></a>00156     last.uc[0] = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)w;
<a name="l00157"></a>00157     last.uc[1] = 0;
<a name="l00158"></a>00158     sum += last.us;
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="comment">// add back carry outs from top 16 bits to low 16 bits</span>
<a name="l00162"></a>00162   sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff);     <span class="comment">// add hi 16 to low 16</span>
<a name="l00163"></a>00163   sum += (sum &gt;&gt; 16);                     <span class="comment">// add carry</span>
<a name="l00164"></a>00164   answer = ~sum;                          <span class="comment">// truncate to 16 bits</span>
<a name="l00165"></a>00165   <span class="keywordflow">return</span>(answer);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00173"></a><a class="code" href="a00007.html#770a8dc4d882dc8c06517fa1ff8d61f0">00173</a> <span class="keywordtype">void</span> <a class="code" href="a00007.html#770a8dc4d882dc8c06517fa1ff8d61f0">macb_example_send_ping_response</a>(<a class="code" href="a00003.html">macb_packet_t</a> * pkt)
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175 <span class="keywordtype">char</span> ipaddr[4];
<a name="l00176"></a>00176 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> chksum;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <span class="comment">// swap sender &amp; receiver HW address</span>
<a name="l00179"></a>00179   memmove(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+6, 6);
<a name="l00180"></a>00180   memcpy(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+6, <a class="code" href="a00007.html#0d0b70fd57855674015607bac314e932">hwaddr</a>, 6);
<a name="l00181"></a>00181   <span class="comment">// swap sender &amp; receiver IP address</span>
<a name="l00182"></a>00182   memcpy(ipaddr, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+26, 4);
<a name="l00183"></a>00183   memmove(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+26, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+30, 4);
<a name="l00184"></a>00184   memcpy(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+30, ipaddr, 4);
<a name="l00185"></a>00185   <span class="comment">// set seq num</span>
<a name="l00186"></a>00186   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[18] = MSB(<a class="code" href="a00007.html#a19045b9c0823bb8273eda6b8460538f">seqnum</a>);
<a name="l00187"></a>00187   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[19] = LSB(<a class="code" href="a00007.html#a19045b9c0823bb8273eda6b8460538f">seqnum</a>);
<a name="l00188"></a>00188   <span class="keywordflow">if</span> (++<a class="code" href="a00007.html#a19045b9c0823bb8273eda6b8460538f">seqnum</a> &gt;= 0xFF00) <a class="code" href="a00007.html#a19045b9c0823bb8273eda6b8460538f">seqnum</a> = <a class="code" href="a00007.html#15255f153c27d5d061fba4e2e15be27b">SEQ_NUM_START</a>;
<a name="l00189"></a>00189   <span class="comment">// reset checksum before computation</span>
<a name="l00190"></a>00190   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[24] = 0;
<a name="l00191"></a>00191   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[25] = 0;
<a name="l00192"></a>00192   <span class="comment">// compute IP checksum</span>
<a name="l00193"></a>00193   chksum = <a class="code" href="a00007.html#5e4cd95c89adfdd7e4bdad48b0b7aa9f">in_cksum</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[14], 20);
<a name="l00194"></a>00194   <span class="comment">// set IP checksum</span>
<a name="l00195"></a>00195   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[24] = MSB(chksum);
<a name="l00196"></a>00196   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[25] = LSB(chksum);
<a name="l00197"></a>00197   <span class="comment">// set reply bit</span>
<a name="l00198"></a>00198   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[34] = 0;
<a name="l00199"></a>00199   <span class="comment">// reset checksum before computation</span>
<a name="l00200"></a>00200   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[36] = 0;
<a name="l00201"></a>00201   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[37] = 0;
<a name="l00202"></a>00202   <span class="comment">// compute ICMP checksum</span>
<a name="l00203"></a>00203   chksum = <a class="code" href="a00007.html#5e4cd95c89adfdd7e4bdad48b0b7aa9f">in_cksum</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)&amp;pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[34], (pkt-&gt;<a class="code" href="a00003.html#ee05700dfd8162650acbb5e7f144e7e5">len</a> - 34));
<a name="l00204"></a>00204   <span class="comment">// set ICMP checksum</span>
<a name="l00205"></a>00205   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[36] = MSB(chksum);
<a name="l00206"></a>00206   pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[37] = LSB(chksum);
<a name="l00207"></a>00207   <span class="comment">// send request, nothing else to send</span>
<a name="l00208"></a>00208   <a class="code" href="a00005.html#a175adc5adb27c4a00feefb6c935ecc8">lMACBSend</a>(&amp;AVR32_MACB, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>, pkt-&gt;<a class="code" href="a00003.html#ee05700dfd8162650acbb5e7f144e7e5">len</a>, TRUE);
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00215"></a><a class="code" href="a00007.html#54cb65560f336243d94e84f26dddfd0f">00215</a> <span class="keywordtype">void</span> <a class="code" href="a00007.html#54cb65560f336243d94e84f26dddfd0f">macb_example_receive_packet</a>(<a class="code" href="a00003.html">macb_packet_t</a> *pkt)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217   <span class="keywordtype">char</span> ipaddr[4];
<a name="l00218"></a>00218 
<a name="l00219"></a>00219   <span class="comment">// if it is a ARP frame, answer it</span>
<a name="l00220"></a>00220   <span class="keywordflow">if</span> ((pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[12] == 0x08) &amp;&amp; (pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[13] == 0x06))
<a name="l00221"></a>00221   {
<a name="l00222"></a>00222     <span class="comment">// ARP request</span>
<a name="l00223"></a>00223     <span class="keywordflow">if</span> ((pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[20] == 0x00) &amp;&amp; (pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[21] == 0x01))
<a name="l00224"></a>00224     {
<a name="l00225"></a>00225       print_dbg(<span class="stringliteral">"ARP Request received...\r\n"</span>);
<a name="l00226"></a>00226       <span class="comment">// swap sender &amp; receiver address</span>
<a name="l00227"></a>00227       memmove(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+6, 6);
<a name="l00228"></a>00228       memcpy(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+6, <a class="code" href="a00007.html#0d0b70fd57855674015607bac314e932">hwaddr</a>, 6);
<a name="l00229"></a>00229       <span class="comment">// ARP Response</span>
<a name="l00230"></a>00230       pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[21] = 0x02;
<a name="l00231"></a>00231       <span class="comment">// swap sender &amp; receiver parameters</span>
<a name="l00232"></a>00232       memcpy(ipaddr, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+38, 4);
<a name="l00233"></a>00233       memmove(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+32, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+22, 10);
<a name="l00234"></a>00234       memcpy(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+22, <a class="code" href="a00007.html#0d0b70fd57855674015607bac314e932">hwaddr</a>, 6);
<a name="l00235"></a>00235       memcpy(pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>+28, ipaddr, 4);
<a name="l00236"></a>00236       <span class="comment">// send response, nothing else to send</span>
<a name="l00237"></a>00237       <a class="code" href="a00005.html#a175adc5adb27c4a00feefb6c935ecc8">lMACBSend</a>(&amp;AVR32_MACB, pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>, pkt-&gt;<a class="code" href="a00003.html#ee05700dfd8162650acbb5e7f144e7e5">len</a>, TRUE);
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239     <span class="comment">// ARP response</span>
<a name="l00240"></a>00240     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[20] == 0x00) &amp;&amp; (pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[21] == 0x02))
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242       print_dbg(<span class="stringliteral">"ARP Response received...\r\n"</span>);
<a name="l00243"></a>00243     }    
<a name="l00244"></a>00244     <span class="comment">// unknown frame, loop it back</span>
<a name="l00245"></a>00245     <span class="keywordflow">else</span>
<a name="l00246"></a>00246     {
<a name="l00247"></a>00247       print_dbg(<span class="stringliteral">"Unimplemented ARP packet...\r\n"</span>);
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249   }
<a name="l00250"></a>00250   <span class="comment">// ICMP protocol</span>
<a name="l00251"></a>00251   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[23] == 0x01)
<a name="l00252"></a>00252   {
<a name="l00253"></a>00253     <span class="comment">// if it is our IP address</span>
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (!memcmp(&amp;pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[30], <a class="code" href="a00007.html#fcce98df54739c1f56865982abb040da">local_ipaddr</a>, 4))
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256       <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>[34] == 0x08) <span class="comment">// PING Request</span>
<a name="l00257"></a>00257       {
<a name="l00258"></a>00258         print_dbg(<span class="stringliteral">"PING Request received...\r\n"</span>);
<a name="l00259"></a>00259         <a class="code" href="a00007.html#770a8dc4d882dc8c06517fa1ff8d61f0">macb_example_send_ping_response</a>(pkt);   
<a name="l00260"></a>00260       }
<a name="l00261"></a>00261       <span class="keywordflow">else</span>
<a name="l00262"></a>00262       {
<a name="l00263"></a>00263         print_dbg(<span class="stringliteral">"Unimplemented ICMP packet...\r\n"</span>);
<a name="l00264"></a>00264       }
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266   }
<a name="l00267"></a>00267   <span class="keywordflow">else</span>
<a name="l00268"></a>00268   {
<a name="l00269"></a>00269     print_dbg(<span class="stringliteral">"Unknown packet...\r\n"</span>);
<a name="l00270"></a>00270   }
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00276"></a><a class="code" href="a00007.html#0ee6c441ecc2b7d058c4045a9c468cb4">00276</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="a00007.html#0ee6c441ecc2b7d058c4045a9c468cb4">macb_example_send_ARP_request</a>(<span class="keywordtype">void</span>)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278 <a class="code" href="a00003.html">macb_packet_t</a> request_pkt;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   request_pkt.<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a> = <a class="code" href="a00007.html#c24b8dbe47757bf3dd3679b87acdda80">data</a>;
<a name="l00281"></a>00281   <span class="comment">// Prepare ARP frame for host</span>
<a name="l00282"></a>00282   memcpy(request_pkt.<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>, <a class="code" href="a00007.html#fbb45e213a80239af122d54826472eca">ARP_FRAME</a>, 42);
<a name="l00283"></a>00283   request_pkt.<a class="code" href="a00003.html#ee05700dfd8162650acbb5e7f144e7e5">len</a> = 42;
<a name="l00284"></a>00284 <span class="preprocessor">#if CONF_MACB_VERBOSE</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span>  print_dbg(<span class="stringliteral">"Sending ARP Request...\r\n"</span>);
<a name="l00286"></a>00286 <span class="preprocessor">#endif</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>  <span class="comment">// send response, nothing else to send</span>
<a name="l00288"></a>00288   <a class="code" href="a00005.html#a175adc5adb27c4a00feefb6c935ecc8">lMACBSend</a>(&amp;AVR32_MACB, request_pkt.<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a>, request_pkt.<a class="code" href="a00003.html#ee05700dfd8162650acbb5e7f144e7e5">len</a>, TRUE);  
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00294"></a><a class="code" href="a00007.html#467c2991c3503d70686a24871ad9757e">00294</a> <span class="keywordtype">void</span> <a class="code" href="a00007.html#467c2991c3503d70686a24871ad9757e">local_start_pll</a>(<span class="keywordtype">void</span>)
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296 <span class="keyword">volatile</span> avr32_pm_t* pm = &amp;AVR32_PM;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   <span class="comment">// Switch the main clock to OSC0</span>
<a name="l00299"></a>00299   pm_switch_to_osc0(pm, FOSC0, OSC0_STARTUP);
<a name="l00300"></a>00300   <span class="comment">// Setup PLL0 on OSC0, mul=15 ,no divisor, lockcount=16, ie. 12Mhzx16 = 192MHz output</span>
<a name="l00301"></a>00301   pm_pll_setup(pm,  <span class="comment">// volatile avr32_pm_t* pm</span>
<a name="l00302"></a>00302                0,   <span class="comment">// unsigned int pll</span>
<a name="l00303"></a>00303                15,   <span class="comment">// unsigned int mul</span>
<a name="l00304"></a>00304                1,   <span class="comment">// unsigned int div, Sel Osc0/PLL0 or Osc1/Pll1</span>
<a name="l00305"></a>00305                0,   <span class="comment">// unsigned int osc</span>
<a name="l00306"></a>00306                16); <span class="comment">// unsigned int lockcount</span>
<a name="l00307"></a>00307   <span class="comment">// set PLL options to run @ 96 Mhz</span>
<a name="l00308"></a>00308   pm_pll_set_option(pm, <span class="comment">// volatile avr32_pm_t *pm</span>
<a name="l00309"></a>00309                     0,  <span class="comment">// unsigned int pll</span>
<a name="l00310"></a>00310                     0,  <span class="comment">// unsigned int  pll_freq</span>
<a name="l00311"></a>00311                     1,  <span class="comment">// unsigned int  pll_div2</span>
<a name="l00312"></a>00312                     0); <span class="comment">// unsigned int  pll_wbwdisable</span>
<a name="l00313"></a>00313   <span class="comment">// Enable PLL0</span>
<a name="l00314"></a>00314   pm_pll_enable(pm,0);
<a name="l00315"></a>00315   <span class="comment">// Wait for PLL0 locked</span>
<a name="l00316"></a>00316   pm_wait_for_pll0_locked(pm) ;
<a name="l00317"></a>00317   <span class="comment">// Setup generic clock number 0 on PLL, with OSC0/PLL0, no divisor</span>
<a name="l00318"></a>00318   pm_gc_setup(pm,
<a name="l00319"></a>00319               0,
<a name="l00320"></a>00320               1, <span class="comment">// Use Osc (=0) or PLL (=1)</span>
<a name="l00321"></a>00321               0, <span class="comment">// Sel Osc0/PLL0 or Osc1/Pll1</span>
<a name="l00322"></a>00322               0,
<a name="l00323"></a>00323               0);
<a name="l00324"></a>00324   <span class="comment">// Enable Generic clock 0*/</span>
<a name="l00325"></a>00325   pm_gc_enable(pm, 0);
<a name="l00326"></a>00326   <span class="comment">// set divider to 8 for PBA bus and 2 for PBB</span>
<a name="l00327"></a>00327   pm_cksel(pm,1,2,1,0,1,0);
<a name="l00328"></a>00328   <span class="comment">// one wait state at 48 Mhz</span>
<a name="l00329"></a>00329   flashc_set_wait_state(1);
<a name="l00330"></a>00330   <span class="comment">/* Output the clock to a gpio(PA7) */</span>
<a name="l00331"></a>00331   gpio_enable_module_pin(AVR32_PM_GCLK_0_0_PIN, AVR32_PM_GCLK_0_0_FUNCTION);
<a name="l00332"></a>00332   <span class="comment">// switch to clock</span>
<a name="l00333"></a>00333   pm_switch_to_clock(pm, AVR32_PM_MCCTRL_MCSEL_PLL0);
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00339"></a><a class="code" href="a00007.html#3c04138a5bfe5d72780bb7e82a18e627">00339</a> <span class="keywordtype">int</span> <a class="code" href="a00007.html#3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len, i = 0;
<a name="l00342"></a>00342 <a class="code" href="a00003.html">macb_packet_t</a> recvd_pkt;
<a name="l00343"></a>00343 <span class="keyword">static</span> <span class="keyword">const</span> gpio_map_t MACB_GPIO_MAP =
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345   {AVR32_MACB_MDC_0_PIN,    AVR32_MACB_MDC_0_FUNCTION   },
<a name="l00346"></a>00346   {AVR32_MACB_MDIO_0_PIN,   AVR32_MACB_MDIO_0_FUNCTION  },
<a name="l00347"></a>00347   {AVR32_MACB_RXD_0_PIN,    AVR32_MACB_RXD_0_FUNCTION   },
<a name="l00348"></a>00348   {AVR32_MACB_TXD_0_PIN,    AVR32_MACB_TXD_0_FUNCTION   },
<a name="l00349"></a>00349   {AVR32_MACB_RXD_1_PIN,    AVR32_MACB_RXD_1_FUNCTION   },
<a name="l00350"></a>00350   {AVR32_MACB_TXD_1_PIN,    AVR32_MACB_TXD_1_FUNCTION   },
<a name="l00351"></a>00351   {AVR32_MACB_TX_EN_0_PIN,  AVR32_MACB_TX_EN_0_FUNCTION },
<a name="l00352"></a>00352   {AVR32_MACB_RX_ER_0_PIN,  AVR32_MACB_RX_ER_0_FUNCTION },
<a name="l00353"></a>00353   {AVR32_MACB_RX_DV_0_PIN,  AVR32_MACB_RX_DV_0_FUNCTION },
<a name="l00354"></a>00354   {AVR32_MACB_TX_CLK_0_PIN, AVR32_MACB_TX_CLK_0_FUNCTION}
<a name="l00355"></a>00355 };
<a name="l00356"></a>00356 
<a name="l00357"></a>00357   <span class="comment">// start a PLL</span>
<a name="l00358"></a>00358   <a class="code" href="a00007.html#467c2991c3503d70686a24871ad9757e">local_start_pll</a>();
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="comment">// init the system interrupts</span>
<a name="l00361"></a>00361   INTC_init_interrupts();
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   <span class="comment">// init debug serial line</span>
<a name="l00364"></a>00364   init_dbg_rs232(FOSC0);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   <span class="comment">// display welcome</span>
<a name="l00367"></a>00367   print_dbg(<span class="stringliteral">"\x1B[2J\x1B[H\r\n MACB Example\r\n"</span>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="comment">// Assign GPIO to MACB</span>
<a name="l00370"></a>00370   gpio_enable_module(MACB_GPIO_MAP, <span class="keyword">sizeof</span>(MACB_GPIO_MAP) / <span class="keyword">sizeof</span>(MACB_GPIO_MAP[0]));
<a name="l00371"></a>00371 
<a name="l00372"></a>00372   <span class="comment">// initialize MACB &amp; Phy Layers</span>
<a name="l00373"></a>00373   <span class="keywordflow">if</span> (<a class="code" href="a00005.html#f84c12942936a4771e62b7503bc6a887">xMACBInit</a>(&amp;AVR32_MACB) == FALSE )
<a name="l00374"></a>00374   {
<a name="l00375"></a>00375     gpio_clr_gpio_pin(LED4_GPIO);
<a name="l00376"></a>00376     <span class="keywordflow">while</span>(1);   
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378   
<a name="l00379"></a>00379   gpio_clr_gpio_pin(LED5_GPIO);
<a name="l00380"></a>00380  
<a name="l00381"></a>00381   <span class="comment">// do a loop, and display stats or quit</span>
<a name="l00382"></a>00382   <span class="keywordflow">while</span> (1)
<a name="l00383"></a>00383   {
<a name="l00384"></a>00384     <span class="comment">// Loop while no data are pending.</span>
<a name="l00385"></a>00385     <a class="code" href="a00005.html#cd68f9f9df0f6c5d03bf43ecfa141fab">vMACBWaitForInput</a>(100);
<a name="l00386"></a>00386     <span class="comment">// Obtain the size of the packet.</span>
<a name="l00387"></a>00387     len = <a class="code" href="a00005.html#b9aba6f90d51b2e50e71efc4d40715c8">ulMACBInputLength</a>();
<a name="l00388"></a>00388     <span class="keywordflow">if</span>( len != 0)
<a name="l00389"></a>00389     {
<a name="l00390"></a>00390       <span class="comment">// Let the driver know we are going to read a new packet.</span>
<a name="l00391"></a>00391       <a class="code" href="a00005.html#4ca1fe9983732c3de6b2618bec0bfe40">vMACBRead</a>( NULL, 0, 0 );
<a name="l00392"></a>00392       <span class="comment">// Read enough bytes to fill this buf.</span>
<a name="l00393"></a>00393       <a class="code" href="a00005.html#4ca1fe9983732c3de6b2618bec0bfe40">vMACBRead</a>( <a class="code" href="a00007.html#c24b8dbe47757bf3dd3679b87acdda80">data</a>, 128, len );
<a name="l00394"></a>00394       recvd_pkt.<a class="code" href="a00003.html#d90282a55598717bb685ccaaf58394d3">data</a> = <a class="code" href="a00007.html#c24b8dbe47757bf3dd3679b87acdda80">data</a>;
<a name="l00395"></a>00395       recvd_pkt.<a class="code" href="a00003.html#ee05700dfd8162650acbb5e7f144e7e5">len</a> = len;
<a name="l00396"></a>00396       <a class="code" href="a00007.html#54cb65560f336243d94e84f26dddfd0f">macb_example_receive_packet</a>(&amp;recvd_pkt);
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398     <span class="keywordflow">if</span> (++i &gt;= 400)
<a name="l00399"></a>00399     {
<a name="l00400"></a>00400       i = 0;
<a name="l00401"></a>00401       <span class="comment">// send ARP request to host</span>
<a name="l00402"></a>00402       <a class="code" href="a00007.html#0ee6c441ecc2b7d058c4045a9c468cb4">macb_example_send_ARP_request</a>();
<a name="l00403"></a>00403     }    
<a name="l00404"></a>00404   }
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Sep 20 12:16:48 2007 for AVR32 - MACB Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>
