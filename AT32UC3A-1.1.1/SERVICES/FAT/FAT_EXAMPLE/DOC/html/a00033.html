<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>AVR32 - FAT Services: fat.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>fat.c</h1><a href="a00017.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00018"></a>00018 <span class="comment">/* Copyright (c) 2007, Atmel Corporation All rights reserved.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00021"></a>00021 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
<a name="l00024"></a>00024 <span class="comment"> * this list of conditions and the following disclaimer.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00027"></a>00027 <span class="comment"> * this list of conditions and the following disclaimer in the documentation</span>
<a name="l00028"></a>00028 <span class="comment"> * and/or other materials provided with the distribution.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * 3. The name of ATMEL may not be used to endorse or promote products derived</span>
<a name="l00031"></a>00031 <span class="comment"> * from this software without specific prior written permission.</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ATMEL ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
<a name="l00034"></a>00034 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00035"></a>00035 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY AND</span>
<a name="l00036"></a>00036 <span class="comment"> * SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT,</span>
<a name="l00037"></a>00037 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00038"></a>00038 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00039"></a>00039 <span class="comment"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<a name="l00040"></a>00040 <span class="comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00041"></a>00041 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a name="l00042"></a>00042 <span class="comment"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00043"></a>00043 <span class="comment"> */</span>
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="a00017.html#de9a4ddf526f95045c8e8f772662988f">00045</a> <span class="preprocessor">#define _fat_c_</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="comment">//_____  I N C L U D E S ___________________________________________________</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="a00014.html">conf_explorer.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="a00023.html">fs_com.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="a00018.html">fat.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include LIB_MEM</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#include LIB_CTRLACCESS</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">//_____ D E F I N I T I O N S ______________________________________________</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00060"></a>00060 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00061"></a><a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">00061</a> <span class="preprocessor"></span>_MEM_TYPE_SLOW_     <a class="code" href="a00004.html">Fs_management</a>       <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a>-1];
<a name="l00062"></a><a class="code" href="a00017.html#d24195746b40d4a83dff493c118b91aa">00062</a> _MEM_TYPE_SLOW_     <a class="code" href="a00006.html">Fs_management_fast</a>  <a class="code" href="a00017.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a>-1];
<a name="l00063"></a><a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">00063</a> _MEM_TYPE_SLOW_     <a class="code" href="a00005.html">Fs_management_entry</a> <a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a>-1];
<a name="l00064"></a>00064 <span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">00069</a> <span class="preprocessor">_MEM_TYPE_SLOW_     Fs_clusterlist_cache fs_g_cache_clusterlist[FS_NB_CACHE_CLUSLIST];</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST&gt;1)</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>   _MEM_TYPE_SLOW_     U8  <a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>;
<a name="l00072"></a>00072 <span class="preprocessor">#else</span>
<a name="l00073"></a><a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">00073</a> <span class="preprocessor"></span><span class="preprocessor">#  define fs_g_u8_current_cache  0</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="comment">//_____ D E C L A R A T I O N S ____________________________________________</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 
<a name="l00082"></a>00082 <span class="keywordtype">void</span>  <a class="code" href="a00017.html#0a4940852a79296a91956954760c293b">fat_cache_clusterlist_update_start</a>  ( <span class="keywordtype">void</span> );
<a name="l00083"></a>00083 <span class="keywordtype">void</span>  <a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">fat_cache_clusterlist_update_finish</a> ( <span class="keywordtype">void</span> );
<a name="l00084"></a>00084 Bool  <a class="code" href="a00017.html#861947c267cdb98aeb66cbc61cb671d7">fat_cache_clusterlist_update_read</a>   ( <span class="keywordtype">void</span> );
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00099"></a><a class="code" href="a00018.html#eeec0bd6755a6be4c4dda2b4669eb0ae">00099</a> Bool  <a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>( <span class="keywordtype">void</span> )
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101    U8 retry=0;
<a name="l00102"></a>00102    U8 i;
<a name="l00103"></a>00103    <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> status;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105    <span class="keywordflow">if</span>( 0xFF == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l00106"></a>00106    {
<a name="l00107"></a>00107       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#cf37e5255ee1dbfaab77def32a7cbbef">FS_ERR_HW</a>;
<a name="l00108"></a>00108       <span class="keywordflow">return</span> FALSE;  <span class="comment">// No device selected</span>
<a name="l00109"></a>00109    }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111    <span class="comment">// Check device</span>
<a name="l00112"></a>00112    <span class="keywordflow">for</span>( retry=0 ; retry&lt;100 ; retry++ )
<a name="l00113"></a>00113    {
<a name="l00114"></a>00114       status = <a class="code" href="a00015.html#51555be425eeacfd88e603b9cba97049">mem_test_unit_ready</a>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> );
<a name="l00115"></a>00115       <span class="keywordflow">if</span>( <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>       == status )
<a name="l00116"></a>00116          <span class="keywordflow">return</span> TRUE;   <span class="comment">// drive OK</span>
<a name="l00117"></a>00117       
<a name="l00118"></a>00118       <span class="comment">//* HERE error</span>
<a name="l00119"></a>00119       <span class="comment">// then clean the struct management of device</span>
<a name="l00120"></a>00120       <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a> = <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a>; <span class="comment">// By default the fat isn't mounted</span>
<a name="l00121"></a>00121       <a class="code" href="a00018.html#8e3b3ddad0e2b4f1747507a2665b0901">Fat_file_close</a>;                              <span class="comment">// By default the file is not open</span>
<a name="l00122"></a>00122       <span class="comment">// Update all navigators</span>
<a name="l00123"></a>00123 #if (<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a> &gt; 1)
<a name="l00124"></a>00124       <span class="keywordflow">for</span>( i=0 ; i!=(<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a>-1) ; i++ )
<a name="l00125"></a>00125       {
<a name="l00126"></a>00126          <span class="comment">// Is it the same disk ?</span>
<a name="l00127"></a>00127          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> == <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l00128"></a>00128          {
<a name="l00129"></a>00129             <a class="code" href="a00017.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[i].<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>     = <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a>;   <span class="comment">// By default the fat isn't mounted</span>
<a name="l00130"></a>00130             <a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>   = 0;                 <span class="comment">// By default the file is not open</span>
<a name="l00131"></a>00131          }
<a name="l00132"></a>00132       }
<a name="l00133"></a>00133 <span class="preprocessor">#endif</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>      <span class="comment">// if the sector cache corresponding at LUN then delete this one</span>
<a name="l00135"></a>00135       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> == <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a> )
<a name="l00136"></a>00136       {
<a name="l00137"></a>00137          <a class="code" href="a00017.html#961692919a93b6cb714ec2a3d57c0141">fat_cache_reset</a>();
<a name="l00138"></a>00138       }
<a name="l00139"></a>00139       <span class="comment">// By default HW error</span>
<a name="l00140"></a>00140       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#cf37e5255ee1dbfaab77def32a7cbbef">FS_ERR_HW</a>;
<a name="l00141"></a>00141       <span class="keywordflow">if</span>( <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e29172ef3612d2c1df6f137934d4b89b18b7">CTRL_NO_PRESENT</a> == status )
<a name="l00142"></a>00142          <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#599d11cd249edc025b1a1fb514809db6">FS_ERR_HW_NO_PRESENT</a>;
<a name="l00143"></a>00143       <span class="keywordflow">if</span>( <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>       == status )
<a name="l00144"></a>00144          <span class="keywordflow">break</span>;         <span class="comment">// fatal error no retry</span>
<a name="l00145"></a>00145       <span class="comment">// Here retry</span>
<a name="l00146"></a>00146    }
<a name="l00147"></a>00147    
<a name="l00148"></a>00148    <span class="keywordflow">return</span> FALSE;
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 
<a name="l00157"></a><a class="code" href="a00018.html#8ee865aa4c51519c0d141f1f4559c72a">00157</a> Bool  <a class="code" href="a00017.html#8ee865aa4c51519c0d141f1f4559c72a">fat_check_mount</a>( <span class="keywordtype">void</span> )
<a name="l00158"></a>00158 {
<a name="l00159"></a>00159    <span class="comment">// Check list before action on file or navigation</span>
<a name="l00160"></a>00160    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>() )
<a name="l00161"></a>00161       <span class="keywordflow">return</span> FALSE;
<a name="l00162"></a>00162       
<a name="l00163"></a>00163    <span class="keywordflow">if</span> (<a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>)
<a name="l00164"></a>00164    {
<a name="l00165"></a>00165       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#1aeb93f5a9728927830dd999b9b0e720">FS_ERR_NO_MOUNT</a>;
<a name="l00166"></a>00166       <span class="keywordflow">return</span> FALSE;
<a name="l00167"></a>00167    }
<a name="l00168"></a>00168    <span class="keywordflow">return</span> TRUE;
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 
<a name="l00177"></a><a class="code" href="a00018.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">00177</a> Bool  <a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>( <span class="keywordtype">void</span> )
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179    <span class="comment">// Check list before action on file or navigation</span>
<a name="l00180"></a>00180    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>() )
<a name="l00181"></a>00181       <span class="keywordflow">return</span> TRUE;
<a name="l00182"></a>00182    <span class="keywordflow">if</span> (<a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>)
<a name="l00183"></a>00183       <span class="keywordflow">return</span> TRUE;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#74f14f9de5d4bb80cf25a5f8590a945d">Fat_file_is_open</a> )
<a name="l00186"></a>00186    {
<a name="l00187"></a>00187       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#498b273aa1304bf952cff68f0904e869">FS_ERR_TOO_FILE_OPEN</a>;  <span class="comment">// The navigation have already open a file</span>
<a name="l00188"></a>00188       <span class="keywordflow">return</span> FALSE;
<a name="l00189"></a>00189    }
<a name="l00190"></a>00190    <span class="keywordflow">return</span> TRUE;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 
<a name="l00199"></a><a class="code" href="a00018.html#4efc7734a340e899bb54506b277bb8c1">00199</a> Bool  <a class="code" href="a00017.html#4efc7734a340e899bb54506b277bb8c1">fat_check_open</a>( <span class="keywordtype">void</span> )
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#a10de8acc8a9328380a78cca9d843e90">Fat_file_isnot_open</a> )
<a name="l00202"></a>00202    {
<a name="l00203"></a>00203       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#ac3120e8423320b534f9ec08112ee8b9">FS_ERR_FILE_NO_OPEN</a>;
<a name="l00204"></a>00204       <span class="keywordflow">return</span> FALSE;
<a name="l00205"></a>00205    }
<a name="l00206"></a>00206    <span class="keywordflow">return</span> TRUE;
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 
<a name="l00215"></a><a class="code" href="a00018.html#909da9e84afbebf8ed5838cbe5002f60">00215</a> Bool  <a class="code" href="a00017.html#909da9e84afbebf8ed5838cbe5002f60">fat_check_select</a>( <span class="keywordtype">void</span> )
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217    <span class="comment">// Check if the file is selected</span>
<a name="l00218"></a>00218    <span class="keywordflow">if</span> (<a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>)
<a name="l00219"></a>00219    {
<a name="l00220"></a>00220       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#231c28be4072acdd82517f3a24e2b245">FS_ERR_NO_FILE_SEL</a>;
<a name="l00221"></a>00221       <span class="keywordflow">return</span> FALSE;
<a name="l00222"></a>00222    }
<a name="l00223"></a>00223    <span class="keywordflow">return</span> TRUE;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 
<a name="l00232"></a><a class="code" href="a00018.html#e9d0f61d0e7b29a4e8e9e95347194f21">00232</a> Bool  <a class="code" href="a00017.html#e9d0f61d0e7b29a4e8e9e95347194f21">fat_check_mount_noopen</a>( <span class="keywordtype">void</span> )
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8ee865aa4c51519c0d141f1f4559c72a">fat_check_mount</a>() )
<a name="l00235"></a>00235       <span class="keywordflow">return</span> FALSE;
<a name="l00236"></a>00236    <span class="keywordflow">return</span> <a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>();
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 
<a name="l00245"></a><a class="code" href="a00018.html#003f1c81dcb2c7a95f191c30b8a4f258">00245</a> Bool  <a class="code" href="a00017.html#003f1c81dcb2c7a95f191c30b8a4f258">fat_check_mount_select_noopen</a>( <span class="keywordtype">void</span> )
<a name="l00246"></a>00246 {
<a name="l00247"></a>00247    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8ee865aa4c51519c0d141f1f4559c72a">fat_check_mount</a>() )
<a name="l00248"></a>00248       <span class="keywordflow">return</span> FALSE;
<a name="l00249"></a>00249    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#909da9e84afbebf8ed5838cbe5002f60">fat_check_select</a>() )
<a name="l00250"></a>00250       <span class="keywordflow">return</span> FALSE;
<a name="l00251"></a>00251    <span class="keywordflow">return</span> <a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>();
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 
<a name="l00260"></a><a class="code" href="a00018.html#0096f66037f89595dfccbca38ab795f8">00260</a> Bool  <a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>( <span class="keywordtype">void</span> )
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8ee865aa4c51519c0d141f1f4559c72a">fat_check_mount</a>() )
<a name="l00263"></a>00263       <span class="keywordflow">return</span> FALSE;
<a name="l00264"></a>00264    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#909da9e84afbebf8ed5838cbe5002f60">fat_check_select</a>() )
<a name="l00265"></a>00265       <span class="keywordflow">return</span> FALSE;
<a name="l00266"></a>00266    <span class="keywordflow">return</span> <a class="code" href="a00017.html#4efc7734a340e899bb54506b277bb8c1">fat_check_open</a>();
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 
<a name="l00275"></a><a class="code" href="a00018.html#47e29fedbed4084c9f8ec6f27b51015d">00275</a> Bool  <a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>( <span class="keywordtype">void</span> )
<a name="l00276"></a>00276 {
<a name="l00277"></a>00277    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8ee865aa4c51519c0d141f1f4559c72a">fat_check_mount</a>() )
<a name="l00278"></a>00278       <span class="keywordflow">return</span> FALSE;
<a name="l00279"></a>00279    <span class="keywordflow">return</span> <a class="code" href="a00017.html#909da9e84afbebf8ed5838cbe5002f60">fat_check_select</a>();
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 
<a name="l00288"></a><a class="code" href="a00018.html#2fb226027c5ea59f40c582737e5a44b9">00288</a> Bool  <a class="code" href="a00017.html#2fb226027c5ea59f40c582737e5a44b9">fat_check_is_file</a>( <span class="keywordtype">void</span> )
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290    <span class="keywordflow">if</span>( <a class="code" href="a00023.html#627f80804f90f766ed2cda3a012bcf66">Fat_is_not_a_file</a> )
<a name="l00291"></a>00291    {
<a name="l00292"></a>00292       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#d9116e06ad4be1ef2ff8e7cb649ccb90">FS_ERR_NO_FILE</a>;   <span class="comment">// It isn't a file, it is a directory or volume id</span>
<a name="l00293"></a>00293       <span class="keywordflow">return</span> FALSE;
<a name="l00294"></a>00294    }
<a name="l00295"></a>00295    <span class="keywordflow">return</span> TRUE;
<a name="l00296"></a>00296 }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00304"></a><a class="code" href="a00018.html#920798e6366e8c3c408601c58fed4bb3">00304</a> <span class="preprocessor">U8    fat_get_nbpartition( void )</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>{
<a name="l00306"></a>00306    <span class="comment">// Check if the drive is avialable</span>
<a name="l00307"></a>00307    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>() )
<a name="l00308"></a>00308       <span class="keywordflow">return</span> 0;
<a name="l00309"></a>00309       
<a name="l00310"></a>00310    <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a> = 0;   <span class="comment">// Init ptr fat at the beginning of memory</span>
<a name="l00311"></a>00311    
<a name="l00312"></a>00312    <span class="comment">// Read one sector</span>
<a name="l00313"></a>00313    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( TRUE ))
<a name="l00314"></a>00314       <span class="keywordflow">return</span> FALSE;
<a name="l00315"></a>00315    
<a name="l00316"></a>00316    <span class="comment">// Check PBR or MBR signature</span>
<a name="l00317"></a>00317    <span class="keywordflow">if</span> ( (<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[510] != <a class="code" href="a00018.html#36f09355f7020d410cb43695cab680fa">FS_BR_SIGNATURE_LOW</a>  )
<a name="l00318"></a>00318    &amp;&amp;   (<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[511] != <a class="code" href="a00018.html#b4cd4bfc6a5baebc1d25bbc5d5db2c15">FS_BR_SIGNATURE_HIGH</a> ) )
<a name="l00319"></a>00319    {
<a name="l00320"></a>00320       <span class="comment">// No MBR</span>
<a name="l00321"></a>00321       <span class="comment">// The sector, is it a PBR ?</span>
<a name="l00322"></a>00322       <span class="keywordflow">if</span> ( (<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[0] == 0xEB) &amp;&amp;          <span class="comment">// PBR Byte 0</span>
<a name="l00323"></a>00323            (<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[2] == 0x90) &amp;&amp;          <span class="comment">// PBR Byte 2</span>
<a name="l00324"></a>00324            ((<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[21] &amp; 0xF0) == 0xF0) ) <span class="comment">// PBR Byte 21 : Media byte</span>
<a name="l00325"></a>00325       {  
<a name="l00326"></a>00326          <span class="keywordflow">return</span> 1;   <span class="comment">// No MBR but PBR exist then only one partition</span>
<a name="l00327"></a>00327       } <span class="keywordflow">else</span> {
<a name="l00328"></a>00328          <span class="keywordflow">return</span> 0;   <span class="comment">// No MBR and no PBR then no partition found</span>
<a name="l00329"></a>00329       }
<a name="l00330"></a>00330    }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332    number_part = 0;
<a name="l00333"></a>00333    <span class="keywordflow">while</span>( 1 )
<a name="l00334"></a>00334    {
<a name="l00335"></a>00335       <span class="comment">// The first sector must be a MBR, then check the partition entry in the MBR</span>
<a name="l00336"></a>00336       <span class="keywordflow">if</span> ( ((<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00018.html#70b90ba913c43a878e9b478de5d1b61c">FS_MBR_OFFSET_PART_ENTRY</a>(number_part)+0] != <a class="code" href="a00018.html#450f174270801d9b3e2d66854b607148">FS_PARTITION_ACTIVE</a>) &amp;&amp;
<a name="l00337"></a>00337             (<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00018.html#70b90ba913c43a878e9b478de5d1b61c">FS_MBR_OFFSET_PART_ENTRY</a>(number_part)+0] != 0x00))
<a name="l00338"></a>00338       ||    (<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00018.html#70b90ba913c43a878e9b478de5d1b61c">FS_MBR_OFFSET_PART_ENTRY</a>(number_part)+4] == 0x00) )
<a name="l00339"></a>00339       {
<a name="l00340"></a>00340          <span class="keywordflow">break</span>;
<a name="l00341"></a>00341       }
<a name="l00342"></a>00342       number_part++;
<a name="l00343"></a>00343    }
<a name="l00344"></a>00344    <span class="keywordflow">return</span> number_part;
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 <span class="preprocessor">#endif</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 <span class="comment">// To clean the code </span>
<a name="l00350"></a>00350 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST==1)</span>
<a name="l00351"></a><a class="code" href="a00017.html#5985f32ca0a3714cb4b55abf404be10c">00351</a> <span class="preprocessor"></span><span class="preprocessor">#  define u8_i                   0</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span>
<a name="l00374"></a><a class="code" href="a00018.html#dd96ad16d133974463fd6a5c4bc8bd5f">00374</a> Bool  <a class="code" href="a00017.html#dd96ad16d133974463fd6a5c4bc8bd5f">fat_cluster_list</a>( U8 opt_action )
<a name="l00375"></a>00375 {
<a name="l00376"></a>00376    _MEM_TYPE_FAST_ U32 u32_tmp;
<a name="l00377"></a>00377    _MEM_TYPE_FAST_ U8 u8_cluster_status;
<a name="l00378"></a>00378    
<a name="l00379"></a>00379    <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#89613ba21711697c707a3199bf93b9cf">FS_ERR_FS</a>; <span class="comment">// By default system error</span>
<a name="l00380"></a>00380    
<a name="l00381"></a>00381    <span class="keywordflow">if</span>(  <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a>
<a name="l00382"></a>00382    &amp;&amp;  (<a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action) )
<a name="l00383"></a>00383    {
<a name="l00384"></a>00384       <span class="comment">// Clear info about free space FAT32</span>
<a name="l00385"></a>00385       <span class="keywordflow">if</span>( !<a class="code" href="a00018.html#9cf154ffe36bc2c00b1d589e523b449c">fat_write_fat32_FSInfo</a>( 0xFFFFFFFF ))
<a name="l00386"></a>00386          <span class="keywordflow">return</span> FALSE;
<a name="l00387"></a>00387    }
<a name="l00388"></a>00388    
<a name="l00389"></a>00389    <span class="keywordflow">if</span> ( 0 == <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> )
<a name="l00390"></a>00390    {  
<a name="l00391"></a>00391       <span class="comment">// current dir is a root</span>
<a name="l00392"></a>00392       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action )
<a name="l00393"></a>00393          <span class="keywordflow">return</span> FALSE;  <span class="comment">// Impossible to erase ROOT DIR</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395       <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> || <a class="code" href="a00018.html#2dcd74d640da1e20ad510413c9ef4c85">Is_fat16</a> )
<a name="l00396"></a>00396       {  
<a name="l00397"></a>00397          <span class="comment">// For a FAT 12 &amp; 16, the root dir isn't a listing of cluster</span>
<a name="l00398"></a>00398          <span class="comment">// Check the position</span>
<a name="l00399"></a>00399          <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> &lt; <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b26050633d0597af6c2c6abe9684481b">rootdir</a>.<a class="code" href="a00007.html#996b5fc79b7527c2b3dc3b34ed98f428">seg</a>.<a class="code" href="a00007.html#5e384bddb7393218e17f0329d1b8527f">u16_size</a> )
<a name="l00400"></a>00400          {
<a name="l00401"></a>00401             <span class="comment">// Computed the start address and the size remaining</span>
<a name="l00402"></a>00402             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af1d8fda28bded48a54c7eab4d729618">u32_ptr_fat</a> + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b26050633d0597af6c2c6abe9684481b">rootdir</a>.<a class="code" href="a00007.html#996b5fc79b7527c2b3dc3b34ed98f428">seg</a>.<a class="code" href="a00007.html#a17ca07269fcb28d77b14e5a67d56378">u16_pos</a> + <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00403"></a>00403             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b26050633d0597af6c2c6abe9684481b">rootdir</a>.<a class="code" href="a00007.html#996b5fc79b7527c2b3dc3b34ed98f428">seg</a>.<a class="code" href="a00007.html#5e384bddb7393218e17f0329d1b8527f">u16_size</a> - <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00404"></a>00404             <span class="keywordflow">return</span> TRUE;
<a name="l00405"></a>00405          } <span class="keywordflow">else</span> {
<a name="l00406"></a>00406             <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a>;
<a name="l00407"></a>00407             <span class="keywordflow">return</span> FALSE;  <span class="comment">// Error incorrect position</span>
<a name="l00408"></a>00408          }
<a name="l00409"></a>00409       }
<a name="l00410"></a>00410       <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00411"></a>00411       {
<a name="l00412"></a>00412          <span class="comment">// For FAT 32, the root dir is a listing of cluster same a other dir</span>
<a name="l00413"></a>00413          <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b26050633d0597af6c2c6abe9684481b">rootdir</a>.<a class="code" href="a00007.html#54d1e701d0705a2b2adb2b2cdc2e604b">u32_cluster</a>;
<a name="l00414"></a>00414       }
<a name="l00415"></a>00415    } <span class="keywordflow">else</span> {
<a name="l00416"></a>00416       <span class="comment">// It is a cluster, and not a root directory</span>
<a name="l00417"></a>00417       <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>;
<a name="l00418"></a>00418    }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420    <span class="comment">// Management cache cluster list</span>
<a name="l00421"></a>00421    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> != opt_action )
<a name="l00422"></a>00422    {
<a name="l00423"></a>00423       <span class="keywordflow">if</span>( <a class="code" href="a00017.html#861947c267cdb98aeb66cbc61cb671d7">fat_cache_clusterlist_update_read</a>() )
<a name="l00424"></a>00424          <span class="keywordflow">return</span> TRUE;   <span class="comment">// Segment found in cache</span>
<a name="l00425"></a>00425       <span class="comment">// Segment no found &amp; cache ready to update</span>
<a name="l00426"></a>00426    }<span class="keywordflow">else</span>{
<a name="l00427"></a>00427       <a class="code" href="a00017.html#ecb0d4c200bed41b8bdcf671aa931a2a">fat_cache_clusterlist_reset</a>();   <span class="comment">// ask to clear cluster list then cache unvalid</span>
<a name="l00428"></a>00428 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00429"></a>00429 <span class="preprocessor"></span>      <a class="code" href="a00018.html#9503329592cf7484faf77ca95a6a21aa">fat_clear_info_fat_mod</a>();        <span class="comment">// in case of clear action</span>
<a name="l00430"></a>00430 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span>   }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433    <span class="comment">// Init start segment no found</span>
<a name="l00434"></a>00434    MSB0( <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> ) = 0xFF;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436    <span class="comment">//**** Loop of read a cluster listing</span>
<a name="l00437"></a>00437    <span class="keywordflow">while</span> ( 1 )
<a name="l00438"></a>00438    {
<a name="l00439"></a>00439       <span class="comment">// The segment start in this cluster ?</span>
<a name="l00440"></a>00440       <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> &lt; <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a> )
<a name="l00441"></a>00441       {
<a name="l00442"></a>00442          <span class="comment">// Computed the sector address of this cluster</span>
<a name="l00443"></a>00443          <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = ((<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> - 2) * <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>)
<a name="l00444"></a>00444                            + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af1d8fda28bded48a54c7eab4d729618">u32_ptr_fat</a> + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#d12585f4d1f75862d62ddcb9386b5d4d">u16_offset_data</a> + <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446          <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a> == opt_action )
<a name="l00447"></a>00447          {  
<a name="l00448"></a>00448             <span class="comment">// Compute the max size</span>
<a name="l00449"></a>00449             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>-<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00450"></a>00450             <a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">fat_cache_clusterlist_update_finish</a>();
<a name="l00451"></a>00451             <span class="comment">// Send a size of one sector</span>
<a name="l00452"></a>00452             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = 1;
<a name="l00453"></a>00453             <span class="keywordflow">return</span> TRUE;
<a name="l00454"></a>00454          }
<a name="l00455"></a>00455          <span class="comment">// Computed the size of the first segment</span>
<a name="l00456"></a>00456          <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a> - LSB0( <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> );
<a name="l00457"></a>00457 
<a name="l00458"></a>00458          <span class="comment">// Optimize the speed read cluster segment for FAT 16 &amp; 32</span>
<a name="l00459"></a>00459          <span class="keywordflow">if</span>( (<a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == opt_action)
<a name="l00460"></a>00460          &amp;&amp;  (!<a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a>) )
<a name="l00461"></a>00461          {
<a name="l00462"></a>00462             <span class="comment">// Init to 0 cluster continue</span>
<a name="l00463"></a>00463             u32_tmp = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>;
<a name="l00464"></a>00464             <span class="comment">// init first value used by fat_cluster_readnext()</span>
<a name="l00465"></a>00465             <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#1be84552293d174f534b2fb8d0a4e737">fat_cluster_val</a>( <a class="code" href="a00018.html#087734ece5cae84508fd1fbe9414ad02">FS_CLUST_VAL_READ</a> ))
<a name="l00466"></a>00466                <span class="keywordflow">return</span> FALSE;
<a name="l00467"></a>00467             <span class="comment">// Optimized loop to read cluster</span>
<a name="l00468"></a>00468             <span class="keywordflow">while</span>(1)
<a name="l00469"></a>00469             {
<a name="l00470"></a>00470                <span class="keywordflow">if</span> ( (++<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>) != <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> )
<a name="l00471"></a>00471                {
<a name="l00472"></a>00472                   <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>--; <span class="comment">// Recompute previous value</span>
<a name="l00473"></a>00473                   u32_tmp = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> - u32_tmp; <span class="comment">// compute the size of cluster list</span>
<a name="l00474"></a>00474                   <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> += u32_tmp * <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>;
<a name="l00475"></a>00475                   <span class="keywordflow">break</span>;
<a name="l00476"></a>00476                }
<a name="l00477"></a>00477                <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#e28958d1a5e3ed006edf937e6b7dacc7">fat_cluster_readnext</a>() )
<a name="l00478"></a>00478                   <span class="keywordflow">return</span> FALSE;
<a name="l00479"></a>00479             }
<a name="l00480"></a>00480          }
<a name="l00481"></a>00481       }
<a name="l00482"></a>00482       <span class="comment">// Get the value of the cluster</span>
<a name="l00483"></a>00483       <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#1be84552293d174f534b2fb8d0a4e737">fat_cluster_val</a>( <a class="code" href="a00018.html#087734ece5cae84508fd1fbe9414ad02">FS_CLUST_VAL_READ</a> ))
<a name="l00484"></a>00484          <span class="keywordflow">return</span> FALSE;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486       <span class="comment">// Read and check the status of the new cluster</span>
<a name="l00487"></a>00487       u8_cluster_status = <a class="code" href="a00017.html#4010dc2ad42864603bb81a41b485d346">fat_checkcluster</a>();
<a name="l00488"></a>00488       <span class="keywordflow">if</span> (<a class="code" href="a00018.html#296001b537ea1cf21069172943e73e60">FS_CLUS_BAD</a> == u8_cluster_status)
<a name="l00489"></a>00489          <span class="keywordflow">return</span> FALSE; <span class="comment">// error, end of cluster listing</span>
<a name="l00490"></a>00490    
<a name="l00491"></a>00491       <span class="keywordflow">if</span> (0xFF == MSB0(<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>))
<a name="l00492"></a>00492       {
<a name="l00493"></a>00493          <span class="comment">// The beginning of the segment isn't found</span>
<a name="l00494"></a>00494          <span class="keywordflow">if</span> (<a class="code" href="a00018.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a> == u8_cluster_status)
<a name="l00495"></a>00495          {
<a name="l00496"></a>00496             u32_tmp = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;       <span class="comment">// Save number of sector remaining</span>
<a name="l00497"></a>00497             
<a name="l00498"></a>00498             <span class="comment">// Computed the sector address of this last cluster to speed the eventualy next same ask via cache</span>
<a name="l00499"></a>00499             <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a> -= <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00500"></a>00500             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = ((<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> - 2) * <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>)
<a name="l00501"></a>00501                               + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af1d8fda28bded48a54c7eab4d729618">u32_ptr_fat</a> + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#d12585f4d1f75862d62ddcb9386b5d4d">u16_offset_data</a>;
<a name="l00502"></a>00502             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>;
<a name="l00503"></a>00503             <span class="keywordflow">if</span> (<a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> != opt_action)
<a name="l00504"></a>00504                <a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">fat_cache_clusterlist_update_finish</a>();
<a name="l00505"></a>00505 
<a name="l00506"></a>00506             <span class="comment">// The position is out of the cluster listing</span>
<a name="l00507"></a>00507             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>; <span class="comment">// Send the last cluster value</span>
<a name="l00508"></a>00508             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = u32_tmp;       <span class="comment">// Rstore number of sector remaining</span>
<a name="l00509"></a>00509             <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a>;
<a name="l00510"></a>00510             <span class="keywordflow">return</span> FALSE; 
<a name="l00511"></a>00511          }
<a name="l00512"></a>00512          <span class="comment">// Good new cluster, continue</span>
<a name="l00513"></a>00513          <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> -= <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>;
<a name="l00514"></a>00514 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00515"></a>00515 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action)
<a name="l00516"></a>00516          {
<a name="l00517"></a>00517             <span class="keywordflow">if</span>( <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> == 0)
<a name="l00518"></a>00518             {
<a name="l00519"></a>00519                <span class="comment">// SAVE the next cluster in fs_g_seg.u32_addr (no used in this mode)</span>
<a name="l00520"></a>00520                <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>;
<a name="l00521"></a>00521                <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> = <a class="code" href="a00018.html#6a0f491ab351899993a4171f5ff526f3">FS_CLUST_VAL_EOL</a>;  <span class="comment">// End of cluster list</span>
<a name="l00522"></a>00522    
<a name="l00523"></a>00523                <span class="comment">// Record the end of list</span>
<a name="l00524"></a>00524                <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#1be84552293d174f534b2fb8d0a4e737">fat_cluster_val</a>( <a class="code" href="a00018.html#c11d0331723bc237aac4d6c7a4fe7496">FS_CLUST_VAL_WRITE</a> ))
<a name="l00525"></a>00525                   <span class="keywordflow">return</span> FALSE;
<a name="l00526"></a>00526    
<a name="l00527"></a>00527                <span class="comment">// READ the next cluster in fs_g_seg.u32_addr </span>
<a name="l00528"></a>00528                <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>;
<a name="l00529"></a>00529                <span class="comment">// !!!! It isn't necessary to reinit MSB0( fs_g_seg.u32_addr ) at 0xFF,</span>
<a name="l00530"></a>00530                <span class="comment">// !!!! fs_g_seg.u32_addr will be modify at the beginning of main loop</span>
<a name="l00531"></a>00531             }
<a name="l00532"></a>00532          }
<a name="l00533"></a>00533 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span>      }
<a name="l00535"></a>00535       <span class="keywordflow">else</span>
<a name="l00536"></a>00536       {
<a name="l00537"></a>00537          <span class="comment">// The beginning of the segment is found</span>
<a name="l00538"></a>00538          <span class="keywordflow">if</span> (<a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == opt_action)
<a name="l00539"></a>00539          {
<a name="l00540"></a>00540             <span class="comment">// Check if the cluster is the next and a valid cluster</span>
<a name="l00541"></a>00541             <span class="keywordflow">if</span> ( (<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>+1) != <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> )
<a name="l00542"></a>00542             {
<a name="l00543"></a>00543                <a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">fat_cache_clusterlist_update_finish</a>();
<a name="l00544"></a>00544                <span class="keywordflow">return</span> TRUE; <span class="comment">// End of segment</span>
<a name="l00545"></a>00545             }
<a name="l00546"></a>00546          }
<a name="l00547"></a>00547 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action)
<a name="l00549"></a>00549          {
<a name="l00550"></a>00550             <span class="comment">// SAVE the next cluster in fs_g_seg.u32_addr (no used in this mode)</span>
<a name="l00551"></a>00551             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553             <span class="comment">//** Computed the new value</span>
<a name="l00554"></a>00554             <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> = 0;  <span class="comment">// by default free cluster</span>
<a name="l00555"></a>00555             <span class="comment">// If it is the first cluster (fs_g_seg.u32_size_or_pos &lt;= fs_g_nav.u8_BPB_SecPerClus)</span>
<a name="l00556"></a>00556             <span class="comment">// and doesn't start at the beginning of cluster (fs_g_seg.u32_size_or_pos != fs_g_nav.u8_BPB_SecPerClus)</span>
<a name="l00557"></a>00557             <span class="keywordflow">if</span> (<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> &lt; <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>)
<a name="l00558"></a>00558             {
<a name="l00559"></a>00559                <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> = <a class="code" href="a00018.html#6a0f491ab351899993a4171f5ff526f3">FS_CLUST_VAL_EOL</a>;  <span class="comment">// End of cluster list</span>
<a name="l00560"></a>00560             }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562             <span class="comment">//** Record new value</span>
<a name="l00563"></a>00563             <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#1be84552293d174f534b2fb8d0a4e737">fat_cluster_val</a>( <a class="code" href="a00018.html#c11d0331723bc237aac4d6c7a4fe7496">FS_CLUST_VAL_WRITE</a> ))
<a name="l00564"></a>00564                <span class="keywordflow">return</span> FALSE;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566             <span class="comment">// READ the next cluster in fs_g_seg.u32_addr </span>
<a name="l00567"></a>00567             <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>;
<a name="l00568"></a>00568             <span class="comment">// !!!! It isn't necessary to reinit MSB0( fs_g_seg.u32_addr ) at 0xFF,</span>
<a name="l00569"></a>00569             <span class="comment">// !!!! because it isn't possible that MSB0( fs_g_cluster.val ) = 0xFF.</span>
<a name="l00570"></a>00570          }
<a name="l00571"></a>00571 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00572"></a>00572 <span class="preprocessor"></span>
<a name="l00573"></a>00573          <span class="comment">// Check the end of cluster list</span>
<a name="l00574"></a>00574          <span class="keywordflow">if</span> (<a class="code" href="a00018.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a> == u8_cluster_status)
<a name="l00575"></a>00575          {
<a name="l00576"></a>00576 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00577"></a>00577 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == opt_action)
<a name="l00578"></a>00578             {
<a name="l00579"></a>00579                <span class="keywordflow">return</span> <a class="code" href="a00018.html#8145cff91620fc1b70aa0eef5750db72">fat_update_fat2</a>();
<a name="l00580"></a>00580             }
<a name="l00581"></a>00581 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>            <a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">fat_cache_clusterlist_update_finish</a>();
<a name="l00583"></a>00583             <span class="keywordflow">return</span> TRUE; <span class="comment">// End of segment</span>
<a name="l00584"></a>00584          }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586          <span class="comment">// Update the size of segment</span>
<a name="l00587"></a>00587          <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> += <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>;
<a name="l00588"></a>00588       }
<a name="l00589"></a>00589       <span class="comment">// HERE, Continue in the cluster listing</span>
<a name="l00590"></a>00590       <span class="comment">// The next cluster is the value of previous cluster</span>
<a name="l00591"></a>00591       <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>;
<a name="l00592"></a>00592    }  <span class="comment">// End of loop of read a cluster listing</span>
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00597"></a><a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">00597</a> _MEM_TYPE_FAST_ U16   <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 
<a name="l00619"></a><a class="code" href="a00018.html#1be84552293d174f534b2fb8d0a4e737">00619</a> Bool  <a class="code" href="a00017.html#1be84552293d174f534b2fb8d0a4e737">fat_cluster_val</a>( Bool b_mode )
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621    _MEM_TYPE_FAST_ U16   u16_offset_fat;
<a name="l00622"></a>00622    _MEM_TYPE_FAST_ U8    u8_data1, u8_data2;
<a name="l00623"></a>00623 <span class="preprocessor">#define  u8_data3    (LSB(u16_offset_fat)) // Manual overlay</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span><span class="preprocessor">#define  u8_data4    (MSB(u16_offset_fat)) // Manual overlay</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span>   _MEM_TYPE_FAST_ <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> u8_ptr_sector;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <span class="comment">//**** Computed the cluster position in FAT</span>
<a name="l00628"></a>00628    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00629"></a>00629    {  
<a name="l00630"></a>00630       <span class="comment">// FAT 32</span>
<a name="l00631"></a>00631       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.pos * 4 / FS_SIZE_OF_SECTOR;</span>
<a name="l00632"></a>00632       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.pos / 128</span>
<a name="l00633"></a>00633       u16_offset_fat = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> &gt;&gt; (8-1);            
<a name="l00634"></a>00634       
<a name="l00635"></a>00635       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos * 4) % FS_SIZE_OF_SECTOR;</span>
<a name="l00636"></a>00636       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos % 128) * 4</span>
<a name="l00637"></a>00637       <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = ((U16)(LSB0(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>) &amp; 0x7F))&lt;&lt; 2;
<a name="l00638"></a>00638    }
<a name="l00639"></a>00639    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#2dcd74d640da1e20ad510413c9ef4c85">Is_fat16</a> )
<a name="l00640"></a>00640    {  
<a name="l00641"></a>00641       <span class="comment">// FAT 16</span>
<a name="l00642"></a>00642       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.u32_pos * 2 / FS_SIZE_OF_SECTOR = fs_g_cluster.u32_pos / 256;</span>
<a name="l00643"></a>00643       u16_offset_fat = LSB1(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>);
<a name="l00644"></a>00644       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos * 2) % FS_SIZE_OF_SECTOR;</span>
<a name="l00645"></a>00645       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = (fs_g_cluster.u32_pos % 256) * 2</span>
<a name="l00646"></a>00646       <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = ((U16)LSB0(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>)) &lt;&lt;1;   
<a name="l00647"></a>00647    }
<a name="l00648"></a>00648    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00649"></a>00649    {
<a name="l00650"></a>00650       <span class="comment">// FAT 12</span>
<a name="l00651"></a>00651       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = fs_g_cluster.u32_pos + (fs_g_cluster.u32_pos/ 2)</span>
<a name="l00652"></a>00652       <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = (U16)<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> + ((U16)<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> &gt;&gt;1);
<a name="l00653"></a>00653       <span class="comment">// Optimization of -&gt; u16_offset_fat = fs_g_cluster.u32_pos / FS_SIZE_OF_SECTOR</span>
<a name="l00654"></a>00654       u16_offset_fat = MSB(<a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>) &gt;&gt; 1;
<a name="l00655"></a>00655       <span class="comment">// Optimization of -&gt; fs_g_u16_pos_fat = fs_g_u16_pos_fat % FS_SIZE_OF_SECTOR</span>
<a name="l00656"></a>00656       MSB( <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> ) &amp;= 0x01;
<a name="l00657"></a>00657    }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00660"></a>00660 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (b_mode)
<a name="l00661"></a>00661    {
<a name="l00662"></a>00662       <span class="comment">// Update informations position about modification of FAT 1</span>
<a name="l00663"></a>00663       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#b55b94c50b63cf8b83e2afcf2e0c2981">fs_g_u16_first_mod_fat</a> &gt; u16_offset_fat )
<a name="l00664"></a>00664       {
<a name="l00665"></a>00665          <a class="code" href="a00018.html#b55b94c50b63cf8b83e2afcf2e0c2981">fs_g_u16_first_mod_fat</a> = u16_offset_fat;
<a name="l00666"></a>00666       }
<a name="l00667"></a>00667       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#e8c6fce6d75eb9ddbf1e63e46659e9cc">fs_g_u16_last_mod_fat</a> &lt; u16_offset_fat )
<a name="l00668"></a>00668       {
<a name="l00669"></a>00669          <a class="code" href="a00018.html#e8c6fce6d75eb9ddbf1e63e46659e9cc">fs_g_u16_last_mod_fat</a> = u16_offset_fat;
<a name="l00670"></a>00670       }
<a name="l00671"></a>00671       <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00672"></a>00672       {  <span class="comment">// Only in FAT12 a cluster may be into two sector</span>
<a name="l00673"></a>00673          <span class="keywordflow">if</span>( <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> == (<a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>-1) )
<a name="l00674"></a>00674          {  <span class="comment">// Count the next sector in FAT</span>
<a name="l00675"></a>00675             <span class="keywordflow">if</span>( <a class="code" href="a00018.html#e8c6fce6d75eb9ddbf1e63e46659e9cc">fs_g_u16_last_mod_fat</a> &lt; (u16_offset_fat+1) )
<a name="l00676"></a>00676             {
<a name="l00677"></a>00677                <a class="code" href="a00018.html#e8c6fce6d75eb9ddbf1e63e46659e9cc">fs_g_u16_last_mod_fat</a> = (u16_offset_fat+1);
<a name="l00678"></a>00678             }
<a name="l00679"></a>00679          }
<a name="l00680"></a>00680       }
<a name="l00681"></a>00681    }
<a name="l00682"></a>00682 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00683"></a>00683 <span class="preprocessor"></span>
<a name="l00684"></a>00684    <span class="comment">//**** Read cluster sector in FAT</span>
<a name="l00685"></a>00685    <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af1d8fda28bded48a54c7eab4d729618">u32_ptr_fat</a> + u16_offset_fat;   <span class="comment">// Computed logical sector address</span>
<a name="l00686"></a>00686 
<a name="l00687"></a>00687    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( TRUE ))
<a name="l00688"></a>00688       <span class="keywordflow">return</span> FALSE;
<a name="l00689"></a>00689    <span class="comment">// Read cluster information</span>
<a name="l00690"></a>00690    u8_ptr_sector = &amp;<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>];
<a name="l00691"></a>00691    u8_data1 = u8_ptr_sector[0];
<a name="l00692"></a>00692    <span class="comment">// Remark: if (fs_g_u16_pos_fat+1)=512 then it isn't a mistake, because this value will be erase in next lines</span>
<a name="l00693"></a>00693    u8_data2 = u8_ptr_sector[1];
<a name="l00694"></a>00694    <a class="code" href="a00017.html#6b0f192ee05f7d19f1372a8a1fb514bc">u8_data3</a> = u8_ptr_sector[2];
<a name="l00695"></a>00695    <a class="code" href="a00017.html#4d26b9400e3057b9cfde8d083a0049e6">u8_data4</a> = u8_ptr_sector[3];
<a name="l00696"></a>00696    
<a name="l00697"></a>00697    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00698"></a>00698    {   <span class="comment">// Only in FAT12 a cluster may be into two sector</span>
<a name="l00699"></a>00699       <span class="keywordflow">if</span>(  <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> == (<a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>-1) )
<a name="l00700"></a>00700       {  <span class="comment">// Go to next sector</span>
<a name="l00701"></a>00701          <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a>++;
<a name="l00702"></a>00702          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( TRUE ))
<a name="l00703"></a>00703            <span class="keywordflow">return</span> FALSE;
<a name="l00704"></a>00704          u8_data2 = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[0];
<a name="l00705"></a>00705       }
<a name="l00706"></a>00706    }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708    <span class="keywordflow">if</span> (FALSE == b_mode)
<a name="l00709"></a>00709    {
<a name="l00710"></a>00710       <span class="comment">//**** Read the value of the cluster</span>
<a name="l00711"></a>00711       LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = u8_data1;  <span class="comment">// FAT 12,16,32</span>
<a name="l00712"></a>00712       LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = u8_data2;  <span class="comment">// FAT 12,16,32</span>
<a name="l00713"></a>00713 
<a name="l00714"></a>00714       <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00715"></a>00715       {  <span class="comment">// FAT 32</span>
<a name="l00716"></a>00716          LSB2( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = <a class="code" href="a00017.html#6b0f192ee05f7d19f1372a8a1fb514bc">u8_data3</a>;
<a name="l00717"></a>00717          LSB3( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = <a class="code" href="a00017.html#4d26b9400e3057b9cfde8d083a0049e6">u8_data4</a> &amp; 0x0F; <span class="comment">// The high 4 bits are reserved</span>
<a name="l00718"></a>00718       }
<a name="l00719"></a>00719       <span class="keywordflow">else</span>
<a name="l00720"></a>00720       {  <span class="comment">// FAT 12 &amp; 16 don't use the high bytes</span>
<a name="l00721"></a>00721          LSB2( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = 0;
<a name="l00722"></a>00722          LSB3( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = 0;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724          <span class="comment">// FAT 12 translate 16bits value to 12bits</span>
<a name="l00725"></a>00725          <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00726"></a>00726          {
<a name="l00727"></a>00727             <span class="keywordflow">if</span> ( 0x01 &amp; LSB0(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>) )
<a name="l00728"></a>00728             {  <span class="comment">// Cluster reading is ODD</span>
<a name="l00729"></a>00729                LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = (LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) &lt;&lt;4 ) + (LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) &gt;&gt;4 );
<a name="l00730"></a>00730                LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) =  LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) &gt;&gt;4 ;
<a name="l00731"></a>00731             }
<a name="l00732"></a>00732             <span class="keywordflow">else</span>
<a name="l00733"></a>00733             {  <span class="comment">// Cluster reading is EVEN</span>
<a name="l00734"></a>00734                LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) &amp;= 0x0F;
<a name="l00735"></a>00735             }
<a name="l00736"></a>00736          }
<a name="l00737"></a>00737       }
<a name="l00738"></a>00738    } <span class="keywordflow">else</span> {
<a name="l00739"></a>00739 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span>      <span class="comment">//**** Write the value of the cluster</span>
<a name="l00741"></a>00741       <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00742"></a>00742       {
<a name="l00743"></a>00743          <span class="comment">// FAT 12 computed cluster data</span>
<a name="l00744"></a>00744          <span class="keywordflow">if</span> ( 0x01 &amp; LSB0(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>) )
<a name="l00745"></a>00745          {  <span class="comment">// Cluster writing is ODD</span>
<a name="l00746"></a>00746             u8_data1 = (u8_data1 &amp; 0x0F) + (LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> )&lt;&lt;4);
<a name="l00747"></a>00747             u8_data2 = (LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> )&lt;&lt;4) + (LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> )&gt;&gt;4) ;
<a name="l00748"></a>00748          } <span class="keywordflow">else</span> {
<a name="l00749"></a>00749             <span class="comment">// Cluster writing is EVEN</span>
<a name="l00750"></a>00750             u8_data1 = LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> );
<a name="l00751"></a>00751             u8_data2 = (u8_data2 &amp; 0xF0) + (LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) &amp; 0x0F) ;
<a name="l00752"></a>00752          }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754          <span class="comment">// Only in FAT12 a cluster may be into two sector</span>
<a name="l00755"></a>00755          <span class="keywordflow">if</span>( <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> == (<a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>-1) )
<a name="l00756"></a>00756          {  
<a name="l00757"></a>00757             <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[0] = u8_data2;
<a name="l00758"></a>00758             <span class="comment">// Signal that the current sector is modify</span>
<a name="l00759"></a>00759             <a class="code" href="a00017.html#e73cb496ddbf1ab33944f99f1c50f4d0">fat_cache_sector_is_modify</a>();
<a name="l00760"></a>00760             <span class="comment">// Go to previous sector</span>
<a name="l00761"></a>00761             <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a>--;
<a name="l00762"></a>00762             <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( TRUE ))
<a name="l00763"></a>00763               <span class="keywordflow">return</span> FALSE;
<a name="l00764"></a>00764             <span class="comment">// Modify the first sector</span>
<a name="l00765"></a>00765             <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>-1 ] = u8_data1;
<a name="l00766"></a>00766             <a class="code" href="a00017.html#e73cb496ddbf1ab33944f99f1c50f4d0">fat_cache_sector_is_modify</a>();
<a name="l00767"></a>00767             <span class="keywordflow">return</span> TRUE;
<a name="l00768"></a>00768          }
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770       <span class="keywordflow">else</span>
<a name="l00771"></a>00771       {
<a name="l00772"></a>00772          <span class="comment">// FAT 16 &amp; 32</span>
<a name="l00773"></a>00773          u8_data1 = LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> );
<a name="l00774"></a>00774          u8_data2 = LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> );
<a name="l00775"></a>00775          <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00776"></a>00776          {  <span class="comment">// FAT 32</span>
<a name="l00777"></a>00777             u8_ptr_sector[2] = LSB2( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> );
<a name="l00778"></a>00778             u8_ptr_sector[3] = LSB3( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) + (<a class="code" href="a00017.html#4d26b9400e3057b9cfde8d083a0049e6">u8_data4</a> &amp; 0xF0); <span class="comment">// The high 4 bits are reserved</span>
<a name="l00779"></a>00779          }
<a name="l00780"></a>00780       }
<a name="l00781"></a>00781       <span class="comment">// Here for FAT 32, 16 &amp; 12 (only if the cluster values are in the same sector)</span>
<a name="l00782"></a>00782       u8_ptr_sector[0] = u8_data1;
<a name="l00783"></a>00783       u8_ptr_sector[1] = u8_data2;
<a name="l00784"></a>00784       <a class="code" href="a00017.html#e73cb496ddbf1ab33944f99f1c50f4d0">fat_cache_sector_is_modify</a>();
<a name="l00785"></a>00785 <span class="preprocessor">#else</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span>      <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#d85516645a3ffadb77b948fd6d5bcb08">FS_ERR_COMMAND</a>;
<a name="l00787"></a>00787       <span class="keywordflow">return</span> FALSE;
<a name="l00788"></a>00788 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span>   }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791    <span class="keywordflow">return</span> TRUE;
<a name="l00792"></a>00792 <span class="preprocessor">#undef  u8_data3    // end of Manual overlay</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span><span class="preprocessor">#undef  u8_data4    // end of Manual overlay</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span>}
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 
<a name="l00815"></a><a class="code" href="a00018.html#e28958d1a5e3ed006edf937e6b7dacc7">00815</a> Bool  <a class="code" href="a00017.html#e28958d1a5e3ed006edf937e6b7dacc7">fat_cluster_readnext</a>( <span class="keywordtype">void</span> )
<a name="l00816"></a>00816 {
<a name="l00817"></a>00817    <span class="comment">// Computed the next cluster position in FAT</span>
<a name="l00818"></a>00818    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00819"></a>00819    {  
<a name="l00820"></a>00820       <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> += 4;
<a name="l00821"></a>00821    }<span class="keywordflow">else</span>{
<a name="l00822"></a>00822       <span class="comment">// Is_fat16</span>
<a name="l00823"></a>00823       <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> += 2;
<a name="l00824"></a>00824    }
<a name="l00825"></a>00825    
<a name="l00826"></a>00826    <span class="comment">// Check if next sector in FAT</span>
<a name="l00827"></a>00827    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> == <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> )
<a name="l00828"></a>00828    {
<a name="l00829"></a>00829       <span class="comment">// Read next sector</span>
<a name="l00830"></a>00830       <a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a> = 0;
<a name="l00831"></a>00831       <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a>++;
<a name="l00832"></a>00832       <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( TRUE ))
<a name="l00833"></a>00833          <span class="keywordflow">return</span> FALSE;
<a name="l00834"></a>00834    }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836    <span class="comment">//**** Read the value of the cluster</span>
<a name="l00837"></a>00837    LSB0( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+0];  <span class="comment">// FAT 16,32</span>
<a name="l00838"></a>00838    LSB1( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+1];  <span class="comment">// FAT 16,32</span>
<a name="l00839"></a>00839 
<a name="l00840"></a>00840    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00841"></a>00841    {  <span class="comment">// FAT 32</span>
<a name="l00842"></a>00842       LSB2( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+2];
<a name="l00843"></a>00843       LSB3( <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a> ) = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[<a class="code" href="a00017.html#87e7f1f24baa43d2924a1c55a0b3f76c">fs_g_u16_pos_fat</a>+3];
<a name="l00844"></a>00844    }
<a name="l00845"></a>00845    <span class="keywordflow">return</span> TRUE;
<a name="l00846"></a>00846 }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848 
<a name="l00862"></a><a class="code" href="a00018.html#4010dc2ad42864603bb81a41b485d346">00862</a> U8    <a class="code" href="a00017.html#4010dc2ad42864603bb81a41b485d346">fat_checkcluster</a>( <span class="keywordtype">void</span> )
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864    <span class="comment">//** Check the cluster is valid</span>
<a name="l00865"></a>00865    <span class="comment">// PS: Bad if (FAT12 &gt; 0x0FF6) (FAT16 &gt; 0xFFF6) (FAT32 &gt; 0x0FFFFFF6) or cluster null</span>
<a name="l00866"></a>00866    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#57a82f24a45a33a159e0362b7e82e3fa">Is_fat32</a> )
<a name="l00867"></a>00867    {
<a name="l00868"></a>00868       <span class="keywordflow">if</span> (  (0x0F != LSB3(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>))
<a name="l00869"></a>00869       ||    (0xFF != LSB2(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>))
<a name="l00870"></a>00870       ||    (0xFF != LSB1(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>)) )
<a name="l00871"></a>00871       {
<a name="l00872"></a>00872          <span class="keywordflow">return</span> <a class="code" href="a00018.html#e9f7cc865270a55859b36205dc45b284">FS_CLUS_OK</a>;
<a name="l00873"></a>00873       }
<a name="l00874"></a>00874    }
<a name="l00875"></a>00875    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#2dcd74d640da1e20ad510413c9ef4c85">Is_fat16</a> )
<a name="l00876"></a>00876    {
<a name="l00877"></a>00877       <span class="keywordflow">if</span> (0xFF != LSB1(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>))
<a name="l00878"></a>00878          <span class="keywordflow">return</span> <a class="code" href="a00018.html#e9f7cc865270a55859b36205dc45b284">FS_CLUS_OK</a>;
<a name="l00879"></a>00879    }
<a name="l00880"></a>00880    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#c2ce5473766316396fb472c1bdd685e9">Is_fat12</a> )
<a name="l00881"></a>00881    {
<a name="l00882"></a>00882       <span class="keywordflow">if</span> (0x0F != LSB1(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>))
<a name="l00883"></a>00883          <span class="keywordflow">return</span> <a class="code" href="a00018.html#e9f7cc865270a55859b36205dc45b284">FS_CLUS_OK</a>;
<a name="l00884"></a>00884    }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886    <span class="keywordflow">if</span> (LSB0(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>) == 0xFF)
<a name="l00887"></a>00887       <span class="keywordflow">return</span> <a class="code" href="a00018.html#186703da0d708086e4ceaae4a470467d">FS_CLUS_END</a>;
<a name="l00888"></a>00888    <span class="keywordflow">if</span> (LSB0(<a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#4f323a1ec38e3c0f1b57bf4fe07842b7">u32_val</a>) &gt; 0xF6 )
<a name="l00889"></a>00889       <span class="keywordflow">return</span> <a class="code" href="a00018.html#296001b537ea1cf21069172943e73e60">FS_CLUS_BAD</a>;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891    <span class="keywordflow">return</span> <a class="code" href="a00018.html#e9f7cc865270a55859b36205dc45b284">FS_CLUS_OK</a>;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 
<a name="l00897"></a><a class="code" href="a00018.html#ecb0d4c200bed41b8bdcf671aa931a2a">00897</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#ecb0d4c200bed41b8bdcf671aa931a2a">fat_cache_clusterlist_reset</a>( <span class="keywordtype">void</span> )
<a name="l00898"></a>00898 {
<a name="l00899"></a>00899 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST&gt;1)</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span>   U8 <a class="code" href="a00017.html#5985f32ca0a3714cb4b55abf404be10c">u8_i</a>;
<a name="l00901"></a>00901    <a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>=0;
<a name="l00902"></a>00902    <span class="keywordflow">for</span>( u8_i=0; u8_i&lt;<a class="code" href="a00014.html#ee9842c6b2f49d1bca72d0ad56e97502">FS_NB_CACHE_CLUSLIST</a>; u8_i++ )
<a name="l00903"></a>00903 #endif
<a name="l00904"></a>00904    {
<a name="l00905"></a>00905       <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].u8_lun = 0xFF;
<a name="l00906"></a>00906    }
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00911"></a><a class="code" href="a00017.html#0a4940852a79296a91956954760c293b">00911</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#0a4940852a79296a91956954760c293b">fat_cache_clusterlist_update_start</a>( <span class="keywordtype">void</span> )
<a name="l00912"></a>00912 {
<a name="l00913"></a>00913    <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9fbad8d6dc29d31a77b92c759ecfeba8">u8_lun</a>       = 0xFF;              <span class="comment">// unvalid cache</span>
<a name="l00914"></a>00914    <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#3993609419d886d6bbd71d4b1381d5d8">u32_cluster</a>  = <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>;
<a name="l00915"></a>00915    <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a>    = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00916"></a>00916 }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918 
<a name="l00921"></a><a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">00921</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">fat_cache_clusterlist_update_finish</a>( <span class="keywordtype">void</span> )
<a name="l00922"></a>00922 {
<a name="l00923"></a>00923    U8 u8_cluster_offset = <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a> % <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>;
<a name="l00924"></a>00924    <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9fbad8d6dc29d31a77b92c759ecfeba8">u8_lun</a>       = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>;  <span class="comment">// valid cache</span>
<a name="l00925"></a>00925    <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a>   -= u8_cluster_offset;
<a name="l00926"></a>00926    <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#4c7ff1bd6744c489ae810368e9c29370">u32_addr</a>     = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> - u8_cluster_offset;
<a name="l00927"></a>00927    <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#e6b4023e4165ec69fe73bd693adb709a">u32_size</a>     = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> + u8_cluster_offset;
<a name="l00928"></a>00928 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST&gt;1)</span>
<a name="l00929"></a>00929 <span class="preprocessor"></span>   <a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>++;
<a name="l00930"></a>00930    <span class="keywordflow">if</span>( <a class="code" href="a00014.html#ee9842c6b2f49d1bca72d0ad56e97502">FS_NB_CACHE_CLUSLIST</a> == <a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>)
<a name="l00931"></a>00931       <a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a> = 0;
<a name="l00932"></a>00932 <span class="preprocessor">#endif</span>
<a name="l00933"></a>00933 <span class="preprocessor"></span>}
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 
<a name="l00941"></a><a class="code" href="a00017.html#861947c267cdb98aeb66cbc61cb671d7">00941</a> Bool  <a class="code" href="a00017.html#861947c267cdb98aeb66cbc61cb671d7">fat_cache_clusterlist_update_read</a>( <span class="keywordtype">void</span> )
<a name="l00942"></a>00942 {
<a name="l00943"></a>00943    U32 u32_tmp;
<a name="l00944"></a>00944 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST&gt;1)</span>
<a name="l00945"></a>00945 <span class="preprocessor"></span>   U8 <a class="code" href="a00017.html#5985f32ca0a3714cb4b55abf404be10c">u8_i</a>;
<a name="l00946"></a>00946    <span class="keywordflow">for</span>( u8_i=0; u8_i&lt;<a class="code" href="a00014.html#ee9842c6b2f49d1bca72d0ad56e97502">FS_NB_CACHE_CLUSLIST</a>; u8_i++ )
<a name="l00947"></a>00947 #endif
<a name="l00948"></a>00948    {
<a name="l00949"></a>00949       <span class="keywordflow">if</span>(<a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].u8_lun == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l00950"></a>00950       {
<a name="l00951"></a>00951          <span class="keywordflow">if</span>( <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#3993609419d886d6bbd71d4b1381d5d8">u32_cluster</a> == <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a> )
<a name="l00952"></a>00952          {
<a name="l00953"></a>00953             <span class="keywordflow">if</span>( <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a> &lt;= <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> )
<a name="l00954"></a>00954             {
<a name="l00955"></a>00955                <span class="comment">// The segment research is in or after the cache</span>
<a name="l00956"></a>00956                <span class="keywordflow">if</span>( <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#e6b4023e4165ec69fe73bd693adb709a">u32_size</a>  &gt; (<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>-<a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a>) )
<a name="l00957"></a>00957                {
<a name="l00958"></a>00958                   <span class="comment">// The segment research is in cache, then compute the segment infos</span>
<a name="l00959"></a>00959                   <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> -= <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a>;
<a name="l00960"></a>00960                   <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#4c7ff1bd6744c489ae810368e9c29370">u32_addr</a> + <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00961"></a>00961                   <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#e6b4023e4165ec69fe73bd693adb709a">u32_size</a> - <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00962"></a>00962                   <span class="keywordflow">return</span> TRUE;   <span class="comment">// the segment is in cluster list cache</span>
<a name="l00963"></a>00963                }<span class="keywordflow">else</span>{
<a name="l00964"></a>00964                   <span class="comment">// It is after cache then read the following FAT</span>
<a name="l00965"></a>00965 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST&gt;1)</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span>                  <span class="comment">// store the resultat in this cache</span>
<a name="l00967"></a>00967                   <a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a> = u8_i;
<a name="l00968"></a>00968 <span class="preprocessor">#endif</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span>                  <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9fbad8d6dc29d31a77b92c759ecfeba8">u8_lun</a>       = 0xFF;              <span class="comment">// unvalid cache</span>
<a name="l00970"></a>00970                   <span class="comment">// fs_g_cache_clusterlist[fs_g_u8_current_cache].u32_cluster  = fs_g_cluster.u32_pos;  // It is the same cluster start</span>
<a name="l00971"></a>00971                   
<a name="l00972"></a>00972                   <span class="comment">// The segment research is after the cache, then compute data to speed the search in FAT</span>
<a name="l00973"></a>00973                   <span class="comment">// So, jump the currrent cache research</span>
<a name="l00974"></a>00974                   <span class="comment">// Compute the cluster number corresponding of last cluster of the cache list</span>
<a name="l00975"></a>00975                   <a class="code" href="a00018.html#f1ca07cf6181c8e6af3fa988a0b0539d">fs_g_cluster</a>.<a class="code" href="a00010.html#06879786792eeefd3b45527499ed1174">u32_pos</a>     = ((<a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#4c7ff1bd6744c489ae810368e9c29370">u32_addr</a> -<a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af1d8fda28bded48a54c7eab4d729618">u32_ptr_fat</a> - <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#d12585f4d1f75862d62ddcb9386b5d4d">u16_offset_data</a> + <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#e6b4023e4165ec69fe73bd693adb709a">u32_size</a> -1)
<a name="l00976"></a>00976                                              / <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>) +2;
<a name="l00977"></a>00977                   u32_tmp  = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;   <span class="comment">// save position ask</span>
<a name="l00978"></a>00978                   <span class="comment">// Compute the position in cluster list of the last cluster, and decrement position ask</span>
<a name="l00979"></a>00979                   <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>-= ((<a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a> + <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[u8_i].<a class="code" href="a00001.html#e6b4023e4165ec69fe73bd693adb709a">u32_size</a> -1)
<a name="l00980"></a>00980                                              / <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>)
<a name="l00981"></a>00981                                              * <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>;
<a name="l00982"></a>00982                   <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a> = u32_tmp;   <span class="comment">// Update cache with position ask</span>
<a name="l00983"></a>00983                   <span class="keywordflow">return</span> FALSE;   <span class="comment">// the segment isn't in cluster list cache</span>
<a name="l00984"></a>00984                }
<a name="l00985"></a>00985             }
<a name="l00986"></a>00986             <span class="keywordflow">else</span>
<a name="l00987"></a>00987             {
<a name="l00988"></a>00988 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST&gt;1)</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span>               <span class="comment">// Cache is out of position ask, then store the new resultat in this cache</span>
<a name="l00990"></a>00990                <a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a> = <a class="code" href="a00017.html#5985f32ca0a3714cb4b55abf404be10c">u8_i</a>;
<a name="l00991"></a>00991 <span class="preprocessor">#endif</span>
<a name="l00992"></a>00992 <span class="preprocessor"></span>               <a class="code" href="a00017.html#0a4940852a79296a91956954760c293b">fat_cache_clusterlist_update_start</a>();
<a name="l00993"></a>00993                <span class="keywordflow">return</span> FALSE;
<a name="l00994"></a>00994             }
<a name="l00995"></a>00995          }
<a name="l00996"></a>00996       }
<a name="l00997"></a>00997    }
<a name="l00998"></a>00998    <span class="comment">// No found in cache then read FAT and store the resultat in cache</span>
<a name="l00999"></a>00999    <a class="code" href="a00017.html#0a4940852a79296a91956954760c293b">fat_cache_clusterlist_update_start</a>();
<a name="l01000"></a>01000    <span class="keywordflow">return</span> FALSE;
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 <span class="comment">// To clean the code </span>
<a name="l01004"></a>01004 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST==1)</span>
<a name="l01005"></a>01005 <span class="preprocessor"></span><span class="preprocessor">#  undef u8_i</span>
<a name="l01006"></a>01006 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01007"></a>01007 <span class="preprocessor"></span>
<a name="l01008"></a>01008 
<a name="l01026"></a><a class="code" href="a00018.html#d8c9c9a63c821e8cea06c340c029668d">01026</a> Bool  <a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>( U8 mode )
<a name="l01027"></a>01027 {
<a name="l01028"></a>01028    U32   u32_sector_pos;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030    <span class="comment">// Compute sector position</span>
<a name="l01031"></a>01031    u32_sector_pos = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &gt;&gt; <a class="code" href="a00018.html#90491f94e13d340a9d3f98e57a66e9d3">FS_SHIFT_B_TO_SECTOR</a>;
<a name="l01032"></a>01032    
<a name="l01033"></a>01033    <span class="keywordflow">if</span>(<a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a>  == mode)
<a name="l01034"></a>01034    {
<a name="l01035"></a>01035       <span class="comment">// Check if the cache sorresponding of sector ask</span>
<a name="l01036"></a>01036       <span class="keywordflow">if</span>( (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a>                 == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l01037"></a>01037       &amp;&amp;  (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#9aba32679527ef002f0bbf18545108cf">u32_clusterlist_start</a>  == <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> )
<a name="l01038"></a>01038       &amp;&amp;  (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#0e983c43b8457d480b14ef77113df31f">u32_clusterlist_pos</a>    == u32_sector_pos ) )
<a name="l01039"></a>01039       {
<a name="l01040"></a>01040          <span class="keywordflow">return</span> TRUE;
<a name="l01041"></a>01041       }
<a name="l01042"></a>01042    }
<a name="l01043"></a>01043    <span class="keywordflow">else</span>
<a name="l01044"></a>01044    {
<a name="l01045"></a>01045       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == mode )                                         <span class="comment">// Clear action</span>
<a name="l01046"></a>01046       {
<a name="l01047"></a>01047          <span class="keywordflow">if</span>( 0 == <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> )
<a name="l01048"></a>01048             <span class="keywordflow">return</span> TRUE;   <span class="comment">// No cluster list is link with the file, no clear necessary</span>
<a name="l01049"></a>01049             
<a name="l01050"></a>01050          <span class="keywordflow">if</span>(0 != (<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &amp; <a class="code" href="a00018.html#7090b63e1693b160aaebf802dfd8e05a">FS_MASK_SIZE_OF_SECTOR</a>) )  <span class="comment">// Actual sector used</span>
<a name="l01051"></a>01051       {
<a name="l01052"></a>01052          <span class="comment">// If the actual sector is used, then start clear in the next sector</span>
<a name="l01053"></a>01053          u32_sector_pos++;
<a name="l01054"></a>01054       }
<a name="l01055"></a>01055    }
<a name="l01056"></a>01056    }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058    <span class="comment">// Get the segment which start at the current position</span>
<a name="l01059"></a>01059    <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>;
<a name="l01060"></a>01060    <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = u32_sector_pos;
<a name="l01061"></a>01061    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a> != mode )
<a name="l01062"></a>01062    {
<a name="l01063"></a>01063       <span class="keywordflow">if</span>( <a class="code" href="a00017.html#dd96ad16d133974463fd6a5c4bc8bd5f">fat_cluster_list</a>( mode ) )
<a name="l01064"></a>01064          <span class="keywordflow">return</span> TRUE;   <span class="comment">// Get or clear segment OK</span>
<a name="l01065"></a>01065    }
<a name="l01066"></a>01066    <span class="keywordflow">else</span>
<a name="l01067"></a>01067    {
<a name="l01068"></a>01068       <span class="keywordflow">if</span>( <a class="code" href="a00017.html#dd96ad16d133974463fd6a5c4bc8bd5f">fat_cluster_list</a>( <a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> ) )   <span class="comment">// Read all segment</span>
<a name="l01069"></a>01069       {
<a name="l01070"></a>01070          <span class="comment">// Read the sector corresponding at the position file (= first sector of segment)</span>
<a name="l01071"></a>01071          <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> ;
<a name="l01072"></a>01072          <span class="keywordflow">if</span>( <a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( TRUE ) )
<a name="l01073"></a>01073          {
<a name="l01074"></a>01074             <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#9aba32679527ef002f0bbf18545108cf">u32_clusterlist_start</a>  = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>;
<a name="l01075"></a>01075             <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#0e983c43b8457d480b14ef77113df31f">u32_clusterlist_pos</a>    = u32_sector_pos;
<a name="l01076"></a>01076             <span class="keywordflow">return</span> TRUE;
<a name="l01077"></a>01077          }
<a name="l01078"></a>01078       }
<a name="l01079"></a>01079    }
<a name="l01080"></a>01080    <span class="keywordflow">if</span>( (<a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> == mode       )
<a name="l01081"></a>01081    &amp;&amp;  (<a class="code" href="a00023.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a>  == <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a>) )
<a name="l01082"></a>01082    {
<a name="l01083"></a>01083       <span class="comment">// It is possible to clear nothing</span>
<a name="l01084"></a>01084       <span class="keywordflow">return</span> TRUE;
<a name="l01085"></a>01085    }
<a name="l01086"></a>01086    <span class="keywordflow">return</span> FALSE;
<a name="l01087"></a>01087 }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 
<a name="l01090"></a>01090 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l01108"></a><a class="code" href="a00018.html#8723a199c01163d9f9839bd42ac60693">01108</a> <span class="preprocessor">Bool  fat_write_file( U8 mode , U32 u32_nb_sector_write )</span>
<a name="l01109"></a>01109 <span class="preprocessor"></span>{
<a name="l01110"></a>01110    <span class="keywordflow">if</span>( 0 == <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> )
<a name="l01111"></a>01111    {
<a name="l01112"></a>01112       <span class="comment">// Alloc the first cluster list of the file</span>
<a name="l01113"></a>01113       MSB0(<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>)    = 0xFF;     <span class="comment">// It is a new cluster list</span>
<a name="l01114"></a>01114       <span class="comment">// Update cache</span>
<a name="l01115"></a>01115       <span class="comment">// fs_g_cluster.u32_pos    = ?         // To fill after alloc</span>
<a name="l01116"></a>01116       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>   = 0;
<a name="l01117"></a>01117       <a class="code" href="a00017.html#0a4940852a79296a91956954760c293b">fat_cache_clusterlist_update_start</a>();
<a name="l01118"></a>01118    }
<a name="l01119"></a>01119    <span class="keywordflow">else</span>
<a name="l01120"></a>01120    {
<a name="l01121"></a>01121       <span class="keywordflow">if</span>( <a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>( mode ) )
<a name="l01122"></a>01122          <span class="keywordflow">return</span> TRUE;     <span class="comment">// segment avialable</span>
<a name="l01123"></a>01123 
<a name="l01124"></a>01124       <span class="keywordflow">if</span>( <a class="code" href="a00023.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a> != <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l01125"></a>01125       {
<a name="l01126"></a>01126          <span class="keywordflow">return</span> FALSE; <span class="comment">// error access segment</span>
<a name="l01127"></a>01127       }
<a name="l01128"></a>01128       <span class="comment">// Update cache</span>
<a name="l01129"></a>01129       <span class="comment">// note: fat_read_file is OUT_LIST then current cluster list cache is on last cluster of list</span>
<a name="l01130"></a>01130       <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9fbad8d6dc29d31a77b92c759ecfeba8">u8_lun</a>       = 0xFF;                     <span class="comment">// unvalid cache</span>
<a name="l01131"></a>01131       <span class="comment">// fs_g_cache_clusterlist[fs_g_u8_current_cache].u32_cluster  = fs_g_cluster.u32_pos;  // it is the same</span>
<a name="l01132"></a>01132       <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#9b3cb7c527c5e7e02cc5f4e76fdcd90c">u32_start</a> += <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>; <span class="comment">// Position of next cluster (the first new)</span>
<a name="l01133"></a>01133    }
<a name="l01134"></a>01134    
<a name="l01135"></a>01135    <span class="comment">// It is outoff cluster list of file</span>
<a name="l01136"></a>01136    <span class="comment">// Alloc a cluster list to write a new data</span>
<a name="l01137"></a>01137    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == mode )
<a name="l01138"></a>01138    {
<a name="l01139"></a>01139       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = u32_nb_sector_write;
<a name="l01140"></a>01140    }<span class="keywordflow">else</span>{
<a name="l01141"></a>01141       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = 1;                                  <span class="comment">// only one sector</span>
<a name="l01142"></a>01142    }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    <span class="comment">//note: fs_g_seg.u32_addr is the the last cluster value return by fat_cluster_list</span>
<a name="l01145"></a>01145    <span class="keywordflow">if</span>( !<a class="code" href="a00018.html#1fa62b2728e71cff2e95556db7ed1b9c">fat_allocfreespace</a>())
<a name="l01146"></a>01146       <span class="keywordflow">return</span> FALSE;
<a name="l01147"></a>01147    <span class="comment">//note: fs_g_seg.u32_addr is the first cluster of the list alloc by alloc_free_space</span>
<a name="l01148"></a>01148    <span class="comment">//note: fs_g_seg.u32_size_or_pos number sector remaining</span>
<a name="l01149"></a>01149 
<a name="l01150"></a>01150    <span class="keywordflow">if</span>( 0 == <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> )  <span class="comment">// First list ?</span>
<a name="l01151"></a>01151    {
<a name="l01152"></a>01152       <span class="comment">// fs_g_seg.u32_addr = First cluster of the file return by alloc_free_space</span>
<a name="l01153"></a>01153       <a class="code" href="a00017.html#0954f67df10cbdf84a4e42ae740fe1c2">fs_g_cache_clusterlist</a>[<a class="code" href="a00017.html#d2ce80132a1ef14fb4f323675b3fa900">fs_g_u8_current_cache</a>].<a class="code" href="a00001.html#3993609419d886d6bbd71d4b1381d5d8">u32_cluster</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>;<span class="comment">// Update cache</span>
<a name="l01154"></a>01154       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>;                               <span class="comment">// Update file entry</span>
<a name="l01155"></a>01155    }
<a name="l01156"></a>01156    
<a name="l01157"></a>01157    <span class="comment">// Update cache</span>
<a name="l01158"></a>01158    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> == mode )
<a name="l01159"></a>01159    {
<a name="l01160"></a>01160       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = u32_nb_sector_write - <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l01161"></a>01161    }<span class="keywordflow">else</span>{
<a name="l01162"></a>01162       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = 1 - <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l01163"></a>01163    }
<a name="l01164"></a>01164    <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = ((<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> - 2) * <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>)
<a name="l01165"></a>01165                      + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af1d8fda28bded48a54c7eab4d729618">u32_ptr_fat</a> + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#d12585f4d1f75862d62ddcb9386b5d4d">u16_offset_data</a>;
<a name="l01166"></a>01166    <a class="code" href="a00017.html#2ae33c7eebc67cd4cf420593aa2c97d6">fat_cache_clusterlist_update_finish</a>();
<a name="l01167"></a>01167 
<a name="l01168"></a>01168    <span class="keywordflow">return</span> <a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>( mode );    <span class="comment">// load the new segment</span>
<a name="l01169"></a>01169 }
<a name="l01170"></a>01170 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01171"></a>01171 <span class="preprocessor"></span>
<a name="l01184"></a><a class="code" href="a00018.html#1a35321a99150ba643f87cb6c79ec3e5">01184</a> Bool  <a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>( <span class="keywordtype">void</span> )
<a name="l01185"></a>01185 {
<a name="l01186"></a>01186    U32 u32_cluster_pos;
<a name="l01187"></a>01187    <span class="comment">// Compute the cluster list position corresponding of the current entry</span>
<a name="l01188"></a>01188    u32_cluster_pos = <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> &gt;&gt; (<a class="code" href="a00018.html#90491f94e13d340a9d3f98e57a66e9d3">FS_SHIFT_B_TO_SECTOR</a> - <a class="code" href="a00018.html#f5a730740b41e20c1a467dcd1d52699f">FS_SHIFT_B_TO_FILE_ENTRY</a>);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190    <span class="comment">// Check if the cache sorresponding of segment ask</span>
<a name="l01191"></a>01191    <span class="keywordflow">if</span>( (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a>                 == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l01192"></a>01192    &amp;&amp;  (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#9aba32679527ef002f0bbf18545108cf">u32_clusterlist_start</a>  == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a> )
<a name="l01193"></a>01193    &amp;&amp;  (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#0e983c43b8457d480b14ef77113df31f">u32_clusterlist_pos</a>    == u32_cluster_pos ) )
<a name="l01194"></a>01194    {
<a name="l01195"></a>01195          <span class="keywordflow">return</span> TRUE;
<a name="l01196"></a>01196    }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198    <span class="comment">// Get segment corresponding at cluster list position</span>
<a name="l01199"></a>01199    <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a>;
<a name="l01200"></a>01200    <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = u32_cluster_pos;
<a name="l01201"></a>01201    <span class="keywordflow">if</span>(<a class="code" href="a00017.html#dd96ad16d133974463fd6a5c4bc8bd5f">fat_cluster_list</a>( <a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a> ) )
<a name="l01202"></a>01202    {
<a name="l01203"></a>01203       <span class="comment">// Read the sector corresponding at the entry file</span>
<a name="l01204"></a>01204       <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>;
<a name="l01205"></a>01205       <span class="keywordflow">if</span>( <a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( TRUE ) )
<a name="l01206"></a>01206       {
<a name="l01207"></a>01207          <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#9aba32679527ef002f0bbf18545108cf">u32_clusterlist_start</a>  = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a>;
<a name="l01208"></a>01208          <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#0e983c43b8457d480b14ef77113df31f">u32_clusterlist_pos</a>    = u32_cluster_pos;
<a name="l01209"></a>01209          <span class="keywordflow">return</span> TRUE;
<a name="l01210"></a>01210       }
<a name="l01211"></a>01211    }
<a name="l01212"></a>01212    <span class="keywordflow">return</span> FALSE;
<a name="l01213"></a>01213 }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215 
<a name="l01216"></a>01216 
<a name="l01231"></a><a class="code" href="a00018.html#ef13c743905d7e0381b3a461da2ebd7a">01231</a> Bool  <a class="code" href="a00017.html#ef13c743905d7e0381b3a461da2ebd7a">fat_entry_check</a>( Bool b_type ) 
<a name="l01232"></a>01232 {
<a name="l01233"></a>01233    <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> u8_ptr_entry;
<a name="l01234"></a>01234    U8 u8_first_byte, u8_seconde_byte;
<a name="l01235"></a>01235    U8 u8_attribut;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237    u8_ptr_entry = <a class="code" href="a00017.html#0c24a717d004b7194e2c566522348fd5">fat_get_ptr_entry</a>();
<a name="l01238"></a>01238 
<a name="l01239"></a>01239    u8_first_byte = u8_ptr_entry[0];
<a name="l01240"></a>01240    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#453bf57f059970b3ce13033b7959cb0c">FS_ENTRY_END</a> == u8_first_byte )
<a name="l01241"></a>01241    {
<a name="l01242"></a>01242       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#33817136df196a5f0146574b4e1775b6">FS_ERR_ENTRY_EMPTY</a>;   <span class="comment">// end of directory</span>
<a name="l01243"></a>01243       <span class="keywordflow">return</span> FALSE;
<a name="l01244"></a>01244    }
<a name="l01245"></a>01245    <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#934f48a8e1cb558d75ec00bbd242030d">FS_ERR_ENTRY_BAD</a>;        <span class="comment">// by default BAD ENTRY</span>
<a name="l01246"></a>01246    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#303c1237fa5a61ddc015c0365eedd008">FS_ENTRY_DEL</a> == u8_first_byte )      { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// entry deleted</span>
<a name="l01247"></a>01247    <span class="keywordflow">if</span> (   <span class="charliteral">'.'</span>  == u8_first_byte )            { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// current dir "."</span>
<a name="l01248"></a>01248    u8_seconde_byte = u8_ptr_entry[1];
<a name="l01249"></a>01249    <span class="keywordflow">if</span> ( (<span class="charliteral">'.'</span>  == u8_first_byte)
<a name="l01250"></a>01250    &amp;&amp;   (<span class="charliteral">'.'</span>  == u8_seconde_byte) )          { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// current dir ".."</span>
<a name="l01251"></a>01251 
<a name="l01252"></a>01252    <span class="comment">// Check attribut</span>
<a name="l01253"></a>01253    u8_attribut = u8_ptr_entry[11];
<a name="l01254"></a>01254    <span class="keywordflow">if</span> ( <a class="code" href="a00023.html#4ed995c53b13fcf1694ae3ba6da61eba">FS_ATTR_VOLUME_ID</a> &amp; u8_attribut )  { <span class="keywordflow">return</span> FALSE;   } <span class="comment">// volume id</span>
<a name="l01255"></a>01255    <span class="comment">// Optimization, this line isn't necessary because the next test control this case</span>
<a name="l01256"></a>01256    <span class="comment">// if ( FS_ATTR_LFN_ENTRY == *u8_ptr_entry) { return FALSE;   } // long file name</span>
<a name="l01257"></a>01257 
<a name="l01258"></a>01258    <span class="comment">// Check type of file</span>
<a name="l01259"></a>01259    <span class="keywordflow">if</span>( <a class="code" href="a00023.html#99004e3e756391a7ac1c4dde4db6864c">FS_ATTR_DIRECTORY</a> &amp; u8_attribut )
<a name="l01260"></a>01260    {
<a name="l01261"></a>01261       <span class="keywordflow">return</span> (<a class="code" href="a00023.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a> == b_type);
<a name="l01262"></a>01262    }<span class="keywordflow">else</span>{
<a name="l01263"></a>01263       <span class="keywordflow">return</span> (<a class="code" href="a00023.html#20f0a7ade1270e3923abafeb33864c55">FS_FILE</a> == b_type);
<a name="l01264"></a>01264    }
<a name="l01265"></a>01265 }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267 
<a name="l01282"></a><a class="code" href="a00018.html#d690d22df98e6c1fa927c38b1d1a0fae">01282</a> Bool  <a class="code" href="a00017.html#d690d22df98e6c1fa927c38b1d1a0fae">fat_entry_checkext</a>( <a class="code" href="a00023.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_filter )
<a name="l01283"></a>01283 {
<a name="l01284"></a>01284    <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> u8_ptr_entry;
<a name="l01285"></a>01285    U8 <a class="code" href="a00017.html#5985f32ca0a3714cb4b55abf404be10c">u8_i</a>, u8_filter_char, u8_entry_char;
<a name="l01286"></a>01286    
<a name="l01287"></a>01287    u8_ptr_entry = <a class="code" href="a00017.html#0c24a717d004b7194e2c566522348fd5">fat_get_ptr_entry</a>();
<a name="l01288"></a>01288    
<a name="l01289"></a>01289    <span class="comment">// Check the extension </span>
<a name="l01290"></a>01290    <span class="keywordflow">for</span>( u8_i=0 ; u8_i&lt;3 ; u8_i++)
<a name="l01291"></a>01291    {
<a name="l01292"></a>01292       u8_filter_char = *sz_filter;
<a name="l01293"></a>01293       <span class="keywordflow">if</span> (<span class="charliteral">'*'</span> == u8_filter_char)
<a name="l01294"></a>01294          <span class="keywordflow">break</span>; <span class="comment">// All extension is good</span>
<a name="l01295"></a>01295          
<a name="l01296"></a>01296       u8_entry_char = u8_ptr_entry[8+u8_i]; 
<a name="l01297"></a>01297       
<a name="l01298"></a>01298       <span class="comment">// Check the filter and extension file (this one ignore the case)</span>
<a name="l01299"></a>01299       <span class="keywordflow">if</span>( (u8_filter_char!=  u8_entry_char     )
<a name="l01300"></a>01300       &amp;&amp;  (u8_filter_char!= (u8_entry_char+(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) )
<a name="l01301"></a>01301       {
<a name="l01302"></a>01302          <span class="keywordflow">if</span> ( (<span class="charliteral">','</span> == u8_filter_char)
<a name="l01303"></a>01303          ||   ( 0  == u8_filter_char) )
<a name="l01304"></a>01304          {  
<a name="l01305"></a>01305            <span class="comment">// end of filter</span>
<a name="l01306"></a>01306            <span class="keywordflow">if</span> (<span class="charliteral">' '</span> == u8_entry_char)
<a name="l01307"></a>01307               <span class="keywordflow">break</span>; <span class="comment">// it is the end of extension file -&gt; extension good</span>
<a name="l01308"></a>01308          }
<a name="l01309"></a>01309          <span class="comment">// here, bad extension</span>
<a name="l01310"></a>01310 
<a name="l01311"></a>01311          <span class="comment">// find the next filter</span>
<a name="l01312"></a>01312          <span class="keywordflow">while</span>( <span class="charliteral">','</span> != u8_filter_char )
<a name="l01313"></a>01313          {
<a name="l01314"></a>01314             <span class="keywordflow">if</span> (0  == u8_filter_char)
<a name="l01315"></a>01315             {
<a name="l01316"></a>01316                <span class="keywordflow">return</span> FALSE;   <span class="comment">// it is the last filter</span>
<a name="l01317"></a>01317             }
<a name="l01318"></a>01318             sz_filter++;
<a name="l01319"></a>01319             u8_filter_char = *sz_filter;
<a name="l01320"></a>01320          }
<a name="l01321"></a>01321          u8_i = 0xFF;          <span class="comment">// restart at the beginning of extension</span>
<a name="l01322"></a>01322       }
<a name="l01323"></a>01323       sz_filter++; <span class="comment">// go to next char of filter</span>
<a name="l01324"></a>01324    }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326    <span class="keywordflow">return</span> TRUE; <span class="comment">// It is a good file searched</span>
<a name="l01327"></a>01327 }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329 
<a name="l01341"></a><a class="code" href="a00018.html#56b68ed36f194500ce88c22252e3c317">01341</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#56b68ed36f194500ce88c22252e3c317">fat_get_entry_info</a>( <span class="keywordtype">void</span> )
<a name="l01342"></a>01342 {
<a name="l01343"></a>01343    <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01344"></a>01344 
<a name="l01345"></a>01345    ptr_entry = <a class="code" href="a00017.html#0c24a717d004b7194e2c566522348fd5">fat_get_ptr_entry</a>();
<a name="l01346"></a>01346 
<a name="l01347"></a>01347    <span class="comment">// Get the attribut of the entry file stored in global buffer "fs_g_sector"</span>
<a name="l01348"></a>01348    ptr_entry+= 11;
<a name="l01349"></a>01349    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a> = ptr_entry[0];
<a name="l01350"></a>01350 
<a name="l01351"></a>01351    <span class="comment">// Get the cluster of the entry file stored in global buffer "fs_g_sector"</span>
<a name="l01352"></a>01352    ptr_entry += (20-11);
<a name="l01353"></a>01353    LSB2(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>) = ptr_entry[0];
<a name="l01354"></a>01354    LSB3(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>) = ptr_entry[1];
<a name="l01355"></a>01355    ptr_entry += (26-20);
<a name="l01356"></a>01356    LSB0(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>) = ptr_entry[0];
<a name="l01357"></a>01357    LSB1(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>) = ptr_entry[1];
<a name="l01358"></a>01358 
<a name="l01359"></a>01359    <span class="comment">// Get the size of the entry file stored in global buffer "fs_g_sector"</span>
<a name="l01360"></a>01360    ptr_entry += (28-26);
<a name="l01361"></a>01361    LSB0(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>) = ptr_entry[0];
<a name="l01362"></a>01362    LSB1(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>) = ptr_entry[1];
<a name="l01363"></a>01363    LSB2(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>) = ptr_entry[2];
<a name="l01364"></a>01364    LSB3(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>) = ptr_entry[3];
<a name="l01365"></a>01365 }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367 
<a name="l01373"></a><a class="code" href="a00018.html#e0caae1c6e4a737af4ad0aa5d4171e79">01373</a> Bool  <a class="code" href="a00017.html#e0caae1c6e4a737af4ad0aa5d4171e79">fat_entry_is_dir</a>(<span class="keywordtype">void</span>)
<a name="l01374"></a>01374 {
<a name="l01375"></a>01375    <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#4374de2d1b7c653404d71d049b963e10">FS_ERR_NO_DIR</a>;   <span class="comment">// By default the error is "It isn't a directory"</span>
<a name="l01376"></a>01376    <span class="keywordflow">return</span> (<a class="code" href="a00023.html#99004e3e756391a7ac1c4dde4db6864c">FS_ATTR_DIRECTORY</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>);
<a name="l01377"></a>01377 }
<a name="l01378"></a>01378 
<a name="l01379"></a>01379 
<a name="l01382"></a><a class="code" href="a00018.html#56d9a210bc2d4b0b5c46cb24a2e9f690">01382</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#56d9a210bc2d4b0b5c46cb24a2e9f690">fat_clear_entry_info_and_ptr</a>( <span class="keywordtype">void</span> )
<a name="l01383"></a>01383 {
<a name="l01384"></a>01384    <span class="comment">// No file selected and reset navigation</span>
<a name="l01385"></a>01385    <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>= <a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a>;
<a name="l01386"></a>01386    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>           = <a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a>;
<a name="l01387"></a>01387    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a>                 = <a class="code" href="a00023.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a>;
<a name="l01388"></a>01388    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>     = 0;
<a name="l01389"></a>01389    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> = 0;
<a name="l01390"></a>01390    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>    = 0;
<a name="l01391"></a>01391    <a class="code" href="a00018.html#8e3b3ddad0e2b4f1747507a2665b0901">Fat_file_close</a>;
<a name="l01392"></a>01392 }
<a name="l01393"></a>01393 
<a name="l01394"></a>01394 
<a name="l01395"></a>01395 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l01407"></a><a class="code" href="a00018.html#40035dc41d435ed3281155cdf800cf02">01407</a> <span class="preprocessor">void  fat_write_entry_file( void )</span>
<a name="l01408"></a>01408 <span class="preprocessor"></span>{
<a name="l01409"></a>01409    <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411    <a class="code" href="a00017.html#e73cb496ddbf1ab33944f99f1c50f4d0">fat_cache_sector_is_modify</a>();
<a name="l01412"></a>01412    ptr_entry = <a class="code" href="a00017.html#0c24a717d004b7194e2c566522348fd5">fat_get_ptr_entry</a>();
<a name="l01413"></a>01413 
<a name="l01414"></a>01414    <span class="keywordflow">if</span>( !(<a class="code" href="a00023.html#99004e3e756391a7ac1c4dde4db6864c">FS_ATTR_DIRECTORY</a> | <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>))
<a name="l01415"></a>01415    {
<a name="l01416"></a>01416       <span class="keywordflow">if</span>( 0 == <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> )
<a name="l01417"></a>01417          <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> = 0;
<a name="l01418"></a>01418    }
<a name="l01419"></a>01419 
<a name="l01421"></a>01421    ptr_entry+= 11;
<a name="l01422"></a>01422    ptr_entry[0] = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424    <span class="comment">// Write the cluster of the entry file stored in global buffer "fs_g_sector"</span>
<a name="l01425"></a>01425    ptr_entry += (20-11);
<a name="l01426"></a>01426    ptr_entry[0] = LSB2(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>);
<a name="l01427"></a>01427    ptr_entry[1] = LSB3(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>);
<a name="l01428"></a>01428    ptr_entry += (26-20);
<a name="l01429"></a>01429    ptr_entry[0] = LSB0(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>);
<a name="l01430"></a>01430    ptr_entry[1] = LSB1(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>);
<a name="l01431"></a>01431 
<a name="l01433"></a>01433    ptr_entry += (28-26);
<a name="l01434"></a>01434    ptr_entry[0] = LSB0(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>);
<a name="l01435"></a>01435    ptr_entry[1] = LSB1(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>);
<a name="l01436"></a>01436    ptr_entry[2] = LSB2(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>);
<a name="l01437"></a>01437    ptr_entry[3] = LSB3(<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>);
<a name="l01438"></a>01438 }
<a name="l01439"></a>01439 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01440"></a>01440 <span class="preprocessor"></span>
<a name="l01461"></a><a class="code" href="a00018.html#6bc798e9f4eac3457cc61e9cd9ba70b9">01461</a> Bool  <a class="code" href="a00017.html#6bc798e9f4eac3457cc61e9cd9ba70b9">fat_entry_shortname</a>( <a class="code" href="a00023.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_name , U8 u8_size_max , Bool b_mode )
<a name="l01462"></a>01462 {
<a name="l01463"></a>01463    Bool b_extension_nostart = TRUE;
<a name="l01464"></a>01464    U8 u8_pos_name;
<a name="l01465"></a>01465    U8 u8_entry_char, u8_szname_char;
<a name="l01466"></a>01466    <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01467"></a>01467    U8 u8_pos_entry;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469    <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#5ea145bbe1eb7413020b5e6b6f12a1ba">FS_ERR_NAME_INCORRECT</a>;  <span class="comment">// by default the name don't corresponding at filter name</span>
<a name="l01470"></a>01470 
<a name="l01471"></a>01471    u8_pos_name = 0;
<a name="l01472"></a>01472    u8_pos_entry = 0;
<a name="l01473"></a>01473    ptr_entry = <a class="code" href="a00017.html#0c24a717d004b7194e2c566522348fd5">fat_get_ptr_entry</a>();
<a name="l01474"></a>01474 
<a name="l01475"></a>01475    <span class="comment">// for all short name entry</span>
<a name="l01476"></a>01476    <span class="keywordflow">while</span>( 1 )
<a name="l01477"></a>01477    {  
<a name="l01478"></a>01478       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#69da5456f1f42a68c03ac860e33ac75b">FS_SIZE_SFNAME</a> == u8_pos_entry )
<a name="l01479"></a>01479       {  <span class="comment">// end of name</span>
<a name="l01480"></a>01480          u8_entry_char = 0;
<a name="l01481"></a>01481       }
<a name="l01482"></a>01482       <span class="keywordflow">else</span>
<a name="l01483"></a>01483       {
<a name="l01484"></a>01484          u8_entry_char = ptr_entry[ u8_pos_entry ];
<a name="l01485"></a>01485          <span class="keywordflow">if</span>( ((<a class="code" href="a00018.html#18e4c969985c697213c58a67e7c20795">FS_SIZE_SFNAME_WITHOUT_EXT</a> == u8_pos_entry) &amp;&amp; b_extension_nostart)  <span class="comment">// position of extension and extension '.' no write</span>
<a name="l01486"></a>01486          ||  ( <span class="charliteral">' '</span> == u8_entry_char) )
<a name="l01487"></a>01487          {  
<a name="l01488"></a>01488             <span class="comment">// end of name or extension</span>
<a name="l01489"></a>01489             <span class="keywordflow">if</span>( (<a class="code" href="a00018.html#18e4c969985c697213c58a67e7c20795">FS_SIZE_SFNAME_WITHOUT_EXT</a> &gt;= u8_pos_entry)         <span class="comment">// end of name without extension</span>
<a name="l01490"></a>01490             &amp;&amp;  (<span class="charliteral">' '</span> != ptr_entry[ <a class="code" href="a00018.html#18e4c969985c697213c58a67e7c20795">FS_SIZE_SFNAME_WITHOUT_EXT</a> ]) )   <span class="comment">// extension existe</span>
<a name="l01491"></a>01491             {
<a name="l01492"></a>01492                <span class="comment">// go to extension position</span>
<a name="l01493"></a>01493                b_extension_nostart = FALSE;
<a name="l01494"></a>01494                u8_pos_entry = FS_SIZE_SFNAME_WITHOUT_EXT-1;
<a name="l01495"></a>01495                u8_entry_char = <span class="charliteral">'.'</span>;
<a name="l01496"></a>01496             }
<a name="l01497"></a>01497             <span class="keywordflow">else</span>
<a name="l01498"></a>01498             {  <span class="comment">// end of name</span>
<a name="l01499"></a>01499                u8_entry_char = 0;
<a name="l01500"></a>01500             }
<a name="l01501"></a>01501          }
<a name="l01502"></a>01502       }
<a name="l01503"></a>01503 
<a name="l01504"></a>01504       <span class="keywordflow">if</span>( <a class="code" href="a00023.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode )
<a name="l01505"></a>01505       {
<a name="l01506"></a>01506          <span class="keywordflow">if</span>(u8_pos_name &gt;= (u8_size_max-1))
<a name="l01507"></a>01507             u8_entry_char = 0; <span class="comment">// buffer full then force end of string</span>
<a name="l01508"></a>01508 
<a name="l01509"></a>01509          <span class="keywordflow">if</span>( (<span class="charliteral">'A'</span>&lt;=u8_entry_char) &amp;&amp; (u8_entry_char&lt;=<span class="charliteral">'Z'</span>))
<a name="l01510"></a>01510             u8_entry_char += (<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>);   <span class="comment">// display short name in down case</span>
<a name="l01511"></a>01511             
<a name="l01512"></a>01512          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01513"></a>01513          {
<a name="l01514"></a>01514             ((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = u8_entry_char;
<a name="l01515"></a>01515          }<span class="keywordflow">else</span>{
<a name="l01516"></a>01516             sz_name[0] = u8_entry_char;
<a name="l01517"></a>01517          }
<a name="l01518"></a>01518       }
<a name="l01519"></a>01519       <span class="keywordflow">else</span>
<a name="l01520"></a>01520       {
<a name="l01521"></a>01521          <span class="comment">// Check the name</span>
<a name="l01522"></a>01522          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> 
<a name="l01523"></a>01523          &amp;&amp; (0 != MSB(((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0])) )
<a name="l01524"></a>01524          {
<a name="l01525"></a>01525             <span class="comment">// the UNICODE not possible in shortname</span>
<a name="l01526"></a>01526             <span class="keywordflow">return</span> FALSE; <span class="comment">// File entry without the filter condition</span>
<a name="l01527"></a>01527          }
<a name="l01528"></a>01528         
<a name="l01529"></a>01529          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01530"></a>01530          {
<a name="l01531"></a>01531             u8_szname_char = ((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0];
<a name="l01532"></a>01532          }<span class="keywordflow">else</span>{
<a name="l01533"></a>01533             u8_szname_char = sz_name[0];
<a name="l01534"></a>01534          }
<a name="l01535"></a>01535          <span class="keywordflow">if</span> (<span class="charliteral">'*'</span> == u8_szname_char)
<a name="l01536"></a>01536          {  <span class="comment">// end of filter name with autorise all next UNICODE</span>
<a name="l01537"></a>01537             <span class="keywordflow">return</span> TRUE;   <span class="comment">//*** The name is correct ***</span>
<a name="l01538"></a>01538          }
<a name="l01539"></a>01539         
<a name="l01540"></a>01540          <span class="keywordflow">if</span>( (0 != u8_entry_char) || ((<span class="charliteral">'\\'</span> != u8_szname_char) &amp;&amp; (<span class="charliteral">'/'</span> != u8_szname_char)) )
<a name="l01541"></a>01541          {
<a name="l01542"></a>01542             <span class="keywordflow">if</span>((u8_szname_char != u8_entry_char)
<a name="l01543"></a>01543             &amp;&amp; (u8_szname_char != (u8_entry_char+(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) )  <span class="comment">// no case sensitive</span>
<a name="l01544"></a>01544                <span class="keywordflow">return</span> FALSE; <span class="comment">// File entry without the filter condition</span>
<a name="l01545"></a>01545          }
<a name="l01546"></a>01546       }
<a name="l01547"></a>01547 
<a name="l01548"></a>01548       <span class="comment">// For each character</span>
<a name="l01549"></a>01549       <span class="keywordflow">if</span> (0 == u8_entry_char)
<a name="l01550"></a>01550         <span class="keywordflow">return</span> TRUE; <span class="comment">// End of test correct or end of get name</span>
<a name="l01551"></a>01551 
<a name="l01552"></a>01552       sz_name += (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01553"></a>01553       u8_pos_name++;
<a name="l01554"></a>01554       u8_pos_entry++;
<a name="l01555"></a>01555    }   
<a name="l01556"></a>01556 }
<a name="l01557"></a>01557 
<a name="l01558"></a>01558 
<a name="l01581"></a><a class="code" href="a00018.html#c0bdbd911ecf04b3fcebbc2e4ae33166">01581</a> Bool  <a class="code" href="a00017.html#c0bdbd911ecf04b3fcebbc2e4ae33166">fat_entry_longname</a>( <a class="code" href="a00023.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_name , U8 u8_size_max , Bool b_mode , Bool b_match_case )
<a name="l01582"></a>01582 {
<a name="l01583"></a>01583    U8 u8_pos_name;
<a name="l01584"></a>01584    <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> ptr_entry;
<a name="l01585"></a>01585    U16 u16_unicode_entry;
<a name="l01586"></a>01586    U16 u16_unicode_szname;
<a name="l01587"></a>01587    
<a name="l01588"></a>01588    ptr_entry = <a class="code" href="a00017.html#0c24a717d004b7194e2c566522348fd5">fat_get_ptr_entry</a>();
<a name="l01589"></a>01589 
<a name="l01590"></a>01590    <span class="keywordflow">if</span>( (<a class="code" href="a00018.html#453bf57f059970b3ce13033b7959cb0c">FS_ENTRY_END</a> == *ptr_entry )            <span class="comment">// end of directory</span>
<a name="l01591"></a>01591    ||  (<a class="code" href="a00018.html#303c1237fa5a61ddc015c0365eedd008">FS_ENTRY_DEL</a> == *ptr_entry )            <span class="comment">// entry deleted</span>
<a name="l01592"></a>01592    ||  (<a class="code" href="a00023.html#1aa64d79e89a455b62036d2230fd718d">FS_ATTR_LFN_ENTRY</a> != ptr_entry[11]) )   <span class="comment">// not long file name</span>
<a name="l01593"></a>01593    {
<a name="l01594"></a>01594       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#934f48a8e1cb558d75ec00bbd242030d">FS_ERR_ENTRY_BAD</a>;
<a name="l01595"></a>01595       <span class="keywordflow">return</span> FALSE;
<a name="l01596"></a>01596    }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598    ptr_entry++; <span class="comment">// The long name start at offset 1 of the entry file</span>
<a name="l01599"></a>01599 
<a name="l01600"></a>01600    u8_pos_name=0;
<a name="l01601"></a>01601    <span class="keywordflow">while</span>( 1 )
<a name="l01602"></a>01602    {
<a name="l01603"></a>01603       LSB(u16_unicode_entry) = ptr_entry[0];
<a name="l01604"></a>01604       MSB(u16_unicode_entry) = ptr_entry[1];
<a name="l01605"></a>01605       <span class="keywordflow">if</span>( <a class="code" href="a00023.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode )
<a name="l01606"></a>01606       {
<a name="l01607"></a>01607          <span class="comment">// Check the end of buffer</span>
<a name="l01608"></a>01608          <span class="keywordflow">if</span>( u8_pos_name&gt;=(u8_size_max-1) )
<a name="l01609"></a>01609          {
<a name="l01610"></a>01610             <span class="comment">// Write end of string UNICODE</span>
<a name="l01611"></a>01611             <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01612"></a>01612             {
<a name="l01613"></a>01613                ((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = 0;
<a name="l01614"></a>01614             }<span class="keywordflow">else</span>{
<a name="l01615"></a>01615                sz_name[0] = 0;
<a name="l01616"></a>01616             }
<a name="l01617"></a>01617             <span class="keywordflow">return</span> TRUE;   <span class="comment">// the buffer is full</span>
<a name="l01618"></a>01618          }
<a name="l01619"></a>01619          <span class="comment">// Read and store the unicode of name</span>
<a name="l01620"></a>01620          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01621"></a>01621          {
<a name="l01622"></a>01622             ((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = u16_unicode_entry;
<a name="l01623"></a>01623          }<span class="keywordflow">else</span>{
<a name="l01624"></a>01624             sz_name[0] = (U8)u16_unicode_entry;
<a name="l01625"></a>01625          }
<a name="l01626"></a>01626       }
<a name="l01627"></a>01627       <span class="keywordflow">else</span>
<a name="l01628"></a>01628       {
<a name="l01629"></a>01629          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01630"></a>01630          {
<a name="l01631"></a>01631             u16_unicode_szname = ((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0];
<a name="l01632"></a>01632          }<span class="keywordflow">else</span>{
<a name="l01633"></a>01633             u16_unicode_szname = sz_name[0];
<a name="l01634"></a>01634          }
<a name="l01635"></a>01635          <span class="comment">// Check the name</span>
<a name="l01636"></a>01636          <span class="keywordflow">if</span>( <span class="charliteral">'*'</span> == u16_unicode_szname )
<a name="l01637"></a>01637          {  <span class="comment">// end of filter name with autorise all next UNICODE</span>
<a name="l01638"></a>01638             <span class="keywordflow">return</span> TRUE;   <span class="comment">//*** The name is correct ***</span>
<a name="l01639"></a>01639          }
<a name="l01640"></a>01640          
<a name="l01641"></a>01641          <span class="keywordflow">if</span>( ((0 != u16_unicode_entry ) || (( <span class="charliteral">'\\'</span> != u16_unicode_szname) &amp;&amp; ( <span class="charliteral">'/'</span> != u16_unicode_szname)) )
<a name="l01642"></a>01642          &amp;&amp;  ((u16_unicode_szname != (u16_unicode_entry+(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) || b_match_case)
<a name="l01643"></a>01643          &amp;&amp;  ((u16_unicode_szname != (u16_unicode_entry-(<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>))) || b_match_case)
<a name="l01644"></a>01644          &amp;&amp;  (u16_unicode_szname != u16_unicode_entry) )
<a name="l01645"></a>01645          {
<a name="l01646"></a>01646            <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#5ea145bbe1eb7413020b5e6b6f12a1ba">FS_ERR_NAME_INCORRECT</a>;   <span class="comment">//  The name don't corresponding at filter name</span>
<a name="l01647"></a>01647            <span class="keywordflow">return</span> FALSE;
<a name="l01648"></a>01648          }
<a name="l01649"></a>01649       }
<a name="l01650"></a>01650 
<a name="l01651"></a>01651       <span class="keywordflow">if</span>( 0 == u16_unicode_entry)
<a name="l01652"></a>01652         <span class="keywordflow">return</span> TRUE;  <span class="comment">// Last long file name entry</span>
<a name="l01653"></a>01653 
<a name="l01654"></a>01654       <span class="keywordflow">if</span>( 4 == u8_pos_name )
<a name="l01655"></a>01655          ptr_entry += 3; <span class="comment">// Go to second name</span>
<a name="l01656"></a>01656 
<a name="l01657"></a>01657       <span class="keywordflow">if</span>( 10 == u8_pos_name )
<a name="l01658"></a>01658          ptr_entry += 2; <span class="comment">// Go to third name</span>
<a name="l01659"></a>01659 
<a name="l01660"></a>01660       <span class="keywordflow">if</span>( 12 == u8_pos_name )
<a name="l01661"></a>01661       {  <span class="comment">// End of entry long name</span>
<a name="l01662"></a>01662          ptr_entry -= (<a class="code" href="a00018.html#0ff67916e073882d162d5fbac91d7e50">FS_SIZE_FILE_ENTRY</a>-2); <span class="comment">// Go to the first byte of the entry file</span>
<a name="l01663"></a>01663          <span class="keywordflow">if</span> ( 0 == (<a class="code" href="a00018.html#bf0fa999d28907c3742656b6407aca78">FS_ENTRY_LFN_LAST</a> &amp; ptr_entry[0]))
<a name="l01664"></a>01664          {
<a name="l01665"></a>01665             <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#2dad540bd4ed9c78eff34ba269371d8d">FS_NO_LAST_LFN_ENTRY</a>;
<a name="l01666"></a>01666             <span class="keywordflow">return</span> FALSE; <span class="comment">// Other entry long name</span>
<a name="l01667"></a>01667          }
<a name="l01668"></a>01668          <span class="keywordflow">else</span>
<a name="l01669"></a>01669          {  <span class="comment">// It is the last long file name entry</span>
<a name="l01670"></a>01670             <span class="comment">// then it is the end of name</span>
<a name="l01671"></a>01671             sz_name += (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01672"></a>01672             <span class="keywordflow">if</span>( <a class="code" href="a00023.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode )
<a name="l01673"></a>01673             {
<a name="l01674"></a>01674                <span class="comment">// Write end of string UNICODE</span>
<a name="l01675"></a>01675                <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01676"></a>01676                {
<a name="l01677"></a>01677                   ((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0] = 0;
<a name="l01678"></a>01678                }<span class="keywordflow">else</span>{
<a name="l01679"></a>01679                   sz_name[0] = 0;
<a name="l01680"></a>01680                }
<a name="l01681"></a>01681                <span class="keywordflow">return</span> TRUE;  
<a name="l01682"></a>01682             }
<a name="l01683"></a>01683             <span class="keywordflow">else</span>
<a name="l01684"></a>01684             {  <span class="comment">// if it is the end of filter then return TRUE</span>
<a name="l01685"></a>01685                <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01686"></a>01686                {
<a name="l01687"></a>01687                   u16_unicode_szname = ((<a class="code" href="a00023.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_name)[0];
<a name="l01688"></a>01688                }<span class="keywordflow">else</span>{
<a name="l01689"></a>01689                   u16_unicode_szname = sz_name[0];
<a name="l01690"></a>01690                }
<a name="l01691"></a>01691                <span class="keywordflow">return</span> <a class="code" href="a00017.html#452e159ed5e2a4d8ea88f0515a3a6e10">fat_check_eof_name</a>(u16_unicode_szname);
<a name="l01692"></a>01692             }
<a name="l01693"></a>01693          }
<a name="l01694"></a>01694       }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696       sz_name += (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01697"></a>01697       u8_pos_name++;
<a name="l01698"></a>01698       ptr_entry+=2;
<a name="l01699"></a>01699    }
<a name="l01700"></a>01700 }
<a name="l01701"></a>01701 
<a name="l01702"></a>01702 
<a name="l01710"></a><a class="code" href="a00018.html#452e159ed5e2a4d8ea88f0515a3a6e10">01710</a> Bool  <a class="code" href="a00017.html#452e159ed5e2a4d8ea88f0515a3a6e10">fat_check_eof_name</a>( U16 character )
<a name="l01711"></a>01711 {
<a name="l01712"></a>01712    <span class="keywordflow">return</span> ((<span class="charliteral">'\0'</span>==character)||(<span class="charliteral">'\\'</span>==character)||(<span class="charliteral">'/'</span>==character));
<a name="l01713"></a>01713 }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715 
<a name="l01720"></a><a class="code" href="a00018.html#0c24a717d004b7194e2c566522348fd5">01720</a> <a class="code" href="a00018.html#119f57abfa3b1f77fd0514b26da6afb4">PTR_CACHE</a> <a class="code" href="a00017.html#0c24a717d004b7194e2c566522348fd5">fat_get_ptr_entry</a>( <span class="keywordtype">void</span> )
<a name="l01721"></a>01721 {
<a name="l01722"></a>01722    <span class="keywordflow">return</span> &amp;<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[(<a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> * <a class="code" href="a00018.html#0ff67916e073882d162d5fbac91d7e50">FS_SIZE_FILE_ENTRY</a>) &amp; <a class="code" href="a00018.html#7090b63e1693b160aaebf802dfd8e05a">FS_MASK_SIZE_OF_SECTOR</a>];
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724 
<a name="l01725"></a>01725 
<a name="l01726"></a>01726 
<a name="l01742"></a><a class="code" href="a00018.html#a67dc439478853cefdd226f9c99c9539">01742</a> Bool  <a class="code" href="a00017.html#a67dc439478853cefdd226f9c99c9539">fat_cache_read_sector</a>( Bool b_load )
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744    <span class="comment">// Check if the sector asked is the same that the sector in fs_g_sector</span>
<a name="l01745"></a>01745    <span class="keywordflow">if</span>( (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a>     == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l01746"></a>01746    &amp;&amp;  (<a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#fe852c5721ec70a1942bcebca4e370c9">u32_addr</a>   == <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a> ) )
<a name="l01747"></a>01747    {
<a name="l01748"></a>01748       <span class="keywordflow">return</span> TRUE;
<a name="l01749"></a>01749    }
<a name="l01750"></a>01750 
<a name="l01751"></a>01751    <span class="comment">// Write cache before fill cache with a new sector</span>
<a name="l01752"></a>01752    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>())
<a name="l01753"></a>01753       <span class="keywordflow">return</span> FALSE;
<a name="l01754"></a>01754    
<a name="l01755"></a>01755    <span class="comment">// Delete informations about the caches</span>
<a name="l01756"></a>01756    <a class="code" href="a00017.html#961692919a93b6cb714ec2a3d57c0141">fat_cache_reset</a>();
<a name="l01757"></a>01757    
<a name="l01758"></a>01758    <span class="comment">// save the information sector of the new cache</span>
<a name="l01759"></a>01759    <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#fe852c5721ec70a1942bcebca4e370c9">u32_addr</a> = <a class="code" href="a00018.html#8e617688fc42b47e56cce053123fd05f">fs_gu32_addrsector</a>;
<a name="l01760"></a>01760 
<a name="l01761"></a>01761    <span class="keywordflow">if</span>( b_load )
<a name="l01762"></a>01762    {
<a name="l01763"></a>01763       <span class="comment">// Load the sector from memory</span>
<a name="l01764"></a>01764       <span class="keywordflow">if</span>( <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> != <a class="code" href="a00015.html#dde05eb39b542eb5a7d3f78cf7006f28">memory_2_ram</a>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>  , <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#fe852c5721ec70a1942bcebca4e370c9">u32_addr</a>, <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>))
<a name="l01765"></a>01765       {
<a name="l01766"></a>01766          <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#cf37e5255ee1dbfaab77def32a7cbbef">FS_ERR_HW</a>;
<a name="l01767"></a>01767          <span class="keywordflow">return</span> FALSE;
<a name="l01768"></a>01768       }
<a name="l01769"></a>01769    }
<a name="l01770"></a>01770    <span class="comment">// save the information lun of the new cache</span>
<a name="l01771"></a>01771    <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>;
<a name="l01772"></a>01772    <span class="keywordflow">return</span> TRUE;
<a name="l01773"></a>01773 }
<a name="l01774"></a>01774 
<a name="l01775"></a>01775 
<a name="l01778"></a><a class="code" href="a00018.html#961692919a93b6cb714ec2a3d57c0141">01778</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#961692919a93b6cb714ec2a3d57c0141">fat_cache_reset</a>( <span class="keywordtype">void</span> )
<a name="l01779"></a>01779 {
<a name="l01780"></a>01780    <span class="comment">// Delete informations about the caches</span>
<a name="l01781"></a>01781    <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a>      = <a class="code" href="a00018.html#0b62220f198f7eb96b15aa863c49ce54">FS_BUF_SECTOR_EMPTY</a>;
<a name="l01782"></a>01782    <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#15ae04822b3c2386dba0b7e54c6062aa">u8_modify</a>   = FALSE;
<a name="l01783"></a>01783    <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#9aba32679527ef002f0bbf18545108cf">u32_clusterlist_start</a> = 0xFFFFFFFF;
<a name="l01784"></a>01784 }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786 
<a name="l01787"></a>01787 <span class="preprocessor">#if (FS_LEVEL_FEATURES &gt; FSFEATURE_READ)</span>
<a name="l01790"></a><a class="code" href="a00018.html#5948c1de515852418670d3fb8ae1e832">01790</a> <span class="preprocessor">void  fat_cache_clear( void )</span>
<a name="l01791"></a>01791 <span class="preprocessor"></span>{
<a name="l01792"></a>01792    memset( <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a> , 0 , <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> );
<a name="l01793"></a>01793 }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795 
<a name="l01798"></a><a class="code" href="a00018.html#e73cb496ddbf1ab33944f99f1c50f4d0">01798</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#e73cb496ddbf1ab33944f99f1c50f4d0">fat_cache_sector_is_modify</a>( <span class="keywordtype">void</span> )
<a name="l01799"></a>01799 {
<a name="l01800"></a>01800    <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#15ae04822b3c2386dba0b7e54c6062aa">u8_modify</a> = TRUE;
<a name="l01801"></a>01801 }
<a name="l01802"></a>01802 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01803"></a>01803 <span class="preprocessor"></span>
<a name="l01804"></a>01804 
<a name="l01810"></a><a class="code" href="a00018.html#578ab4800128cde17c0820a5027c1c06">01810</a> Bool  <a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>( <span class="keywordtype">void</span> )
<a name="l01811"></a>01811 {
<a name="l01812"></a>01812    <span class="comment">// If the cache is modify, then write the cache on device</span>
<a name="l01813"></a>01813    <span class="keywordflow">if</span> ( TRUE == <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#15ae04822b3c2386dba0b7e54c6062aa">u8_modify</a> )
<a name="l01814"></a>01814    {
<a name="l01815"></a>01815       <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#15ae04822b3c2386dba0b7e54c6062aa">u8_modify</a> = FALSE; <span class="comment">// If error the flag modify must be clear for not block other command</span>
<a name="l01816"></a>01816       <span class="keywordflow">if</span>( <a class="code" href="a00015.html#f4b64acad5f46d01e082d7a7301078df">mem_wr_protect</a>( <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a>  ))
<a name="l01817"></a>01817       {
<a name="l01818"></a>01818          <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#3e74c914900316653d8cfdef780447c8">FS_LUN_WP</a>;
<a name="l01819"></a>01819          <span class="keywordflow">return</span> FALSE;
<a name="l01820"></a>01820       }
<a name="l01821"></a>01821       <span class="keywordflow">if</span> (<a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> != <a class="code" href="a00015.html#61739dc73f8bff39c3d291f2e47a5bce">ram_2_memory</a>( <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#983c3e8973f75815f64897cfdcacd10e">u8_lun</a> , <a class="code" href="a00018.html#140fe136917dd9c8db4239a2027be1a2">fs_g_sectorcache</a>.<a class="code" href="a00008.html#fe852c5721ec70a1942bcebca4e370c9">u32_addr</a> , <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a> ))
<a name="l01822"></a>01822       {
<a name="l01823"></a>01823          <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#cf37e5255ee1dbfaab77def32a7cbbef">FS_ERR_HW</a>;
<a name="l01824"></a>01824          <span class="keywordflow">return</span> FALSE;
<a name="l01825"></a>01825       }
<a name="l01826"></a>01826    }
<a name="l01827"></a>01827    <span class="keywordflow">return</span> TRUE;
<a name="l01828"></a>01828 }
<a name="l01829"></a>01829 
<a name="l01830"></a>01830 
<a name="l01831"></a>01831 
<a name="l01832"></a>01832 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l01838"></a><a class="code" href="a00018.html#3ebe58d94472a1818a38afaf09c19c35">01838</a> <span class="preprocessor">Bool  fat_check_nav_access_disk( void )</span>
<a name="l01839"></a>01839 <span class="preprocessor"></span>{
<a name="l01840"></a>01840    U8 i;
<a name="l01841"></a>01841 
<a name="l01842"></a>01842    <span class="comment">// For each navigators</span>
<a name="l01843"></a>01843    <span class="keywordflow">for</span>( i=0 ; i!=(<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a>-1) ; i++ )
<a name="l01844"></a>01844    {
<a name="l01845"></a>01845       <span class="comment">// Disk selected ?</span>
<a name="l01846"></a>01846       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> != <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].u16_fat_size )
<a name="l01847"></a>01847       <span class="comment">// Is it the same disk ?</span>
<a name="l01848"></a>01848       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> == <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l01849"></a>01849       <span class="comment">// Is it access file ?</span>
<a name="l01850"></a>01850       <span class="keywordflow">if</span>( <a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>!=0 )
<a name="l01851"></a>01851       {
<a name="l01852"></a>01852          <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#65f54d5e9ae9fb0958d6be4d1fb919c7">FS_ERR_FILE_OPEN</a>;
<a name="l01853"></a>01853          <span class="keywordflow">return</span> FALSE;  <span class="comment">// File open then write access not possible</span>
<a name="l01854"></a>01854       }
<a name="l01855"></a>01855    }
<a name="l01856"></a>01856    <span class="keywordflow">return</span> TRUE;
<a name="l01857"></a>01857 }
<a name="l01858"></a>01858 
<a name="l01859"></a>01859 
<a name="l01870"></a><a class="code" href="a00018.html#07f36d38eda0af16ef7ef899129d7e7b">01870</a> Bool  <a class="code" href="a00017.html#07f36d38eda0af16ef7ef899129d7e7b">fat_check_nav_access_file</a>( Bool mode )
<a name="l01871"></a>01871 {
<a name="l01872"></a>01872    U8 i;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874    <span class="comment">// Reset variable of all navigators</span>
<a name="l01875"></a>01875    <span class="keywordflow">for</span>( i=0 ; i!=(<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a>-1) ; i++ )
<a name="l01876"></a>01876    {
<a name="l01877"></a>01877       <span class="comment">// Disk selected ?</span>
<a name="l01878"></a>01878       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> != <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].u16_fat_size )
<a name="l01879"></a>01879       <span class="comment">// Is it the same disk ?</span>
<a name="l01880"></a>01880       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> == <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> )
<a name="l01881"></a>01881 #if (<a class="code" href="a00014.html#611aad16c0a7b624d4f73d4174895d1f">FS_MULTI_PARTITION</a> == ENABLED)
<a name="l01882"></a>01882       <span class="comment">// Is it the same partition ?</span>
<a name="l01883"></a>01883       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a> == <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a> )
<a name="l01884"></a>01884 #endif
<a name="l01885"></a>01885       <span class="comment">// Is it the same directory ?</span>
<a name="l01886"></a>01886       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a> == <a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[i].<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a> )
<a name="l01887"></a>01887       <span class="comment">// Is it the same file ?</span>
<a name="l01888"></a>01888       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> == <a class="code" href="a00017.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[i].<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> )
<a name="l01889"></a>01889       {
<a name="l01890"></a>01890          <span class="keywordflow">if</span>( mode )
<a name="l01891"></a>01891          {
<a name="l01892"></a>01892             <span class="comment">// Is it open ?</span>
<a name="l01893"></a>01893             <span class="keywordflow">if</span>( <a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>!=0 )
<a name="l01894"></a>01894             {
<a name="l01895"></a>01895                <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#65f54d5e9ae9fb0958d6be4d1fb919c7">FS_ERR_FILE_OPEN</a>;
<a name="l01896"></a>01896                <span class="keywordflow">return</span> FALSE;  <span class="comment">// File open then write access not possible</span>
<a name="l01897"></a>01897             }
<a name="l01898"></a>01898          }
<a name="l01899"></a>01899          <span class="keywordflow">else</span>
<a name="l01900"></a>01900          {
<a name="l01901"></a>01901             <span class="comment">// Is it open in write mode ?</span>
<a name="l01902"></a>01902             <span class="keywordflow">if</span>( <a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[i].u8_open_mode &amp; <a class="code" href="a00023.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> )
<a name="l01903"></a>01903             {
<a name="l01904"></a>01904                <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#5b438435c3686cdce1a51be28a732565">FS_ERR_FILE_OPEN_WR</a>;
<a name="l01905"></a>01905                <span class="keywordflow">return</span> FALSE;  <span class="comment">// File open in write mode then read access not possible</span>
<a name="l01906"></a>01906             }
<a name="l01907"></a>01907          }
<a name="l01908"></a>01908       }
<a name="l01909"></a>01909    }
<a name="l01910"></a>01910    <span class="keywordflow">return</span> TRUE;
<a name="l01911"></a>01911 }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913 
<a name="l01918"></a><a class="code" href="a00018.html#65cfc6e07b1a1bc3a12d564148daca37">01918</a> <span class="keywordtype">void</span>  <a class="code" href="a00017.html#65cfc6e07b1a1bc3a12d564148daca37">fat_invert_nav</a>( U8 u8_idnav )
<a name="l01919"></a>01919 {
<a name="l01920"></a>01920    _MEM_TYPE_SLOW_ U8 Temp[Max(Max(<span class="keyword">sizeof</span>(<a class="code" href="a00004.html">Fs_management</a>),<span class="keyword">sizeof</span>(<a class="code" href="a00005.html">Fs_management_entry</a>)),<span class="keyword">sizeof</span>(<a class="code" href="a00006.html">Fs_management_fast</a>))];
<a name="l01921"></a>01921 
<a name="l01922"></a>01922    <span class="keywordflow">if</span>( u8_idnav == 0 )
<a name="l01923"></a>01923       <span class="keywordflow">return</span>;
<a name="l01924"></a>01924    u8_idnav--;
<a name="l01925"></a>01925 
<a name="l01926"></a>01926    memcpy_ram2ram(Temp,                              (U8*)&amp;<a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>,                     <span class="keyword">sizeof</span>(Fs_management));
<a name="l01927"></a>01927    memcpy_ram2ram((U8*)&amp;fs_g_nav,                    (U8*)&amp;<a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[u8_idnav],        <span class="keyword">sizeof</span>(Fs_management));
<a name="l01928"></a>01928    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[u8_idnav],       Temp,                               <span class="keyword">sizeof</span>(Fs_management));
<a name="l01929"></a>01929 
<a name="l01930"></a>01930    memcpy_ram2ram(Temp,                              (U8*)&amp;<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>,               <span class="keyword">sizeof</span>(Fs_management_entry));
<a name="l01931"></a>01931    memcpy_ram2ram((U8*)&amp;fs_g_nav_entry,              (U8*)&amp;<a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav],  <span class="keyword">sizeof</span>(Fs_management_entry));
<a name="l01932"></a>01932    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav], Temp,                               <span class="keyword">sizeof</span>(Fs_management_entry));
<a name="l01933"></a>01933 
<a name="l01934"></a>01934    memcpy_ram2ram(Temp,                              (U8*)&amp;<a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>,                <span class="keyword">sizeof</span>(Fs_management_fast));
<a name="l01935"></a>01935    memcpy_ram2ram((U8*)&amp;fs_g_nav_fast,               (U8*)&amp;<a class="code" href="a00017.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[u8_idnav],   <span class="keyword">sizeof</span>(Fs_management_fast));
<a name="l01936"></a>01936    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00017.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[u8_idnav],  Temp,                               <span class="keyword">sizeof</span>(Fs_management_fast));
<a name="l01937"></a>01937 }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939 
<a name="l01947"></a><a class="code" href="a00018.html#019afd16a7838947cee3c910a1dcd045">01947</a> Bool  <a class="code" href="a00017.html#019afd16a7838947cee3c910a1dcd045">fat_copy_file_current</a>( U8 u8_idnav )
<a name="l01948"></a>01948 {
<a name="l01949"></a>01949    <span class="keywordflow">if</span>( 0 == u8_idnav)
<a name="l01950"></a>01950       <span class="keywordflow">return</span> TRUE;
<a name="l01951"></a>01951    u8_idnav--;
<a name="l01952"></a>01952    <span class="keywordflow">if</span>( 0 != <a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav].u8_open_mode )
<a name="l01953"></a>01953    {
<a name="l01954"></a>01954       <a class="code" href="a00023.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00023.html#10b1c7750a8915e821b2ab428b601d60">FS_ERR_NAVDST_FILE_OPEN</a>;  <span class="comment">// The navigation destination have a file openned</span>
<a name="l01955"></a>01955       <span class="keywordflow">return</span> FALSE;
<a name="l01956"></a>01956    }
<a name="l01957"></a>01957    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00017.html#0d59a916e72039fa7f898cd233f8fe2f">fs_g_navext</a>[u8_idnav],       (U8*)&amp;<a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>       , <span class="keyword">sizeof</span>(<a class="code" href="a00004.html">Fs_management</a>) );
<a name="l01958"></a>01958    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav], (U8*)&amp;<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a> , <span class="keyword">sizeof</span>(<a class="code" href="a00005.html">Fs_management_entry</a>) );
<a name="l01959"></a>01959    memcpy_ram2ram((U8*)&amp;<a class="code" href="a00017.html#d24195746b40d4a83dff493c118b91aa">fs_g_navext_fast</a>[u8_idnav],  (U8*)&amp;<a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>  , <span class="keyword">sizeof</span>(<a class="code" href="a00006.html">Fs_management_fast</a>) );
<a name="l01960"></a>01960    <a class="code" href="a00017.html#90e0163ac7f98f08019dc0b73fd7c834">fs_g_navext_entry</a>[u8_idnav].<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>=0;   <span class="comment">// Clear the informations about file open option</span>
<a name="l01961"></a>01961    <span class="keywordflow">return</span> TRUE;
<a name="l01962"></a>01962 }
<a name="l01963"></a>01963 
<a name="l01964"></a>01964 <span class="preprocessor">#endif</span>
<a name="l01965"></a>01965 <span class="preprocessor"></span>
<a name="l01966"></a>01966 <span class="comment">// To clean the code </span>
<a name="l01967"></a>01967 <span class="preprocessor">#if (FS_NB_CACHE_CLUSLIST==1)</span>
<a name="l01968"></a>01968 <span class="preprocessor"></span><span class="preprocessor">#  undef fs_g_u8_current_cache</span>
<a name="l01969"></a>01969 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01970"></a>01970 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Sep 20 12:17:12 2007 for AVR32 - FAT Services by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>
