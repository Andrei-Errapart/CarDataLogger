<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>AVR32 UC3 - FSACCESS Services: file.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>file.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
FAT 12/16/32 Services. 
<p>
This file defines a useful set of functions for the file accesses on AVR32 devices.<p>
<ul>
<li>Compiler: IAR EWAVR32 and GNU GCC for AVR32</li><li>Supported devices: All AVR32 devices can be used.</li><li>AppNote:</li></ul>
<p>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support and FAQ: <a href="http://support.atmel.no/">http://support.atmel.no/</a> </dd></dl>

<p>
Definition in file <a class="el" href="a00036.html">file.c</a>.
<p>
<code>#include &quot;<a class="el" href="a00030.html">conf_explorer.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00037.html">file.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00043.html">navigation.h</a>&quot;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &quot;<a class="el" href="a00032.html">ctrl_access.h</a>&quot;</code><br>

<p>
<a href="a00036.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U8&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#b2901935d6c106b3462f3c22df07740a">file_bof</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction test if the position is at the beginning of file.  <a href="#b2901935d6c106b3462f3c22df07740a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#7f4f3b65455595cb5be0f7cd7d12e02d">file_close</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction close the file.  <a href="#7f4f3b65455595cb5be0f7cd7d12e02d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U8&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#bed52ba7230c6eecf100a3709b9ed74e">file_eof</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction test if the position is at the end of file.  <a href="#bed52ba7230c6eecf100a3709b9ed74e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U16&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#952fd54b2e49943d138e44d3bdf569bf">file_getc</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction return the next character at current file position.  <a href="#952fd54b2e49943d138e44d3bdf569bf"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U32&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#2a08b2cfeeb2b4064f3b2fcd6829c8da">file_getpos</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction return the position in the file.  <a href="#2a08b2cfeeb2b4064f3b2fcd6829c8da"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U16&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#8510e7d9f145d750a6644eb887648af5">file_gets</a> (U8 _MEM_TYPE_SLOW_ *string, U16 u16_str_size)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction copy in a data buffer the current line of open file.  <a href="#8510e7d9f145d750a6644eb887648af5"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#56345cae081575762c6a809b2fcb31c1">file_ispresent</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction check if a file is selected and it is not a directory.  <a href="#56345cae081575762c6a809b2fcb31c1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#78d70fef5fc9bc7ef9e812175423e2fd">file_load_segment_value</a> (<a class="el" href="a00002.html">Fs_file_segment</a> _MEM_TYPE_SLOW_ *segment)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction load the global segment in param segment.  <a href="#78d70fef5fc9bc7ef9e812175423e2fd"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#310a118fba8ffb01c998e5087f32d815">file_open</a> (U8 fopen_mode)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction open the file selected.  <a href="#310a118fba8ffb01c998e5087f32d815"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#141d514531c560557a4a50bd17a9e5f8">file_putc</a> (U16 u16_byte)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction write a character in the file at current position.  <a href="#141d514531c560557a4a50bd17a9e5f8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U16&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#ec41040de995cf39b664825cb9f3badb">file_puts</a> (U8 _MEM_TYPE_SLOW_ *string)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction copy the string in the file at the current position.  <a href="#ec41040de995cf39b664825cb9f3badb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#d0fc50dbdd1849e9fe0e81b215ce9335">file_read</a> (<a class="el" href="a00002.html">Fs_file_segment</a> _MEM_TYPE_SLOW_ *segment)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction return a continue physical memory segment corresponding at a file to read.  <a href="#d0fc50dbdd1849e9fe0e81b215ce9335"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U16&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#7b7c08bde8cb93a792dd578cf4310d0a">file_read_buf</a> (U8 _MEM_TYPE_SLOW_ *buffer, U16 u16_buf_size)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction copy in data buffer the data file corresponding at the current position.  <a href="#7b7c08bde8cb93a792dd578cf4310d0a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#2599f935c7e1b69f2650e0943091ddca">file_seek</a> (U32 u32_pos, U8 u8_whence)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction change the position in file selected.  <a href="#2599f935c7e1b69f2650e0943091ddca"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#07a8faa41a278961fccc5c0793b01ab1">file_set_eof</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction set the end of file at the current position.  <a href="#07a8faa41a278961fccc5c0793b01ab1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#539e0dd44b9da051430f1a89715477fa">file_string_ascii</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction select the ASCII mode for the routines getc() and putc().  <a href="#539e0dd44b9da051430f1a89715477fa"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#6d8e84352a2ed376cd9d8c3b74ffe410">file_string_unicode</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction select the UNICODE mode for the routines getc() and putc().  <a href="#6d8e84352a2ed376cd9d8c3b74ffe410"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#1b5c29ddedddd73a1279b9920ea1642f">file_write</a> (<a class="el" href="a00002.html">Fs_file_segment</a> _MEM_TYPE_SLOW_ *segment)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction return a continue physical memory segment corresponding at a file to write.  <a href="#1b5c29ddedddd73a1279b9920ea1642f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">U16&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#415ad1a43ac79c02c294a4e32246c519">file_write_buf</a> (U8 _MEM_TYPE_SLOW_ *buffer, U16 u16_buf_size)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction copy the data buffer in file at the current position.  <a href="#415ad1a43ac79c02c294a4e32246c519"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ U8&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#2406ed722978ec6c55dcafa277a86633">fs_g_sector</a> [FS_SIZE_OF_SECTOR]</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Use the "FAT sector cache" to store a file sector during a <a class="el" href="a00020.html#141d514531c560557a4a50bd17a9e5f8">file_putc()</a> or <a class="el" href="a00020.html#952fd54b2e49943d138e44d3bdf569bf">file_getc()</a> routines.  <a href="#2406ed722978ec6c55dcafa277a86633"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">Bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> = FALSE</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Internal flag to signal the string format (ASCII, UNICODE) to use for getc() and putc() routines.  <a href="#f088989196e7debe7a437151d4c2ec6a"></a><br></td></tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="b2901935d6c106b3462f3c22df07740a"></a><!-- doxytag: member="file.c::file_bof" ref="b2901935d6c106b3462f3c22df07740a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U8 file_bof           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction test if the position is at the beginning of file. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>1 the position is at the beginning of file <p>
0 the position isn't at the beginning of file <p>
FFh error </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00857">857</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, and <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>.<div class="fragment"><pre class="fragment"><a name="l00858"></a>00858 {
<a name="l00859"></a>00859    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>() )
<a name="l00860"></a>00860       <span class="keywordflow">return</span> 0xFF;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862    <span class="keywordflow">return</span> (0 == <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> );
<a name="l00863"></a>00863 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7f4f3b65455595cb5be0f7cd7d12e02d"></a><!-- doxytag: member="file.c::file_close" ref="7f4f3b65455595cb5be0f7cd7d12e02d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void file_close           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction close the file. 
<p>

<p>
Definition at line <a class="el" href="a00036.html#l00883">883</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l01810">fat_cache_flush()</a>, <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00034.html#l00356">Fat_file_close</a>, <a class="el" href="a00033.html#l01184">fat_read_dir()</a>, <a class="el" href="a00033.html#l01407">fat_write_entry_file()</a>, <a class="el" href="a00038.html#l00143">FOPEN_WRITE_ACCESS</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.
<p>
Referenced by <a class="el" href="a00039.html#l00277">close()</a>, <a class="el" href="a00042.html#l02065">nav_file_paste_start()</a>, and <a class="el" href="a00042.html#l02112">nav_file_paste_state()</a>.<div class="fragment"><pre class="fragment"><a name="l00884"></a>00884 {
<a name="l00885"></a>00885    <span class="comment">// If a file is open, then close this one</span>
<a name="l00886"></a>00886    <span class="keywordflow">if</span>( <a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>() )
<a name="l00887"></a>00887    {
<a name="l00888"></a>00888       
<a name="l00889"></a>00889 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l00890"></a>00890 <span class="preprocessor"></span>      <span class="keywordflow">if</span>( <a class="code" href="a00022.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a> )
<a name="l00891"></a>00891       {
<a name="l00892"></a>00892          <span class="comment">// Write file informations</span>
<a name="l00893"></a>00893          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>() )
<a name="l00894"></a>00894             <span class="keywordflow">return</span>; <span class="comment">// error</span>
<a name="l00895"></a>00895          <a class="code" href="a00017.html#40035dc41d435ed3281155cdf800cf02">fat_write_entry_file</a>();
<a name="l00896"></a>00896          <a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>();  <span class="comment">// In case of error during writing data, flush the data before exit fonction</span>
<a name="l00897"></a>00897       }
<a name="l00898"></a>00898 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00899"></a>00899 <span class="preprocessor"></span>      <a class="code" href="a00018.html#8e3b3ddad0e2b4f1747507a2665b0901">Fat_file_close</a>;
<a name="l00900"></a>00900    }
<a name="l00901"></a>00901 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="bed52ba7230c6eecf100a3709b9ed74e"></a><!-- doxytag: member="file.c::file_eof" ref="bed52ba7230c6eecf100a3709b9ed74e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U8 file_eof           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction test if the position is at the end of file. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>1 the position is at the end of file <p>
0 the position isn't at the end of file <p>
FFh error </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00872">872</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, and <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>.
<p>
Referenced by <a class="el" href="a00036.html#l00460">file_getc()</a>, <a class="el" href="a00036.html#l00194">file_read()</a>, <a class="el" href="a00036.html#l00271">file_read_buf()</a>, <a class="el" href="a00042.html#l02112">nav_file_paste_state()</a>, and <a class="el" href="a00039.html#l00213">read()</a>.<div class="fragment"><pre class="fragment"><a name="l00873"></a>00873 {
<a name="l00874"></a>00874    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>() )
<a name="l00875"></a>00875       <span class="keywordflow">return</span> 0xFF;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877    <span class="keywordflow">return</span> (<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> &lt;= <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> );
<a name="l00878"></a>00878 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="952fd54b2e49943d138e44d3bdf569bf"></a><!-- doxytag: member="file.c::file_getc" ref="952fd54b2e49943d138e44d3bdf569bf" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 file_getc           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction return the next character at current file position. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The character reading (UNICOCE, or ASCII storage in LSB) <p>
EOF, in case of error or end of file</dd></dl>
<div class="fragment"><pre class="fragment">
//! Before, if you want get a UNICODE character then call file_string_unicode().
//! This routine return ALL characters.
//! </pre></div> 
<p>
Definition at line <a class="el" href="a00036.html#l00460">460</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00033.html#l01026">fat_read_file()</a>, <a class="el" href="a00036.html#l00872">file_eof()</a>, <a class="el" href="a00038.html#l00142">FOPEN_READ_ACCESS</a>, <a class="el" href="a00034.html#l00230">FS_CLUST_ACT_ONE</a>, <a class="el" href="a00038.html#l00154">FS_EOF</a>, <a class="el" href="a00038.html#l00223">FS_ERR_EOF</a>, <a class="el" href="a00038.html#l00217">FS_ERR_OUT_LIST</a>, <a class="el" href="a00038.html#l00234">FS_ERR_POS_UNICODE_BAD</a>, <a class="el" href="a00038.html#l00221">FS_ERR_WRITE_ONLY</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00034.html#l00390">fs_g_sector</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00034.html#l00207">FS_MASK_SIZE_OF_SECTOR</a>, <a class="el" href="a00036.html#l00063">g_b_file_unicode</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.<div class="fragment"><pre class="fragment"><a name="l00461"></a>00461 {
<a name="l00462"></a>00462    U16   u16_byte;
<a name="l00463"></a>00463    U16   u16_buf_pos;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    <span class="keywordflow">while</span>(1)
<a name="l00466"></a>00466    {
<a name="l00467"></a>00467       <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00468"></a>00468          <span class="keywordflow">break</span>;
<a name="l00469"></a>00469       <span class="keywordflow">if</span>(!(<a class="code" href="a00022.html#20c8ba8042cb1e42ca50f71cc542cf2b">FOPEN_READ_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>))
<a name="l00470"></a>00470       {
<a name="l00471"></a>00471          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#c925d8d9a6cff3449f9631952c3790a3">FS_ERR_WRITE_ONLY</a>;
<a name="l00472"></a>00472          <span class="keywordflow">break</span>;
<a name="l00473"></a>00473       }
<a name="l00474"></a>00474       <span class="keywordflow">if</span> ( <a class="code" href="a00020.html#bed52ba7230c6eecf100a3709b9ed74e">file_eof</a>() )
<a name="l00475"></a>00475       {
<a name="l00476"></a>00476          <span class="comment">// End of the file</span>
<a name="l00477"></a>00477          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#ca57c3036b23f86097252cfe4bb6b9c8">FS_ERR_EOF</a>;
<a name="l00478"></a>00478          <span class="keywordflow">break</span>;
<a name="l00479"></a>00479       }
<a name="l00480"></a>00480   
<a name="l00481"></a>00481       <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>( <a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a> ))
<a name="l00482"></a>00482       {
<a name="l00483"></a>00483          <span class="keywordflow">if</span>( <a class="code" href="a00022.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l00484"></a>00484          {  <span class="comment">// Translate the error</span>
<a name="l00485"></a>00485             <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#ca57c3036b23f86097252cfe4bb6b9c8">FS_ERR_EOF</a>;   <span class="comment">// End of file</span>
<a name="l00486"></a>00486          }
<a name="l00487"></a>00487          <span class="keywordflow">break</span>;
<a name="l00488"></a>00488       }
<a name="l00489"></a>00489       
<a name="l00490"></a>00490       u16_buf_pos = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &amp; <a class="code" href="a00018.html#7090b63e1693b160aaebf802dfd8e05a">FS_MASK_SIZE_OF_SECTOR</a>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492       <span class="keywordflow">if</span>( <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> )
<a name="l00493"></a>00493       {
<a name="l00494"></a>00494          <span class="keywordflow">if</span>( 0x01 &amp; u16_buf_pos )
<a name="l00495"></a>00495          {
<a name="l00496"></a>00496             <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#50183dbc9031f9989187e643b9e97542">FS_ERR_POS_UNICODE_BAD</a>;   <span class="comment">// Error in position file</span>
<a name="l00497"></a>00497             <span class="keywordflow">break</span>;
<a name="l00498"></a>00498          }
<a name="l00499"></a>00499          MSB(u16_byte) = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_buf_pos ];
<a name="l00500"></a>00500          LSB(u16_byte) = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_buf_pos +1];
<a name="l00501"></a>00501          <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>+=2;
<a name="l00502"></a>00502       }
<a name="l00503"></a>00503       <span class="keywordflow">else</span>
<a name="l00504"></a>00504       {
<a name="l00505"></a>00505          u16_byte = <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_buf_pos ];
<a name="l00506"></a>00506       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>++;
<a name="l00507"></a>00507       }
<a name="l00508"></a>00508       <span class="keywordflow">return</span> u16_byte;
<a name="l00509"></a>00509    }
<a name="l00510"></a>00510    <span class="keywordflow">return</span> <a class="code" href="a00022.html#02e7b232f5280b690d2c1ab5ae4871f9">FS_EOF</a>;   <span class="comment">// No read data</span>
<a name="l00511"></a>00511 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="2a08b2cfeeb2b4064f3b2fcd6829c8da"></a><!-- doxytag: member="file.c::file_getpos" ref="2a08b2cfeeb2b4064f3b2fcd6829c8da" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U32 file_getpos           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction return the position in the file. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Position in file </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00778">778</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, and <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>.<div class="fragment"><pre class="fragment"><a name="l00779"></a>00779 {
<a name="l00780"></a>00780    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>() )
<a name="l00781"></a>00781       <span class="keywordflow">return</span> 0;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783    <span class="keywordflow">return</span> <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>;
<a name="l00784"></a>00784 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="8510e7d9f145d750a6644eb887648af5"></a><!-- doxytag: member="file.c::file_gets" ref="8510e7d9f145d750a6644eb887648af5" args="(U8 _MEM_TYPE_SLOW_ *string, U16 u16_str_size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 file_gets           </td>
          <td>(</td>
          <td class="paramtype">U8 _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>string</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&nbsp;</td>
          <td class="paramname"> <em>u16_str_size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction copy in a data buffer the current line of open file. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>string</em>&nbsp;</td><td>string to fill </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>u16_str_size</em>&nbsp;</td><td>string size (unit ASCII or UNICODE)</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>number of byte read <p>
0, in case of error</dd></dl>
<div class="fragment"><pre class="fragment">
//! Before, if you want get a UNICODE string then call file_string_unicode().
//! This routine write in string the back line character.
//! </pre></div> 
<p>
Definition at line <a class="el" href="a00036.html#l00387">387</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00036.html#l00271">file_read_buf()</a>, <a class="el" href="a00036.html#l00799">file_seek()</a>, <a class="el" href="a00037.html#l00057">FS_SEEK_CUR_RE</a>, and <a class="el" href="a00036.html#l00063">g_b_file_unicode</a>.<div class="fragment"><pre class="fragment"><a name="l00388"></a>00388 {
<a name="l00389"></a>00389    U16 u16_save_buf_size;
<a name="l00390"></a>00390    U16 u16_nb_read;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    <span class="keywordflow">if</span>( <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> )
<a name="l00393"></a>00393    {
<a name="l00394"></a>00394       u16_nb_read = <a class="code" href="a00020.html#7b7c08bde8cb93a792dd578cf4310d0a">file_read_buf</a>( string , u16_str_size*2 );
<a name="l00395"></a>00395       u16_nb_read /= 2;
<a name="l00396"></a>00396    }
<a name="l00397"></a>00397    <span class="keywordflow">else</span>
<a name="l00398"></a>00398    {
<a name="l00399"></a>00399       u16_nb_read = <a class="code" href="a00020.html#7b7c08bde8cb93a792dd578cf4310d0a">file_read_buf</a>( string , u16_str_size );
<a name="l00400"></a>00400    }
<a name="l00401"></a>00401    <span class="keywordflow">if</span>( 0 == u16_nb_read )
<a name="l00402"></a>00402       <span class="keywordflow">return</span> 0;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    u16_save_buf_size = u16_str_size;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406    <span class="comment">// Search end of line</span>
<a name="l00407"></a>00407    <span class="keywordflow">while</span>( 1 )
<a name="l00408"></a>00408    {                      
<a name="l00409"></a>00409       <span class="comment">// Increment the number of character read</span>
<a name="l00410"></a>00410       u16_nb_read--;
<a name="l00411"></a>00411       u16_str_size--;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413       <span class="keywordflow">if</span>( (( <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a>) &amp;&amp; (<span class="charliteral">'\0'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)string )[0]))
<a name="l00414"></a>00414       ||  ((!<a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a>) &amp;&amp; (<span class="charliteral">'\0'</span>  == string [0])) )
<a name="l00415"></a>00415       {
<a name="l00416"></a>00416          <span class="comment">// End of texte file</span>
<a name="l00417"></a>00417          <span class="keywordflow">break</span>;
<a name="l00418"></a>00418       }
<a name="l00419"></a>00419       
<a name="l00420"></a>00420       <span class="keywordflow">if</span>( 0 == u16_str_size )
<a name="l00421"></a>00421       {
<a name="l00422"></a>00422          <span class="comment">// string full (u16_str_size = u16_nb_read = 0)</span>
<a name="l00423"></a>00423          u16_nb_read = u16_str_size = 1;              <span class="comment">// Decrement the number of character read</span>
<a name="l00424"></a>00424          <span class="keywordflow">break</span>;
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427       <span class="keywordflow">if</span>( (( <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a>) &amp;&amp; (<span class="charliteral">'\n'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)string )[0]))
<a name="l00428"></a>00428       ||  ((!<a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a>) &amp;&amp; (<span class="charliteral">'\n'</span>  == string [0]))
<a name="l00429"></a>00429       ||  ( 0 == u16_nb_read ) )
<a name="l00430"></a>00430       {  
<a name="l00431"></a>00431          <span class="comment">// End of line</span>
<a name="l00432"></a>00432          string += (<a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a>? 2 : 1 );  <span class="comment">// Go to next character</span>
<a name="l00433"></a>00433          <span class="keywordflow">break</span>;
<a name="l00434"></a>00434       }
<a name="l00435"></a>00435       string += (<a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a>? 2 : 1 );  <span class="comment">// Go to next character</span>
<a name="l00436"></a>00436    }
<a name="l00437"></a>00437    <span class="comment">// add a '\0' at the end of string</span>
<a name="l00438"></a>00438    <span class="keywordflow">if</span>( <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> )
<a name="l00439"></a>00439    {
<a name="l00440"></a>00440       ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)string )[0] = <span class="charliteral">'\0'</span>;
<a name="l00441"></a>00441       <a class="code" href="a00020.html#2599f935c7e1b69f2650e0943091ddca">file_seek</a>( u16_nb_read*2 , <a class="code" href="a00021.html#f546c33414158e18f0a25b795f402ccf">FS_SEEK_CUR_RE</a> );
<a name="l00442"></a>00442    }<span class="keywordflow">else</span>{
<a name="l00443"></a>00443       string [0] = <span class="charliteral">'\0'</span>;
<a name="l00444"></a>00444       <a class="code" href="a00020.html#2599f935c7e1b69f2650e0943091ddca">file_seek</a>( u16_nb_read , <a class="code" href="a00021.html#f546c33414158e18f0a25b795f402ccf">FS_SEEK_CUR_RE</a> );
<a name="l00445"></a>00445    }
<a name="l00446"></a>00446    <span class="keywordflow">return</span> (u16_save_buf_size-u16_str_size) ;
<a name="l00447"></a>00447 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="56345cae081575762c6a809b2fcb31c1"></a><!-- doxytag: member="file.c::file_ispresent" ref="56345cae081575762c6a809b2fcb31c1" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool file_ispresent           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction check if a file is selected and it is not a directory. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>TRUE, a file is selected <p>
FALSE, otherwise </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00094">94</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00288">fat_check_is_file()</a>, and <a class="el" href="a00033.html#l00275">fat_check_mount_select()</a>.<div class="fragment"><pre class="fragment"><a name="l00095"></a>00095 {
<a name="l00096"></a>00096    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>() )
<a name="l00097"></a>00097       <span class="keywordflow">return</span> FALSE;
<a name="l00098"></a>00098    <span class="keywordflow">return</span> <a class="code" href="a00017.html#2fb226027c5ea59f40c582737e5a44b9">fat_check_is_file</a>();
<a name="l00099"></a>00099 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="78d70fef5fc9bc7ef9e812175423e2fd"></a><!-- doxytag: member="file.c::file_load_segment_value" ref="78d70fef5fc9bc7ef9e812175423e2fd" args="(Fs_file_segment _MEM_TYPE_SLOW_ *segment)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void file_load_segment_value           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">Fs_file_segment</a> _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>segment</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction load the global segment in param segment. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>segment</em>&nbsp;</td><td>Pointer on the segment structure to load </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="a00036.html#l00169">169</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00034.html#l00369">fs_g_nav</a>, <a class="el" href="a00034.html#l00375">fs_g_seg</a>, <a class="el" href="a00034.html#l00299">Fs_segment::u32_addr</a>, <a class="el" href="a00034.html#l00300">Fs_segment::u32_size_or_pos</a>, and <a class="el" href="a00034.html#l00259">Fs_management::u8_lun</a>.
<p>
Referenced by <a class="el" href="a00036.html#l00194">file_read()</a>, and <a class="el" href="a00036.html#l00532">file_write()</a>.<div class="fragment"><pre class="fragment"><a name="l00170"></a>00170 {
<a name="l00171"></a>00171    segment-&gt;u8_lun = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>;
<a name="l00172"></a>00172    segment-&gt;u32_addr = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>;
<a name="l00173"></a>00173    segment-&gt;u32_size_or_pos = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00174"></a>00174 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="310a118fba8ffb01c998e5087f32d815"></a><!-- doxytag: member="file.c::file_open" ref="310a118fba8ffb01c998e5087f32d815" args="(U8 fopen_mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool file_open           </td>
          <td>(</td>
          <td class="paramtype">U8&nbsp;</td>
          <td class="paramname"> <em>fopen_mode</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction open the file selected. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>fopen_mode</em>&nbsp;</td><td>option to open file : <br>
 FOPEN_MODE_R R access, flux pointer = 0, size not modify <br>
 FOPEN_MODE_R_PLUS R/W access, flux pointer = 0, size not modify <br>
 FOPEN_MODE_W W access, flux pointer = 0, size = 0 <br>
 FOPEN_MODE_W_PLUS R/W access, flux pointer = 0, size = 0 <br>
 FOPEN_MODE_APPEND W access, flux pointer = at the end, size not modify <br>
</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>FALSE in case of error, see global value "fs_g_status" for more detail <p>
TRUE otherwise </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00114">114</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00288">fat_check_is_file()</a>, <a class="el" href="a00033.html#l00245">fat_check_mount_select_noopen()</a>, <a class="el" href="a00033.html#l01870">fat_check_nav_access_file()</a>, <a class="el" href="a00038.html#l00145">FOPEN_CLEAR_PTR</a>, <a class="el" href="a00038.html#l00144">FOPEN_CLEAR_SIZE</a>, <a class="el" href="a00038.html#l00143">FOPEN_WRITE_ACCESS</a>, <a class="el" href="a00038.html#l00130">FS_ATTR_READ_ONLY</a>, <a class="el" href="a00038.html#l00222">FS_ERR_MODE_NOAVIALABLE</a>, <a class="el" href="a00038.html#l00212">FS_ERR_READ_ONLY</a>, <a class="el" href="a00034.html#l00369">fs_g_nav</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00038.html#l00211">FS_LUN_WP</a>, <a class="el" href="a00031.html#l00314">mem_wr_protect()</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>, <a class="el" href="a00034.html#l00286">Fs_management_entry::u8_attr</a>, <a class="el" href="a00034.html#l00259">Fs_management::u8_lun</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.
<p>
Referenced by <a class="el" href="a00042.html#l02065">nav_file_paste_start()</a>, and <a class="el" href="a00039.html#l00104">open()</a>.<div class="fragment"><pre class="fragment"><a name="l00115"></a>00115 {
<a name="l00116"></a>00116    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#003f1c81dcb2c7a95f191c30b8a4f258">fat_check_mount_select_noopen</a>())
<a name="l00117"></a>00117       <span class="keywordflow">return</span> FALSE;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#2fb226027c5ea59f40c582737e5a44b9">fat_check_is_file</a>())
<a name="l00120"></a>00120       <span class="keywordflow">return</span> FALSE;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122    <span class="keywordflow">if</span>(<a class="code" href="a00022.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> &amp; fopen_mode)
<a name="l00123"></a>00123    {
<a name="l00124"></a>00124       <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#07f36d38eda0af16ef7ef899129d7e7b">fat_check_nav_access_file</a>( TRUE ) )
<a name="l00125"></a>00125          <span class="keywordflow">return</span> FALSE;
<a name="l00126"></a>00126 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="a00022.html#1205ff33f705779959e1bc40f6d8374f">FS_ATTR_READ_ONLY</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>)
<a name="l00128"></a>00128       {
<a name="l00129"></a>00129          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#9a1684b2e22ad307513e0e62b66f9517">FS_ERR_READ_ONLY</a>;  <span class="comment">// File is read only</span>
<a name="l00130"></a>00130          <span class="keywordflow">return</span> FALSE;
<a name="l00131"></a>00131       }
<a name="l00132"></a>00132       <span class="keywordflow">if</span>( <a class="code" href="a00015.html#f4b64acad5f46d01e082d7a7301078df">mem_wr_protect</a>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>  ))
<a name="l00133"></a>00133       {
<a name="l00134"></a>00134          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#3e74c914900316653d8cfdef780447c8">FS_LUN_WP</a>;  <span class="comment">// Disk read only</span>
<a name="l00135"></a>00135          <span class="keywordflow">return</span> FALSE;
<a name="l00136"></a>00136       }
<a name="l00137"></a>00137 <span class="preprocessor">#else</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>      <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#5adce2e3f97479cbd9b4a9b84a74e3e9">FS_ERR_MODE_NOAVIALABLE</a>;
<a name="l00139"></a>00139       <span class="keywordflow">return</span> FALSE;
<a name="l00140"></a>00140 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>   }
<a name="l00142"></a>00142    <span class="keywordflow">else</span>
<a name="l00143"></a>00143    {
<a name="l00144"></a>00144       <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#07f36d38eda0af16ef7ef899129d7e7b">fat_check_nav_access_file</a>( FALSE ) )
<a name="l00145"></a>00145          <span class="keywordflow">return</span> FALSE;
<a name="l00146"></a>00146    }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148    <span class="keywordflow">if</span>(<a class="code" href="a00022.html#c42c4da0a84d81389bbde84d3c564103">FOPEN_CLEAR_SIZE</a> &amp; fopen_mode)
<a name="l00149"></a>00149    {
<a name="l00150"></a>00150       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>    = 0;     <span class="comment">// The size is null</span>
<a name="l00151"></a>00151    }
<a name="l00152"></a>00152    <span class="keywordflow">if</span>(<a class="code" href="a00022.html#6771844217fc0bb87aa9eb521c036189">FOPEN_CLEAR_PTR</a> &amp; fopen_mode)
<a name="l00153"></a>00153    {
<a name="l00154"></a>00154       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> = 0; 
<a name="l00155"></a>00155    }
<a name="l00156"></a>00156    <span class="keywordflow">else</span>
<a name="l00157"></a>00157    {  <span class="comment">// Go to at the end of file</span>
<a name="l00158"></a>00158       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>;
<a name="l00159"></a>00159    }
<a name="l00160"></a>00160    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a> = fopen_mode;
<a name="l00161"></a>00161    <span class="keywordflow">return</span> TRUE;
<a name="l00162"></a>00162 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="141d514531c560557a4a50bd17a9e5f8"></a><!-- doxytag: member="file.c::file_putc" ref="141d514531c560557a4a50bd17a9e5f8" args="(U16 u16_byte)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool file_putc           </td>
          <td>(</td>
          <td class="paramtype">U16&nbsp;</td>
          <td class="paramname"> <em>u16_byte</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction write a character in the file at current position. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>u16_byte</em>&nbsp;</td><td>character to write in the file (ASCII in LSB or UNICODE)</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>FALSE in case of error, see global value "fs_g_status" for more detail <p>
TRUE otherwise</dd></dl>
<div class="fragment"><pre class="fragment">
//! Before, if you want write a UNICODE character then call file_string_unicode().
//! </pre></div> 
<p>
Definition at line <a class="el" href="a00036.html#l00726">726</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l01798">fat_cache_sector_is_modify()</a>, <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00033.html#l01108">fat_write_file()</a>, <a class="el" href="a00038.html#l00143">FOPEN_WRITE_ACCESS</a>, <a class="el" href="a00034.html#l00230">FS_CLUST_ACT_ONE</a>, <a class="el" href="a00038.html#l00234">FS_ERR_POS_UNICODE_BAD</a>, <a class="el" href="a00038.html#l00212">FS_ERR_READ_ONLY</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00034.html#l00390">fs_g_sector</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00034.html#l00207">FS_MASK_SIZE_OF_SECTOR</a>, <a class="el" href="a00036.html#l00063">g_b_file_unicode</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.<div class="fragment"><pre class="fragment"><a name="l00727"></a>00727 {
<a name="l00728"></a>00728    U16 u16_buf_pos;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00731"></a>00731       <span class="keywordflow">return</span> FALSE;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    <span class="keywordflow">if</span>(!(<a class="code" href="a00022.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>))
<a name="l00734"></a>00734    {
<a name="l00735"></a>00735       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#9a1684b2e22ad307513e0e62b66f9517">FS_ERR_READ_ONLY</a>;
<a name="l00736"></a>00736       <span class="keywordflow">return</span> FALSE;
<a name="l00737"></a>00737    }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8723a199c01163d9f9839bd42ac60693">fat_write_file</a>( <a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a>  , 1 ))
<a name="l00740"></a>00740       <span class="keywordflow">return</span> FALSE;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742    <span class="comment">// Write the data into the cache</span>
<a name="l00743"></a>00743    <a class="code" href="a00017.html#e73cb496ddbf1ab33944f99f1c50f4d0">fat_cache_sector_is_modify</a>();
<a name="l00744"></a>00744 
<a name="l00745"></a>00745    u16_buf_pos = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &amp; <a class="code" href="a00018.html#7090b63e1693b160aaebf802dfd8e05a">FS_MASK_SIZE_OF_SECTOR</a>;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747    <span class="keywordflow">if</span>( <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> )
<a name="l00748"></a>00748    {
<a name="l00749"></a>00749       <span class="keywordflow">if</span>( 0x01 &amp; u16_buf_pos )
<a name="l00750"></a>00750       {
<a name="l00751"></a>00751          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#50183dbc9031f9989187e643b9e97542">FS_ERR_POS_UNICODE_BAD</a>;   <span class="comment">// Error in position file</span>
<a name="l00752"></a>00752          <span class="keywordflow">return</span> FALSE;
<a name="l00753"></a>00753       }
<a name="l00754"></a>00754       <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_buf_pos ]    = MSB(u16_byte);
<a name="l00755"></a>00755       <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_buf_pos +1]  = LSB(u16_byte);
<a name="l00756"></a>00756       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>+=2;
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758    <span class="keywordflow">else</span>
<a name="l00759"></a>00759    {
<a name="l00760"></a>00760       <a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_buf_pos ]    = LSB(u16_byte);
<a name="l00761"></a>00761    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>++;
<a name="l00762"></a>00762    }
<a name="l00763"></a>00763    
<a name="l00764"></a>00764    <span class="comment">// Update the file size</span>
<a name="l00765"></a>00765    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &gt; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> )
<a name="l00766"></a>00766    {
<a name="l00767"></a>00767       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>;
<a name="l00768"></a>00768    }
<a name="l00769"></a>00769    <span class="keywordflow">return</span> TRUE;
<a name="l00770"></a>00770 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="ec41040de995cf39b664825cb9f3badb"></a><!-- doxytag: member="file.c::file_puts" ref="ec41040de995cf39b664825cb9f3badb" args="(U8 _MEM_TYPE_SLOW_ *string)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 file_puts           </td>
          <td>(</td>
          <td class="paramtype">U8 _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>string</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction copy the string in the file at the current position. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>string</em>&nbsp;</td><td>string to write (NULL terminate)</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>number of byte write <p>
0, in case of error</dd></dl>
<div class="fragment"><pre class="fragment">
//! Before, if you want write a UNICODE string then call file_string_unicode().
//! </pre></div> 
<p>
Definition at line <a class="el" href="a00036.html#l00701">701</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00036.html#l00606">file_write_buf()</a>, and <a class="el" href="a00036.html#l00063">g_b_file_unicode</a>.<div class="fragment"><pre class="fragment"><a name="l00702"></a>00702 {
<a name="l00703"></a>00703    U16 u16_size_string=0;
<a name="l00704"></a>00704    <span class="keywordflow">if</span>( <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> )
<a name="l00705"></a>00705    {
<a name="l00706"></a>00706       <span class="keywordflow">while</span>( 0 != ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)string )[u16_size_string] ) u16_size_string++;
<a name="l00707"></a>00707       <span class="keywordflow">return</span> <a class="code" href="a00020.html#415ad1a43ac79c02c294a4e32246c519">file_write_buf</a>( string, u16_size_string*2 );
<a name="l00708"></a>00708    }<span class="keywordflow">else</span>{
<a name="l00709"></a>00709       <span class="keywordflow">while</span>( 0 != string[u16_size_string] ) u16_size_string++;
<a name="l00710"></a>00710       <span class="keywordflow">return</span> <a class="code" href="a00020.html#415ad1a43ac79c02c294a4e32246c519">file_write_buf</a>( string, u16_size_string );
<a name="l00711"></a>00711    }
<a name="l00712"></a>00712 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="d0fc50dbdd1849e9fe0e81b215ce9335"></a><!-- doxytag: member="file.c::file_read" ref="d0fc50dbdd1849e9fe0e81b215ce9335" args="(Fs_file_segment _MEM_TYPE_SLOW_ *segment)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool file_read           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">Fs_file_segment</a> _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>segment</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction return a continue physical memory segment corresponding at a file to read. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>segment</em>&nbsp;</td><td>Pointer on the segment structure: <br>
 -&gt;u32_size_or_pos IN, shall containt the maximum number of sector to read in file (0 = unlimited) <br>
 -&gt;u32_size_or_pos OUT, containt the segment size (unit sector) <br>
 -&gt;other IN, ignored <br>
 -&gt;other OUT, containt the segment position <br>
</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>FALSE in case of error, see global value "fs_g_status" for more detail <p>
TRUE otherwise</dd></dl>
<div class="fragment"><pre class="fragment">
//! This routine is interesting to read a file via a DMA and avoid the file system decode
//! because this routine return a physical memory segment without File System data.
//! Note: the file can be fragmented and it can be necessary to call several time file_read().
//! </pre></div> 
<p>
Definition at line <a class="el" href="a00036.html#l00194">194</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00033.html#l01026">fat_read_file()</a>, <a class="el" href="a00036.html#l00872">file_eof()</a>, <a class="el" href="a00036.html#l00169">file_load_segment_value()</a>, <a class="el" href="a00038.html#l00142">FOPEN_READ_ACCESS</a>, <a class="el" href="a00034.html#l00229">FS_CLUST_ACT_SEG</a>, <a class="el" href="a00038.html#l00223">FS_ERR_EOF</a>, <a class="el" href="a00038.html#l00217">FS_ERR_OUT_LIST</a>, <a class="el" href="a00038.html#l00221">FS_ERR_WRITE_ONLY</a>, <a class="el" href="a00034.html#l00369">fs_g_nav</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00034.html#l00375">fs_g_seg</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00034.html#l00207">FS_MASK_SIZE_OF_SECTOR</a>, <a class="el" href="a00034.html#l00208">FS_SHIFT_B_TO_SECTOR</a>, <a class="el" href="a00034.html#l00206">FS_SIZE_OF_SECTOR</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>, <a class="el" href="a00034.html#l00300">Fs_segment::u32_size_or_pos</a>, <a class="el" href="a00034.html#l00263">Fs_management::u8_BPB_SecPerClus</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.
<p>
Referenced by <a class="el" href="a00042.html#l02112">nav_file_paste_state()</a>.<div class="fragment"><pre class="fragment"><a name="l00195"></a>00195 {
<a name="l00196"></a>00196    U8 u8_nb_sector_truncated;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00199"></a>00199       <span class="keywordflow">return</span> FALSE;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201    <span class="keywordflow">if</span>(!(<a class="code" href="a00022.html#20c8ba8042cb1e42ca50f71cc542cf2b">FOPEN_READ_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>))
<a name="l00202"></a>00202    {
<a name="l00203"></a>00203       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#c925d8d9a6cff3449f9631952c3790a3">FS_ERR_WRITE_ONLY</a>;
<a name="l00204"></a>00204       <span class="keywordflow">return</span> FALSE;
<a name="l00205"></a>00205    }
<a name="l00206"></a>00206    
<a name="l00207"></a>00207    <span class="keywordflow">if</span> ( <a class="code" href="a00020.html#bed52ba7230c6eecf100a3709b9ed74e">file_eof</a>() )
<a name="l00208"></a>00208    {
<a name="l00209"></a>00209       <span class="comment">// End of the file</span>
<a name="l00210"></a>00210       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#ca57c3036b23f86097252cfe4bb6b9c8">FS_ERR_EOF</a>;
<a name="l00211"></a>00211       <span class="keywordflow">return</span> FALSE;
<a name="l00212"></a>00212    }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>(<a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a>))
<a name="l00215"></a>00215    {
<a name="l00216"></a>00216       <span class="keywordflow">if</span>( <a class="code" href="a00022.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l00217"></a>00217          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#ca57c3036b23f86097252cfe4bb6b9c8">FS_ERR_EOF</a>;  <span class="comment">// translate the error</span>
<a name="l00218"></a>00218       <span class="keywordflow">return</span> FALSE;
<a name="l00219"></a>00219    }
<a name="l00220"></a>00220    <span class="comment">// Truncate the segment found if more larger than size asked</span>
<a name="l00221"></a>00221    <span class="keywordflow">if</span>( (segment-&gt;u32_size_or_pos != 0)  <span class="comment">// if not undefine limit</span>
<a name="l00222"></a>00222    &amp;&amp;  (segment-&gt;u32_size_or_pos &lt; <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>) )
<a name="l00223"></a>00223    {
<a name="l00224"></a>00224       u8_nb_sector_truncated   = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> - segment-&gt;u32_size_or_pos;
<a name="l00225"></a>00225       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = segment-&gt;u32_size_or_pos ;
<a name="l00226"></a>00226    }<span class="keywordflow">else</span>{
<a name="l00227"></a>00227       u8_nb_sector_truncated = 0;
<a name="l00228"></a>00228    }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230    <span class="comment">// Update position file</span>
<a name="l00231"></a>00231    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> += (U32)<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> * <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;
<a name="l00232"></a>00232    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> &lt; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> )
<a name="l00233"></a>00233    {  
<a name="l00234"></a>00234       <span class="comment">// Limit the read</span>
<a name="l00235"></a>00235       <span class="comment">// FYC: this case is posible, if the end of file isn't at the end of cluster</span>
<a name="l00236"></a>00236       <span class="comment">// compute the sector not used by file      </span>
<a name="l00237"></a>00237       U8 u8_nb_sector_not_used;
<a name="l00238"></a>00238       
<a name="l00239"></a>00239       <span class="comment">// Compute the number of sector used in last cluster</span>
<a name="l00240"></a>00240       <span class="comment">// remark: also the two first byte of size is used, because the cluster size can't be more larger</span>
<a name="l00241"></a>00241       u8_nb_sector_not_used = LSB1( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> ) &gt;&gt; (<a class="code" href="a00018.html#90491f94e13d340a9d3f98e57a66e9d3">FS_SHIFT_B_TO_SECTOR</a>-8);
<a name="l00242"></a>00242       <span class="keywordflow">if</span>( 0 != (<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> &amp; <a class="code" href="a00018.html#7090b63e1693b160aaebf802dfd8e05a">FS_MASK_SIZE_OF_SECTOR</a>) )
<a name="l00243"></a>00243       {  <span class="comment">// last sector of file isn't full, but it must be read</span>
<a name="l00244"></a>00244          u8_nb_sector_not_used++;
<a name="l00245"></a>00245       }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247       <span class="comment">// Compute the number of sector not used in last cluster</span>
<a name="l00248"></a>00248       u8_nb_sector_not_used = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a> - (u8_nb_sector_not_used % <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>);
<a name="l00249"></a>00249       <span class="comment">// if all space of cluster isn't used, then it is wrong</span>
<a name="l00250"></a>00250       <span class="keywordflow">if</span>( u8_nb_sector_not_used == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a> )
<a name="l00251"></a>00251          u8_nb_sector_not_used = 0; <span class="comment">// The file use all last cluster</span>
<a name="l00252"></a>00252 
<a name="l00253"></a>00253       <span class="comment">// subtract this value a the position and segment</span>
<a name="l00254"></a>00254       u8_nb_sector_not_used -= u8_nb_sector_truncated;
<a name="l00255"></a>00255       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> -= u8_nb_sector_not_used; <span class="comment">// Unit sector</span>
<a name="l00256"></a>00256       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> -= ((U16)u8_nb_sector_not_used) &lt;&lt; <a class="code" href="a00018.html#90491f94e13d340a9d3f98e57a66e9d3">FS_SHIFT_B_TO_SECTOR</a>;   <span class="comment">// unit byte</span>
<a name="l00257"></a>00257    }
<a name="l00258"></a>00258    <a class="code" href="a00020.html#78d70fef5fc9bc7ef9e812175423e2fd">file_load_segment_value</a>( segment );
<a name="l00259"></a>00259    <span class="keywordflow">return</span> TRUE;
<a name="l00260"></a>00260 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7b7c08bde8cb93a792dd578cf4310d0a"></a><!-- doxytag: member="file.c::file_read_buf" ref="7b7c08bde8cb93a792dd578cf4310d0a" args="(U8 _MEM_TYPE_SLOW_ *buffer, U16 u16_buf_size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 file_read_buf           </td>
          <td>(</td>
          <td class="paramtype">U8 _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&nbsp;</td>
          <td class="paramname"> <em>u16_buf_size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction copy in data buffer the data file corresponding at the current position. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer</em>&nbsp;</td><td>buffer to fill </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>u16_buf_size</em>&nbsp;</td><td>buffer size</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>number of byte read <p>
0, in case of error </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00271">271</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>, <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00033.html#l01026">fat_read_file()</a>, <a class="el" href="a00036.html#l00872">file_eof()</a>, <a class="el" href="a00038.html#l00142">FOPEN_READ_ACCESS</a>, <a class="el" href="a00034.html#l00230">FS_CLUST_ACT_ONE</a>, <a class="el" href="a00034.html#l00229">FS_CLUST_ACT_SEG</a>, <a class="el" href="a00038.html#l00223">FS_ERR_EOF</a>, <a class="el" href="a00038.html#l00192">FS_ERR_HW</a>, <a class="el" href="a00038.html#l00217">FS_ERR_OUT_LIST</a>, <a class="el" href="a00038.html#l00221">FS_ERR_WRITE_ONLY</a>, <a class="el" href="a00034.html#l00369">fs_g_nav</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00034.html#l00390">fs_g_sector</a>, <a class="el" href="a00034.html#l00375">fs_g_seg</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00034.html#l00206">FS_SIZE_OF_SECTOR</a>, <a class="el" href="a00031.html#l00419">memory_2_ram()</a>, <a class="el" href="a00034.html#l00299">Fs_segment::u32_addr</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>, <a class="el" href="a00034.html#l00300">Fs_segment::u32_size_or_pos</a>, <a class="el" href="a00034.html#l00259">Fs_management::u8_lun</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.
<p>
Referenced by <a class="el" href="a00036.html#l00387">file_gets()</a>, and <a class="el" href="a00039.html#l00213">read()</a>.<div class="fragment"><pre class="fragment"><a name="l00272"></a>00272 {
<a name="l00273"></a>00273    _MEM_TYPE_FAST_ U16 u16_nb_read_tmp;
<a name="l00274"></a>00274    _MEM_TYPE_FAST_ U16 u16_nb_read;
<a name="l00275"></a>00275    _MEM_TYPE_FAST_ U16 u16_pos_in_sector;
<a name="l00276"></a>00276    _MEM_TYPE_FAST_ U32 u32_byte_remaining;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00279"></a>00279       <span class="keywordflow">return</span> FALSE;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281    <span class="keywordflow">if</span>(!(<a class="code" href="a00022.html#20c8ba8042cb1e42ca50f71cc542cf2b">FOPEN_READ_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>))
<a name="l00282"></a>00282    {
<a name="l00283"></a>00283       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#c925d8d9a6cff3449f9631952c3790a3">FS_ERR_WRITE_ONLY</a>;
<a name="l00284"></a>00284       <span class="keywordflow">return</span> FALSE;
<a name="l00285"></a>00285    }
<a name="l00286"></a>00286    
<a name="l00287"></a>00287    u16_nb_read = 0;  <span class="comment">// Init to "no data read"</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289    <span class="keywordflow">while</span>( 0 != u16_buf_size )
<a name="l00290"></a>00290    {
<a name="l00291"></a>00291       <span class="keywordflow">if</span> ( <a class="code" href="a00020.html#bed52ba7230c6eecf100a3709b9ed74e">file_eof</a>() )
<a name="l00292"></a>00292       {
<a name="l00293"></a>00293          <span class="comment">// End of the file</span>
<a name="l00294"></a>00294          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#ca57c3036b23f86097252cfe4bb6b9c8">FS_ERR_EOF</a>;
<a name="l00295"></a>00295          <span class="keywordflow">return</span> u16_nb_read;
<a name="l00296"></a>00296       }
<a name="l00297"></a>00297       u32_byte_remaining = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>-<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>;
<a name="l00298"></a>00298       u16_pos_in_sector = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> % <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300       <span class="keywordflow">if</span>( (0== u16_pos_in_sector)
<a name="l00301"></a>00301       &amp;&amp;  (<a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> &lt;= u32_byte_remaining)
<a name="l00302"></a>00302       &amp;&amp;  (<a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> &lt;= u16_buf_size))
<a name="l00303"></a>00303       {
<a name="l00304"></a>00304          <span class="keywordflow">if</span>( u16_buf_size &lt;= u32_byte_remaining)
<a name="l00305"></a>00305          {
<a name="l00306"></a>00306             u16_nb_read_tmp = u16_buf_size;
<a name="l00307"></a>00307          }<span class="keywordflow">else</span>{
<a name="l00308"></a>00308             u16_nb_read_tmp = u32_byte_remaining;
<a name="l00309"></a>00309          }
<a name="l00310"></a>00310          u16_nb_read_tmp = u16_nb_read_tmp / <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;  <span class="comment">// read a modulo sector size</span>
<a name="l00311"></a>00311 
<a name="l00312"></a>00312          <span class="comment">// It is possible to read more than sector</span>
<a name="l00313"></a>00313          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>(<a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a>))
<a name="l00314"></a>00314          {
<a name="l00315"></a>00315             <span class="keywordflow">if</span>( <a class="code" href="a00022.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l00316"></a>00316                <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#ca57c3036b23f86097252cfe4bb6b9c8">FS_ERR_EOF</a>;  <span class="comment">// translate the error</span>
<a name="l00317"></a>00317             <span class="keywordflow">return</span> u16_nb_read;
<a name="l00318"></a>00318          }
<a name="l00319"></a>00319          <span class="comment">// Truncate the segment found if more larger than size asked</span>
<a name="l00320"></a>00320          <span class="keywordflow">if</span>( u16_nb_read_tmp &gt; <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> )
<a name="l00321"></a>00321          {
<a name="l00322"></a>00322             u16_nb_read_tmp = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00323"></a>00323          }<span class="keywordflow">else</span>{
<a name="l00324"></a>00324             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = u16_nb_read_tmp;
<a name="l00325"></a>00325          }
<a name="l00326"></a>00326          
<a name="l00327"></a>00327          <span class="comment">// Fill buffer directly</span>
<a name="l00328"></a>00328          <span class="keywordflow">while</span>( 0 != <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> )
<a name="l00329"></a>00329          {
<a name="l00330"></a>00330             <span class="keywordflow">if</span>( <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> != <a class="code" href="a00015.html#dde05eb39b542eb5a7d3f78cf7006f28">memory_2_ram</a>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>  , <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>, buffer))
<a name="l00331"></a>00331             {
<a name="l00332"></a>00332                <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#cf37e5255ee1dbfaab77def32a7cbbef">FS_ERR_HW</a>;
<a name="l00333"></a>00333                <span class="keywordflow">return</span> u16_nb_read;
<a name="l00334"></a>00334             }
<a name="l00335"></a>00335             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>--;
<a name="l00336"></a>00336             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>++;
<a name="l00337"></a>00337             buffer += <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;
<a name="l00338"></a>00338          }
<a name="l00339"></a>00339          <span class="comment">// Translate to Byte unit</span>
<a name="l00340"></a>00340          u16_nb_read_tmp *= <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;
<a name="l00341"></a>00341       }
<a name="l00342"></a>00342       <span class="keywordflow">else</span>
<a name="l00343"></a>00343       {
<a name="l00344"></a>00344          <span class="comment">// Get current file sector in internal FS buffer</span>
<a name="l00345"></a>00345          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>( <a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a> ))
<a name="l00346"></a>00346          {
<a name="l00347"></a>00347             <span class="keywordflow">if</span>( <a class="code" href="a00022.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l00348"></a>00348             {  <span class="comment">// Translate the error</span>
<a name="l00349"></a>00349                <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#ca57c3036b23f86097252cfe4bb6b9c8">FS_ERR_EOF</a>;   <span class="comment">// End of file</span>
<a name="l00350"></a>00350             }
<a name="l00351"></a>00351             <span class="keywordflow">return</span> u16_nb_read;
<a name="l00352"></a>00352          }
<a name="l00353"></a>00353          
<a name="l00354"></a>00354          <span class="comment">// Compute the number of data to transfer</span>
<a name="l00355"></a>00355          u16_nb_read_tmp = <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> - u16_pos_in_sector;  <span class="comment">// Compute the maximum to next sector limit</span>
<a name="l00356"></a>00356          <span class="keywordflow">if</span>( u16_nb_read_tmp &gt; u32_byte_remaining )
<a name="l00357"></a>00357             u16_nb_read_tmp = u32_byte_remaining;
<a name="l00358"></a>00358          <span class="keywordflow">if</span>( u16_nb_read_tmp &gt; u16_buf_size )
<a name="l00359"></a>00359             u16_nb_read_tmp = u16_buf_size;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361          <span class="comment">// Fill buffer</span>
<a name="l00362"></a>00362          memcpy_ram2ram( buffer , &amp;<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_pos_in_sector ], u16_nb_read_tmp );
<a name="l00363"></a>00363          buffer += u16_nb_read_tmp;
<a name="l00364"></a>00364       }
<a name="l00365"></a>00365       <span class="comment">// Update positions</span>
<a name="l00366"></a>00366       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>   += u16_nb_read_tmp;
<a name="l00367"></a>00367       u16_nb_read                      += u16_nb_read_tmp;
<a name="l00368"></a>00368       u16_buf_size                     -= u16_nb_read_tmp;
<a name="l00369"></a>00369    }
<a name="l00370"></a>00370    <span class="keywordflow">return</span> u16_nb_read;  <span class="comment">// Buffer is full</span>
<a name="l00371"></a>00371 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="2599f935c7e1b69f2650e0943091ddca"></a><!-- doxytag: member="file.c::file_seek" ref="2599f935c7e1b69f2650e0943091ddca" args="(U32 u32_pos, U8 u8_whence)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool file_seek           </td>
          <td>(</td>
          <td class="paramtype">U32&nbsp;</td>
          <td class="paramname"> <em>u32_pos</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8&nbsp;</td>
          <td class="paramname"> <em>u8_whence</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction change the position in file selected. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>u32_pos</em>&nbsp;</td><td>number of byte to seek </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>u8_whence</em>&nbsp;</td><td>direction of seek <br>
 FS_SEEK_SET , start at the beginning and foward <br>
 FS_SEEK_END , start at the end of file and rewind <br>
 FS_SEEK_CUR_RE, start at the current position and rewind <br>
 FS_SEEK_CUR_FW, start at the current position and foward <br>
</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>FALSE in case of error, see global value "fs_g_status" for more detail <p>
TRUE otherwise </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00799">799</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00038.html#l00198">FS_ERR_BAD_POS</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00037.html#l00058">FS_SEEK_CUR_FW</a>, <a class="el" href="a00037.html#l00057">FS_SEEK_CUR_RE</a>, <a class="el" href="a00037.html#l00056">FS_SEEK_END</a>, <a class="el" href="a00037.html#l00055">FS_SEEK_SET</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, and <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>.
<p>
Referenced by <a class="el" href="a00036.html#l00387">file_gets()</a>, and <a class="el" href="a00042.html#l02112">nav_file_paste_state()</a>.<div class="fragment"><pre class="fragment"><a name="l00800"></a>00800 {
<a name="l00801"></a>00801    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00802"></a>00802       <span class="keywordflow">return</span> FALSE;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804    <span class="keywordflow">switch</span>(u8_whence)
<a name="l00805"></a>00805    {
<a name="l00806"></a>00806       <span class="keywordflow">case</span> <a class="code" href="a00021.html#f546c33414158e18f0a25b795f402ccf">FS_SEEK_CUR_RE</a>:
<a name="l00807"></a>00807       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &lt; u32_pos )
<a name="l00808"></a>00808       {  <span class="comment">// Out of the limit</span>
<a name="l00809"></a>00809          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#f4ab016e71c9e6afeba9e0742ced5489">FS_ERR_BAD_POS</a>;
<a name="l00810"></a>00810          <span class="keywordflow">return</span> FALSE;
<a name="l00811"></a>00811       }
<a name="l00812"></a>00812       <span class="comment">// update the position</span>
<a name="l00813"></a>00813       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> -= u32_pos;
<a name="l00814"></a>00814       <span class="keywordflow">break</span>;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816       <span class="keywordflow">case</span> <a class="code" href="a00021.html#5b33d405a458db1db212d345b21454f8">FS_SEEK_SET</a>:
<a name="l00817"></a>00817       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> &lt; u32_pos )
<a name="l00818"></a>00818       {  <span class="comment">// Out of the limit</span>
<a name="l00819"></a>00819          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#f4ab016e71c9e6afeba9e0742ced5489">FS_ERR_BAD_POS</a>;
<a name="l00820"></a>00820          <span class="keywordflow">return</span> FALSE;
<a name="l00821"></a>00821       }
<a name="l00822"></a>00822       <span class="comment">// update the position</span>
<a name="l00823"></a>00823       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> = u32_pos;
<a name="l00824"></a>00824       <span class="keywordflow">break</span>;
<a name="l00825"></a>00825 
<a name="l00826"></a>00826       <span class="keywordflow">case</span> <a class="code" href="a00021.html#ea9734cc236a73aefd3b35444d08d39d">FS_SEEK_END</a>:
<a name="l00827"></a>00827       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> &lt; u32_pos )
<a name="l00828"></a>00828       {  <span class="comment">// Out of the limit</span>
<a name="l00829"></a>00829          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#f4ab016e71c9e6afeba9e0742ced5489">FS_ERR_BAD_POS</a>;
<a name="l00830"></a>00830          <span class="keywordflow">return</span> FALSE;
<a name="l00831"></a>00831       }
<a name="l00832"></a>00832       <span class="comment">// update the position</span>
<a name="l00833"></a>00833       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> - u32_pos;
<a name="l00834"></a>00834       <span class="keywordflow">break</span>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836       <span class="keywordflow">case</span> <a class="code" href="a00021.html#01e59ff6cd5b11d231625f45311afebc">FS_SEEK_CUR_FW</a>:
<a name="l00837"></a>00837       u32_pos += <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>;
<a name="l00838"></a>00838       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> &lt; u32_pos )
<a name="l00839"></a>00839       {  <span class="comment">// Out of the limit</span>
<a name="l00840"></a>00840          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#f4ab016e71c9e6afeba9e0742ced5489">FS_ERR_BAD_POS</a>;
<a name="l00841"></a>00841          <span class="keywordflow">return</span> FALSE;
<a name="l00842"></a>00842       }
<a name="l00843"></a>00843       <span class="comment">// update the position</span>
<a name="l00844"></a>00844       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> = u32_pos;
<a name="l00845"></a>00845       <span class="keywordflow">break</span>;
<a name="l00846"></a>00846    }
<a name="l00847"></a>00847    <span class="keywordflow">return</span> TRUE;
<a name="l00848"></a>00848 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="07a8faa41a278961fccc5c0793b01ab1"></a><!-- doxytag: member="file.c::file_set_eof" ref="07a8faa41a278961fccc5c0793b01ab1" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool file_set_eof           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction set the end of file at the current position. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>FALSE in case of error, see global value "fs_g_status" for more detail <p>
TRUE otherwise</dd></dl>
<div class="fragment"><pre class="fragment">
//! This routine is use after the last file_write() call.
//! The file_write() routine work on sector (512B) unit,
//! and you can set a Byte size with file_seek() and this routine.
//! </pre></div> 
<p>
Definition at line <a class="el" href="a00036.html#l00577">577</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l01810">fat_cache_flush()</a>, <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00033.html#l01026">fat_read_file()</a>, <a class="el" href="a00038.html#l00143">FOPEN_WRITE_ACCESS</a>, <a class="el" href="a00034.html#l00231">FS_CLUST_ACT_CLR</a>, <a class="el" href="a00038.html#l00212">FS_ERR_READ_ONLY</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.
<p>
Referenced by <a class="el" href="a00042.html#l02112">nav_file_paste_state()</a>.<div class="fragment"><pre class="fragment"><a name="l00578"></a>00578 {
<a name="l00579"></a>00579    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00580"></a>00580       <span class="keywordflow">return</span> FALSE;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582    <span class="keywordflow">if</span>(!(<a class="code" href="a00022.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>))
<a name="l00583"></a>00583    {
<a name="l00584"></a>00584       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#9a1684b2e22ad307513e0e62b66f9517">FS_ERR_READ_ONLY</a>;
<a name="l00585"></a>00585       <span class="keywordflow">return</span> FALSE;
<a name="l00586"></a>00586    }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588    <span class="comment">// Update the file size</span>
<a name="l00589"></a>00589    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#d8c9c9a63c821e8cea06c340c029668d">fat_read_file</a>( <a class="code" href="a00018.html#b314d14ba33772e9bcbae993a8d17e9f">FS_CLUST_ACT_CLR</a> ))
<a name="l00592"></a>00592       <span class="keywordflow">return</span> FALSE;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594    <span class="keywordflow">return</span> <a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>();
<a name="l00595"></a>00595 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="539e0dd44b9da051430f1a89715477fa"></a><!-- doxytag: member="file.c::file_string_ascii" ref="539e0dd44b9da051430f1a89715477fa" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void file_string_ascii           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction select the ASCII mode for the routines getc() and putc(). 
<p>

<p>
Definition at line <a class="el" href="a00036.html#l00083">83</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00036.html#l00063">g_b_file_unicode</a>.<div class="fragment"><pre class="fragment"><a name="l00084"></a>00084 {
<a name="l00085"></a>00085    <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> = FALSE;
<a name="l00086"></a>00086 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="6d8e84352a2ed376cd9d8c3b74ffe410"></a><!-- doxytag: member="file.c::file_string_unicode" ref="6d8e84352a2ed376cd9d8c3b74ffe410" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void file_string_unicode           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction select the UNICODE mode for the routines getc() and putc(). 
<p>

<p>
Definition at line <a class="el" href="a00036.html#l00076">76</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00036.html#l00063">g_b_file_unicode</a>.<div class="fragment"><pre class="fragment"><a name="l00077"></a>00077 {
<a name="l00078"></a>00078    <a class="code" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> = TRUE;
<a name="l00079"></a>00079 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="1b5c29ddedddd73a1279b9920ea1642f"></a><!-- doxytag: member="file.c::file_write" ref="1b5c29ddedddd73a1279b9920ea1642f" args="(Fs_file_segment _MEM_TYPE_SLOW_ *segment)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool file_write           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00002.html">Fs_file_segment</a> _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>segment</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction return a continue physical memory segment corresponding at a file to write. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>segment</em>&nbsp;</td><td>Pointer on the segment structure: <br>
 -&gt;u32_size_or_pos IN, shall containt the maximum number of sector to write in file (0 = maximum) <br>
 -&gt;u32_size_or_pos OUT, containt the segment size (unit sector) <br>
 -&gt;other IN, ignored <br>
 -&gt;other OUT, containt the segment position <br>
</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>FALSE in case of error, see global value "fs_g_status" for more detail <p>
TRUE otherwise</dd></dl>
<div class="fragment"><pre class="fragment">
//! This routine is interesting to write a file via a DMA and avoid the file system decode
//! because this routine return a physical memory segment without File System data.
//! Note: the file can be fragmented and it can be necessary to call several time file_write().
//! </pre></div> 
<p>
Definition at line <a class="el" href="a00036.html#l00532">532</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00033.html#l01108">fat_write_file()</a>, <a class="el" href="a00036.html#l00169">file_load_segment_value()</a>, <a class="el" href="a00038.html#l00143">FOPEN_WRITE_ACCESS</a>, <a class="el" href="a00034.html#l00229">FS_CLUST_ACT_SEG</a>, <a class="el" href="a00038.html#l00212">FS_ERR_READ_ONLY</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00034.html#l00375">fs_g_seg</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00034.html#l00206">FS_SIZE_OF_SECTOR</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>, <a class="el" href="a00034.html#l00300">Fs_segment::u32_size_or_pos</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.
<p>
Referenced by <a class="el" href="a00042.html#l02112">nav_file_paste_state()</a>.<div class="fragment"><pre class="fragment"><a name="l00533"></a>00533 {
<a name="l00534"></a>00534    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00535"></a>00535       <span class="keywordflow">return</span> FALSE;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537    <span class="keywordflow">if</span>(!(<a class="code" href="a00022.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>))
<a name="l00538"></a>00538    {
<a name="l00539"></a>00539       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#9a1684b2e22ad307513e0e62b66f9517">FS_ERR_READ_ONLY</a>;
<a name="l00540"></a>00540       <span class="keywordflow">return</span> FALSE;
<a name="l00541"></a>00541    }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8723a199c01163d9f9839bd42ac60693">fat_write_file</a>( <a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> , segment-&gt;u32_size_or_pos ))
<a name="l00544"></a>00544       <span class="keywordflow">return</span> FALSE;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546    <span class="comment">// Truncate the segment found if more larger than size asked</span>
<a name="l00547"></a>00547    <span class="keywordflow">if</span>( (segment-&gt;u32_size_or_pos != 0)  <span class="comment">// if not undefine limit</span>
<a name="l00548"></a>00548    &amp;&amp;  (segment-&gt;u32_size_or_pos &lt; <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>) )
<a name="l00549"></a>00549    {
<a name="l00550"></a>00550       <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = segment-&gt;u32_size_or_pos ;
<a name="l00551"></a>00551    }
<a name="l00552"></a>00552    
<a name="l00553"></a>00553    <span class="comment">// Update position file</span>
<a name="l00554"></a>00554    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> += ((U32)<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> * <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>);
<a name="l00555"></a>00555    
<a name="l00556"></a>00556    <span class="comment">// Update the file size</span>
<a name="l00557"></a>00557    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &gt; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> )
<a name="l00558"></a>00558    {
<a name="l00559"></a>00559       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>;
<a name="l00560"></a>00560    }
<a name="l00561"></a>00561    <a class="code" href="a00020.html#78d70fef5fc9bc7ef9e812175423e2fd">file_load_segment_value</a>( segment );
<a name="l00562"></a>00562    <span class="keywordflow">return</span> TRUE;
<a name="l00563"></a>00563 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="415ad1a43ac79c02c294a4e32246c519"></a><!-- doxytag: member="file.c::file_write_buf" ref="415ad1a43ac79c02c294a4e32246c519" args="(U8 _MEM_TYPE_SLOW_ *buffer, U16 u16_buf_size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 file_write_buf           </td>
          <td>(</td>
          <td class="paramtype">U8 _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&nbsp;</td>
          <td class="paramname"> <em>u16_buf_size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction copy the data buffer in file at the current position. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer</em>&nbsp;</td><td>data buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>u16_buf_size</em>&nbsp;</td><td>data size</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>number of byte write <p>
0, in case of error </dd></dl>

<p>
Definition at line <a class="el" href="a00036.html#l00606">606</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
References <a class="el" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>, <a class="el" href="a00033.html#l01798">fat_cache_sector_is_modify()</a>, <a class="el" href="a00033.html#l00260">fat_check_mount_select_open()</a>, <a class="el" href="a00033.html#l01108">fat_write_file()</a>, <a class="el" href="a00038.html#l00143">FOPEN_WRITE_ACCESS</a>, <a class="el" href="a00034.html#l00230">FS_CLUST_ACT_ONE</a>, <a class="el" href="a00034.html#l00229">FS_CLUST_ACT_SEG</a>, <a class="el" href="a00038.html#l00192">FS_ERR_HW</a>, <a class="el" href="a00038.html#l00212">FS_ERR_READ_ONLY</a>, <a class="el" href="a00034.html#l00369">fs_g_nav</a>, <a class="el" href="a00034.html#l00371">fs_g_nav_entry</a>, <a class="el" href="a00034.html#l00390">fs_g_sector</a>, <a class="el" href="a00034.html#l00375">fs_g_seg</a>, <a class="el" href="a00038.html#l00257">fs_g_status</a>, <a class="el" href="a00034.html#l00206">FS_SIZE_OF_SECTOR</a>, <a class="el" href="a00031.html#l00440">ram_2_memory()</a>, <a class="el" href="a00034.html#l00299">Fs_segment::u32_addr</a>, <a class="el" href="a00034.html#l00289">Fs_management_entry::u32_pos_in_file</a>, <a class="el" href="a00034.html#l00288">Fs_management_entry::u32_size</a>, <a class="el" href="a00034.html#l00300">Fs_segment::u32_size_or_pos</a>, <a class="el" href="a00034.html#l00259">Fs_management::u8_lun</a>, and <a class="el" href="a00034.html#l00285">Fs_management_entry::u8_open_mode</a>.
<p>
Referenced by <a class="el" href="a00036.html#l00701">file_puts()</a>, and <a class="el" href="a00039.html#l00250">write()</a>.<div class="fragment"><pre class="fragment"><a name="l00607"></a>00607 {
<a name="l00608"></a>00608    _MEM_TYPE_FAST_ U16 u16_nb_write_tmp;
<a name="l00609"></a>00609    _MEM_TYPE_FAST_ U16 u16_nb_write;
<a name="l00610"></a>00610    _MEM_TYPE_FAST_ U16 u16_pos_in_sector;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#0096f66037f89595dfccbca38ab795f8">fat_check_mount_select_open</a>())
<a name="l00613"></a>00613       <span class="keywordflow">return</span> FALSE;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615    <span class="keywordflow">if</span>(!(<a class="code" href="a00022.html#2315e5a3aea8aa74d67e855a926d3921">FOPEN_WRITE_ACCESS</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#316b7df1bf2c7e55453f17ad00290447">u8_open_mode</a>))
<a name="l00616"></a>00616    {
<a name="l00617"></a>00617       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#9a1684b2e22ad307513e0e62b66f9517">FS_ERR_READ_ONLY</a>;
<a name="l00618"></a>00618       <span class="keywordflow">return</span> FALSE;
<a name="l00619"></a>00619    }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621    u16_nb_write = 0;  <span class="comment">// Init to "no data read"</span>
<a name="l00622"></a>00622 
<a name="l00623"></a>00623    <span class="keywordflow">while</span>( 0 != u16_buf_size )
<a name="l00624"></a>00624    {
<a name="l00625"></a>00625       u16_pos_in_sector = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> % <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;
<a name="l00626"></a>00626       <span class="keywordflow">if</span>( (0== u16_pos_in_sector)
<a name="l00627"></a>00627       &amp;&amp;  (<a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> &lt;= u16_buf_size))
<a name="l00628"></a>00628       {
<a name="l00629"></a>00629          u16_nb_write_tmp = u16_buf_size / <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;  <span class="comment">// read a modulo sector size</span>
<a name="l00630"></a>00630 
<a name="l00631"></a>00631          <span class="comment">// It is possible to read more than sector</span>
<a name="l00632"></a>00632          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8723a199c01163d9f9839bd42ac60693">fat_write_file</a>( <a class="code" href="a00018.html#67f38f48a73531bf4bcd7bf87c7b1db5">FS_CLUST_ACT_SEG</a> , u16_nb_write_tmp ))
<a name="l00633"></a>00633             <span class="keywordflow">return</span> FALSE;
<a name="l00634"></a>00634          
<a name="l00635"></a>00635          <span class="comment">// Truncate the segment found if more larger than size asked</span>
<a name="l00636"></a>00636          <span class="keywordflow">if</span>( u16_nb_write_tmp &lt; <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>)
<a name="l00637"></a>00637          {
<a name="l00638"></a>00638             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = u16_nb_write_tmp;
<a name="l00639"></a>00639          }<span class="keywordflow">else</span>{
<a name="l00640"></a>00640             u16_nb_write_tmp = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>;
<a name="l00641"></a>00641          }
<a name="l00642"></a>00642    
<a name="l00643"></a>00643          <span class="comment">// Fill buffer directly</span>
<a name="l00644"></a>00644          <span class="keywordflow">while</span>( 0 != <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> )
<a name="l00645"></a>00645          {
<a name="l00646"></a>00646             <span class="keywordflow">if</span>( <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> != <a class="code" href="a00015.html#61739dc73f8bff39c3d291f2e47a5bce">ram_2_memory</a>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>  , <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>, buffer))
<a name="l00647"></a>00647             {
<a name="l00648"></a>00648                <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#cf37e5255ee1dbfaab77def32a7cbbef">FS_ERR_HW</a>;
<a name="l00649"></a>00649                <span class="keywordflow">return</span> u16_nb_write;
<a name="l00650"></a>00650             }
<a name="l00651"></a>00651             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a>--;
<a name="l00652"></a>00652             <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>++;
<a name="l00653"></a>00653             buffer += <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;
<a name="l00654"></a>00654          }
<a name="l00655"></a>00655          <span class="comment">// Translate to Byte unit</span>
<a name="l00656"></a>00656          u16_nb_write_tmp *= <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a>;
<a name="l00657"></a>00657       }
<a name="l00658"></a>00658       <span class="keywordflow">else</span>
<a name="l00659"></a>00659       {
<a name="l00660"></a>00660          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8723a199c01163d9f9839bd42ac60693">fat_write_file</a>( <a class="code" href="a00018.html#b24c1ca2a8bc9c3e264eb923d3b90666">FS_CLUST_ACT_ONE</a>  , 1 ))
<a name="l00661"></a>00661             <span class="keywordflow">return</span> FALSE;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663          <span class="comment">// Write the data into the cache</span>
<a name="l00664"></a>00664          <a class="code" href="a00017.html#e73cb496ddbf1ab33944f99f1c50f4d0">fat_cache_sector_is_modify</a>();
<a name="l00665"></a>00665                 
<a name="l00666"></a>00666          <span class="comment">// Compute the number of data to transfer</span>
<a name="l00667"></a>00667          u16_nb_write_tmp = <a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> - u16_pos_in_sector;  <span class="comment">// Compute the maximum to next sector limit</span>
<a name="l00668"></a>00668          <span class="keywordflow">if</span>( u16_nb_write_tmp &gt; u16_buf_size )
<a name="l00669"></a>00669             u16_nb_write_tmp = u16_buf_size;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671          <span class="comment">// Fill buffer</span>
<a name="l00672"></a>00672          memcpy_ram2ram( &amp;<a class="code" href="a00018.html#e8fff3e358b2628449a988ca5256f7e6">fs_g_sector</a>[ u16_pos_in_sector ], buffer , u16_nb_write_tmp );
<a name="l00673"></a>00673          buffer += u16_nb_write_tmp;
<a name="l00674"></a>00674       }
<a name="l00675"></a>00675       <span class="comment">// Update positions</span>
<a name="l00676"></a>00676       <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>+= u16_nb_write_tmp;
<a name="l00677"></a>00677       u16_nb_write                  += u16_nb_write_tmp;
<a name="l00678"></a>00678       u16_buf_size                  -= u16_nb_write_tmp;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680       <span class="comment">// Update the file size</span>
<a name="l00681"></a>00681       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a> &gt; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> )
<a name="l00682"></a>00682       {
<a name="l00683"></a>00683          <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#1e1dae249ae6839c1b8cce0fecbbf7af">u32_pos_in_file</a>;
<a name="l00684"></a>00684       }
<a name="l00685"></a>00685    }
<a name="l00686"></a>00686    <span class="keywordflow">return</span> u16_nb_write;  <span class="comment">// All buffer is writed</span>
<a name="l00687"></a>00687 }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="2406ed722978ec6c55dcafa277a86633"></a><!-- doxytag: member="file.c::fs_g_sector" ref="2406ed722978ec6c55dcafa277a86633" args="[FS_SIZE_OF_SECTOR]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ U8 <a class="el" href="a00020.html#2406ed722978ec6c55dcafa277a86633">fs_g_sector</a>[FS_SIZE_OF_SECTOR]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Use the "FAT sector cache" to store a file sector during a <a class="el" href="a00020.html#141d514531c560557a4a50bd17a9e5f8">file_putc()</a> or <a class="el" href="a00020.html#952fd54b2e49943d138e44d3bdf569bf">file_getc()</a> routines. 
<p>

<p>
Definition at line <a class="el" href="a00034.html#l00390">390</a> of file <a class="el" href="a00034.html">fat.h</a>.
<p>
Referenced by <a class="el" href="a00033.html#l01790">fat_cache_clear()</a>, <a class="el" href="a00033.html#l01810">fat_cache_flush()</a>, <a class="el" href="a00033.html#l01742">fat_cache_read_sector()</a>, <a class="el" href="a00033.html#l00815">fat_cluster_readnext()</a>, <a class="el" href="a00033.html#l00619">fat_cluster_val()</a>, <a class="el" href="a00033.html#l00304">fat_get_nbpartition()</a>, <a class="el" href="a00033.html#l01720">fat_get_ptr_entry()</a>, <a class="el" href="a00035.html#l02049">fat_getfreespace_percent()</a>, <a class="el" href="a00035.html#l01154">fat_initialize_dir()</a>, <a class="el" href="a00035.html#l00979">fat_initialize_fat()</a>, <a class="el" href="a00035.html#l00106">fat_mount()</a>, <a class="el" href="a00035.html#l00874">fat_read_fat32_FSInfo()</a>, <a class="el" href="a00035.html#l01017">fat_serialnumber()</a>, <a class="el" href="a00035.html#l00840">fat_write_fat32_FSInfo()</a>, <a class="el" href="a00035.html#l00611">fat_write_MBR()</a>, <a class="el" href="a00035.html#l00719">fat_write_PBR()</a>, <a class="el" href="a00036.html#l00460">file_getc()</a>, <a class="el" href="a00036.html#l00726">file_putc()</a>, <a class="el" href="a00036.html#l00271">file_read_buf()</a>, and <a class="el" href="a00036.html#l00606">file_write_buf()</a>.
</div>
</div><p>
<a class="anchor" name="f088989196e7debe7a437151d4c2ec6a"></a><!-- doxytag: member="file.c::g_b_file_unicode" ref="f088989196e7debe7a437151d4c2ec6a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Bool <a class="el" href="a00020.html#f088989196e7debe7a437151d4c2ec6a">g_b_file_unicode</a> = FALSE          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Internal flag to signal the string format (ASCII, UNICODE) to use for getc() and putc() routines. 
<p>

<p>
Definition at line <a class="el" href="a00036.html#l00063">63</a> of file <a class="el" href="a00036.html">file.c</a>.
<p>
Referenced by <a class="el" href="a00036.html#l00460">file_getc()</a>, <a class="el" href="a00036.html#l00387">file_gets()</a>, <a class="el" href="a00036.html#l00726">file_putc()</a>, <a class="el" href="a00036.html#l00701">file_puts()</a>, <a class="el" href="a00036.html#l00083">file_string_ascii()</a>, and <a class="el" href="a00036.html#l00076">file_string_unicode()</a>.
</div>
</div><p>
<hr size="1"><address style="align: right;"><small>Generated on Thu Sep 20 12:17:17 2007 for AVR32 UC3 - FSACCESS Services by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>
