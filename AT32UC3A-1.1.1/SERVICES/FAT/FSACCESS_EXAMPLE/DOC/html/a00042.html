<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>AVR32 UC3 - FSACCESS Services: navigation.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>navigation.c</h1><a href="a00026.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00017"></a>00017 <span class="comment">/* Copyright (c) 2007, Atmel Corporation All rights reserved.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00020"></a>00020 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
<a name="l00023"></a>00023 <span class="comment"> * this list of conditions and the following disclaimer.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00026"></a>00026 <span class="comment"> * this list of conditions and the following disclaimer in the documentation</span>
<a name="l00027"></a>00027 <span class="comment"> * and/or other materials provided with the distribution.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * 3. The name of ATMEL may not be used to endorse or promote products derived</span>
<a name="l00030"></a>00030 <span class="comment"> * from this software without specific prior written permission.</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ATMEL ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
<a name="l00033"></a>00033 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00034"></a>00034 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY AND</span>
<a name="l00035"></a>00035 <span class="comment"> * SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT,</span>
<a name="l00036"></a>00036 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00038"></a>00038 <span class="comment"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<a name="l00039"></a>00039 <span class="comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00040"></a>00040 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a name="l00041"></a>00041 <span class="comment"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00042"></a>00042 <span class="comment"> */</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">//_____  I N C L U D E S ___________________________________________________</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="a00014.html">conf_explorer.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="a00027.html">navigation.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="a00021.html">file.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include LIB_CTRLACCESS</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">//_____ M A C R O S ________________________________________________________</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">//_____ D E F I N I T I O N S ______________________________________________</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l00058"></a><a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">00058</a> <span class="preprocessor">   _MEM_TYPE_SLOW_ U8 g_id_trans_memtomem = ID_STREAM_ERR;</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>
<a name="l00061"></a>00061 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00063"></a><a class="code" href="a00026.html#b84a05017e426fd46d9eb3698642f133">00063</a> <span class="preprocessor">   _MEM_TYPE_SLOW_ U8 fs_g_u8_nav_selected;</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="comment">//_____ D E C L A R A T I O N S ____________________________________________</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">//**********************************************************************</span>
<a name="l00069"></a>00069 <span class="comment">//************************ String format select ************************</span>
<a name="l00070"></a>00070 <span class="preprocessor">#if( (FS_ASCII == ENABLED) &amp;&amp; (FS_UNICODE == ENABLED))</span>
<a name="l00079"></a><a class="code" href="a00027.html#69ee3def8525352e53819df1f975dd86">00079</a> <span class="preprocessor">void  nav_string_unicode( void )</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>{
<a name="l00081"></a>00081    <a class="code" href="a00018.html#fdc963fda511dd9e790c81b6a6b33d34">g_b_unicode</a> = TRUE;
<a name="l00082"></a>00082 }
<a name="l00091"></a><a class="code" href="a00027.html#7489cf6b312750301cb7df5b915b436a">00091</a> <span class="keywordtype">void</span>  <a class="code" href="a00026.html#7489cf6b312750301cb7df5b915b436a">nav_string_ascii</a>( <span class="keywordtype">void</span> )
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093    <a class="code" href="a00018.html#fdc963fda511dd9e790c81b6a6b33d34">g_b_unicode</a> = FALSE;
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 <span class="preprocessor">#endif</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>
<a name="l00097"></a>00097 <span class="comment">//**********************************************************************</span>
<a name="l00098"></a>00098 <span class="comment">//************** Initialise or Stop navigation module ****************** </span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 
<a name="l00108"></a><a class="code" href="a00027.html#605dfecfa334f8ced2cebfa5162a931b">00108</a> <span class="keywordtype">void</span>  <a class="code" href="a00026.html#605dfecfa334f8ced2cebfa5162a931b">nav_reset</a>( <span class="keywordtype">void</span> )
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110 <span class="preprocessor">#if ( (FS_ASCII   == ENABLED) &amp;&amp; (FS_UNICODE == ENABLED))</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>   <a class="code" href="a00018.html#fdc963fda511dd9e790c81b6a6b33d34">g_b_unicode</a> = TRUE;
<a name="l00112"></a>00112 <span class="preprocessor">#endif</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>
<a name="l00114"></a>00114    <a class="code" href="a00017.html#961692919a93b6cb714ec2a3d57c0141">fat_cache_reset</a>();
<a name="l00115"></a>00115    <a class="code" href="a00017.html#ecb0d4c200bed41b8bdcf671aa931a2a">fat_cache_clusterlist_reset</a>();
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>   {
<a name="l00119"></a>00119    U8 i;
<a name="l00120"></a>00120    <span class="comment">// Reset variable of all navigators</span>
<a name="l00121"></a>00121    <span class="keywordflow">for</span>( i=0 ; i!=<a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a> ; i++ )
<a name="l00122"></a>00122    {
<a name="l00123"></a>00123       <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>(i);
<a name="l00124"></a>00124       <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a> = <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a>; <span class="comment">// By default the fat isn't mounted</span>
<a name="l00125"></a>00125       <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> = 0xFF;                      <span class="comment">// By default select drive 0</span>
<a name="l00126"></a>00126 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>      <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a>=0;                     <span class="comment">// By default select the first partition</span>
<a name="l00128"></a>00128 <span class="preprocessor">#endif</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>      <a class="code" href="a00018.html#8e3b3ddad0e2b4f1747507a2665b0901">Fat_file_close</a>;                              <span class="comment">// By default the file is not open</span>
<a name="l00130"></a>00130    }
<a name="l00131"></a>00131    <span class="comment">// Reset variable of default navigator</span>
<a name="l00132"></a>00132    <a class="code" href="a00026.html#b84a05017e426fd46d9eb3698642f133">fs_g_u8_nav_selected</a> = 0;
<a name="l00133"></a>00133    }
<a name="l00134"></a>00134 <span class="preprocessor">#else</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>   <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a> = <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a>; <span class="comment">// By default the fat isn't mounted</span>
<a name="l00136"></a>00136    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> = 0xFF;                      <span class="comment">// By default select drive 0</span>
<a name="l00137"></a>00137 <span class="preprocessor">#  if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>   <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a>=0;                     <span class="comment">// By default select the first partition</span>
<a name="l00139"></a>00139 <span class="preprocessor">#  endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>   <a class="code" href="a00018.html#8e3b3ddad0e2b4f1747507a2665b0901">Fat_file_close</a>;                              <span class="comment">// By default the file is not open</span>
<a name="l00141"></a>00141 <span class="preprocessor">#endif // (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>}
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 
<a name="l00152"></a><a class="code" href="a00027.html#7fac26539a62daf547b5eb159f6a43d4">00152</a> Bool  <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( U8 u8_idnav )
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154    <span class="keywordflow">if</span>( <a class="code" href="a00014.html#8ab6bd77e49639be7dc419bcf66bd73f">FS_NB_NAVIGATOR</a> &lt;= u8_idnav )
<a name="l00155"></a>00155    {
<a name="l00156"></a>00156       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#6557aec2700008a7501b91d368116ae2">FS_ERR_BAD_NAV</a>; <span class="comment">// The navigator doesn't exist</span>
<a name="l00157"></a>00157       <span class="keywordflow">return</span> FALSE;
<a name="l00158"></a>00158    }
<a name="l00159"></a>00159 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00160"></a>00160 <span class="preprocessor"></span>   <span class="keywordflow">if</span>( <a class="code" href="a00026.html#b84a05017e426fd46d9eb3698642f133">fs_g_u8_nav_selected</a> != u8_idnav )
<a name="l00161"></a>00161    {
<a name="l00162"></a>00162       <a class="code" href="a00017.html#65cfc6e07b1a1bc3a12d564148daca37">fat_invert_nav</a>( <a class="code" href="a00026.html#b84a05017e426fd46d9eb3698642f133">fs_g_u8_nav_selected</a> );   <span class="comment">// Deselect previous navigator = Select default navigator</span>
<a name="l00163"></a>00163       <a class="code" href="a00017.html#65cfc6e07b1a1bc3a12d564148daca37">fat_invert_nav</a>( u8_idnav );               <span class="comment">// Select new navigator</span>
<a name="l00164"></a>00164       fs_g_u8_nav_selected = u8_idnav;
<a name="l00165"></a>00165    }
<a name="l00166"></a>00166 <span class="preprocessor">#endif</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>   <span class="keywordflow">return</span> TRUE;
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 
<a name="l00175"></a><a class="code" href="a00027.html#4a9efd8a5ff4c599be7994c009f0fb5f">00175</a> U8    <a class="code" href="a00026.html#4a9efd8a5ff4c599be7994c009f0fb5f">nav_get</a>( <span class="keywordtype">void</span> )
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>   <span class="keywordflow">return</span> <a class="code" href="a00026.html#b84a05017e426fd46d9eb3698642f133">fs_g_u8_nav_selected</a>;
<a name="l00179"></a>00179 <span class="preprocessor">#else</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l00181"></a>00181 <span class="preprocessor">#endif</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>}
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 
<a name="l00196"></a><a class="code" href="a00027.html#f12a2dc5f9d5ca21f181bdbfdf664652">00196</a> Bool  <a class="code" href="a00026.html#f12a2dc5f9d5ca21f181bdbfdf664652">nav_copy_file_current</a>( U8 u8_idnav )
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198 <span class="preprocessor">#if (FS_NB_NAVIGATOR &gt; 1)</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>   <span class="keywordflow">if</span>( <a class="code" href="a00026.html#b84a05017e426fd46d9eb3698642f133">fs_g_u8_nav_selected</a> == u8_idnav )
<a name="l00200"></a>00200       <span class="keywordflow">return</span> TRUE;  <span class="comment">// It is the source and destination is the same navigator</span>
<a name="l00201"></a>00201    <span class="keywordflow">if</span>( 0 == u8_idnav )
<a name="l00202"></a>00202       u8_idnav = <a class="code" href="a00026.html#b84a05017e426fd46d9eb3698642f133">fs_g_u8_nav_selected</a>; <span class="comment">// the default navigator is invert with the current navigator</span>
<a name="l00203"></a>00203    <span class="keywordflow">return</span> <a class="code" href="a00017.html#019afd16a7838947cee3c910a1dcd045">fat_copy_file_current</a>( u8_idnav );
<a name="l00204"></a>00204 <span class="preprocessor">#else</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>   u8_idnav++;
<a name="l00206"></a>00206    <span class="keywordflow">return</span> FALSE;
<a name="l00207"></a>00207 <span class="preprocessor">#endif</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span>}
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="comment">//**********************************************************************</span>
<a name="l00212"></a>00212 <span class="comment">//********************* Drive navigation fonctions *********************</span>
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 
<a name="l00223"></a><a class="code" href="a00027.html#976f31ef59e11ac491ffaae703fa4578">00223</a> U8    <a class="code" href="a00026.html#976f31ef59e11ac491ffaae703fa4578">nav_drive_nb</a>( <span class="keywordtype">void</span> )
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225    <span class="keywordflow">return</span> <a class="code" href="a00015.html#877a4f5ff11d5d9b96019ee2c2cee5cd">get_nb_lun</a>(); <span class="comment">// Number of device = Number of lun</span>
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 
<a name="l00236"></a><a class="code" href="a00027.html#dd247ba4e5086c74c6f106a55617872a">00236</a> Bool  <a class="code" href="a00026.html#dd247ba4e5086c74c6f106a55617872a">nav_drive_set</a>( U8 u8_number )
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>() )
<a name="l00239"></a>00239       <span class="keywordflow">return</span> FALSE;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="keywordflow">if</span> (u8_number &gt;= <a class="code" href="a00015.html#877a4f5ff11d5d9b96019ee2c2cee5cd">get_nb_lun</a>() )
<a name="l00242"></a>00242    {
<a name="l00243"></a>00243       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#d701fa192fb2b5692bf1de16bd43254c">FS_ERR_END_OF_DRIVE</a>;   <span class="comment">// There are not other drivers</span>
<a name="l00244"></a>00244       <span class="keywordflow">return</span> FALSE;
<a name="l00245"></a>00245    }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> == u8_number)
<a name="l00248"></a>00248       <span class="keywordflow">return</span> TRUE;   <span class="comment">// It is the same</span>
<a name="l00249"></a>00249       
<a name="l00250"></a>00250    <span class="comment">// Go to device</span>
<a name="l00251"></a>00251    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> = u8_number;
<a name="l00252"></a>00252    <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a> = <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a>;
<a name="l00253"></a>00253 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>   <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a>=0;   <span class="comment">// by default select the first partition</span>
<a name="l00255"></a>00255 <span class="preprocessor">#endif</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>   <span class="keywordflow">return</span> TRUE;
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 
<a name="l00265"></a><a class="code" href="a00027.html#f6d804b75a8fc489e0e8051e585edef5">00265</a> U8    <a class="code" href="a00026.html#f6d804b75a8fc489e0e8051e585edef5">nav_drive_get</a>( <span class="keywordtype">void</span> )
<a name="l00266"></a>00266 {
<a name="l00267"></a>00267 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>   <span class="keywordflow">if</span>(0xFF == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>)
<a name="l00269"></a>00269       <span class="keywordflow">return</span> 0xFF;
<a name="l00270"></a>00270    <span class="keywordflow">return</span> ((<a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>*4) + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a>); <span class="comment">// Maximum 4 partitions by device</span>
<a name="l00271"></a>00271 <span class="preprocessor">#else</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (<a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>);
<a name="l00273"></a>00273 <span class="preprocessor">#endif</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span>}
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 
<a name="l00282"></a><a class="code" href="a00027.html#cf3be5c3ce9b724a135162437642e091">00282</a> U8    <a class="code" href="a00026.html#cf3be5c3ce9b724a135162437642e091">nav_drive_getname</a>( <span class="keywordtype">void</span> )
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284    <span class="keywordflow">if</span>(0xFF == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>)
<a name="l00285"></a>00285       <span class="keywordflow">return</span> <span class="charliteral">'X'</span>;
<a name="l00286"></a>00286 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (<span class="charliteral">'A'</span> + (<a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>*4) + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a>); <span class="comment">// Maximum 4 partitions by device</span>
<a name="l00288"></a>00288 <span class="preprocessor">#else</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (<span class="charliteral">'A'</span> + <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>);
<a name="l00290"></a>00290 <span class="preprocessor">#endif</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span>}
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="preprocessor">#if (FSFEATURE_WRITE_COMPLET == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE_COMPLET))</span>
<a name="l00311"></a><a class="code" href="a00027.html#c5cf99297c9a8a75ffdd28b33a07e958">00311</a> <span class="preprocessor">Bool  nav_drive_format( U8 u8_fat_type )</span>
<a name="l00312"></a>00312 <span class="preprocessor"></span>{
<a name="l00313"></a>00313    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>() )
<a name="l00314"></a>00314       <span class="keywordflow">return</span> FALSE;
<a name="l00315"></a>00315    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#3ebe58d94472a1818a38afaf09c19c35">fat_check_nav_access_disk</a>() )
<a name="l00316"></a>00316       <span class="keywordflow">return</span> FALSE;
<a name="l00317"></a>00317    <span class="keywordflow">if</span> ( !<a class="code" href="a00018.html#6099b0e8fafcc01b8c1769c94c827325">fat_format</a>( u8_fat_type ) )
<a name="l00318"></a>00318       <span class="keywordflow">return</span> FALSE;
<a name="l00319"></a>00319    <span class="keywordflow">return</span> <a class="code" href="a00018.html#c0108ea608b547e8d3a405c70644c1e9">fat_mount</a>(); <span class="comment">// mount the new FS</span>
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span>
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="comment">//**********************************************************************</span>
<a name="l00325"></a>00325 <span class="comment">//******************* Partition navigation fonctions ******************* </span>
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l00333"></a><a class="code" href="a00027.html#a50a8525f7c598dcfebcbe63aa2dfc23">00333</a> <span class="preprocessor">U8    nav_partition_nb( void )</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span>{
<a name="l00335"></a>00335    <span class="keywordflow">return</span> <a class="code" href="a00017.html#920798e6366e8c3c408601c58fed4bb3">fat_get_nbpartition</a>();
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 
<a name="l00346"></a><a class="code" href="a00027.html#43873b28f4ebbd1f092e7f702ee14c61">00346</a> Bool  <a class="code" href="a00026.html#43873b28f4ebbd1f092e7f702ee14c61">nav_partition_set</a>( U8 partition_number )
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348    <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a> == partition_number)
<a name="l00349"></a>00349       <span class="keywordflow">return</span> TRUE;   <span class="comment">// It is the same</span>
<a name="l00350"></a>00350       
<a name="l00351"></a>00351    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>() )
<a name="l00352"></a>00352       <span class="keywordflow">return</span> FALSE;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354    <span class="comment">// Go to partition</span>
<a name="l00355"></a>00355    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a> = partition_number;
<a name="l00356"></a>00356    <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a> = <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a>;
<a name="l00357"></a>00357    <span class="keywordflow">return</span> TRUE;
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 <span class="preprocessor">#endif</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span>
<a name="l00361"></a>00361 
<a name="l00373"></a><a class="code" href="a00027.html#aa10a2b4e4db0e4eb602b19b4f9ff9b9">00373</a> Bool  <a class="code" href="a00026.html#aa10a2b4e4db0e4eb602b19b4f9ff9b9">nav_partition_mount</a>( <span class="keywordtype">void</span> )
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>() )
<a name="l00376"></a>00376       <span class="keywordflow">return</span> FALSE;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> != <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>)
<a name="l00379"></a>00379    {
<a name="l00380"></a>00380       <span class="comment">// Already mount</span>
<a name="l00381"></a>00381       <span class="comment">// Go to root directory</span>
<a name="l00382"></a>00382       <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a>   = 0;
<a name="l00383"></a>00383       <span class="comment">// No file is selected</span>
<a name="l00384"></a>00384       <a class="code" href="a00017.html#56d9a210bc2d4b0b5c46cb24a2e9f690">fat_clear_entry_info_and_ptr</a>();
<a name="l00385"></a>00385       <span class="keywordflow">return</span> TRUE;
<a name="l00386"></a>00386    }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388    <span class="keywordflow">return</span> <a class="code" href="a00018.html#c0108ea608b547e8d3a405c70644c1e9">fat_mount</a>(); <span class="comment">// mount the current partition and device</span>
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 
<a name="l00397"></a><a class="code" href="a00027.html#366957a6691432a94f9ec5d82039eebc">00397</a> U8    <a class="code" href="a00026.html#366957a6691432a94f9ec5d82039eebc">nav_partition_type</a>( <span class="keywordtype">void</span> )
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399    <a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>();
<a name="l00400"></a>00400    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>)
<a name="l00401"></a>00401    {
<a name="l00402"></a>00402       <a class="code" href="a00026.html#aa10a2b4e4db0e4eb602b19b4f9ff9b9">nav_partition_mount</a>();
<a name="l00403"></a>00403    }
<a name="l00404"></a>00404    <span class="keywordflow">return</span> <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00420"></a><a class="code" href="a00027.html#14cf001b6b84590bd3da1f3809844f03">00420</a> Bool  <a class="code" href="a00026.html#14cf001b6b84590bd3da1f3809844f03">nav_partition_serialnumber</a>( Bool b_action , U8 _MEM_TYPE_SLOW_ *a_u8_sn )
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#8ee865aa4c51519c0d141f1f4559c72a">fat_check_mount</a>())
<a name="l00423"></a>00423       <span class="keywordflow">return</span> FALSE;
<a name="l00424"></a>00424       
<a name="l00425"></a>00425    <span class="keywordflow">return</span> <a class="code" href="a00018.html#2ff43f97db7a5d76f46f4fb1b683d192">fat_serialnumber</a>( b_action , a_u8_sn );
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 
<a name="l00441"></a><a class="code" href="a00027.html#c2ac7612e00c937c8d83433d2143a4f0">00441</a> Bool  <a class="code" href="a00026.html#c2ac7612e00c937c8d83433d2143a4f0">nav_partition_label</a>( Bool b_action , <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_label )
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443    _MEM_TYPE_SLOW_   <a class="code" href="a00003.html">Fs_index</a> index;
<a name="l00444"></a>00444    Bool status = TRUE;
<a name="l00445"></a>00445          
<a name="l00446"></a>00446    <span class="comment">// Save index</span>
<a name="l00447"></a>00447    index = <a class="code" href="a00026.html#47882923fca657fb23001d23b6b5369d">nav_getindex</a>();       <span class="comment">// Save current position</span>
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <span class="comment">// Go to root dir</span>
<a name="l00450"></a>00450    <span class="keywordflow">if</span>( <a class="code" href="a00026.html#9447385c9c400b07b99c61ada1a6ea77">nav_dir_root</a>())
<a name="l00451"></a>00451    {
<a name="l00452"></a>00452       <span class="comment">// find field label</span>
<a name="l00453"></a>00453       <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> = 0; <span class="comment">// Go to first entry</span>
<a name="l00454"></a>00454       <span class="keywordflow">while</span>( 1 )
<a name="l00455"></a>00455       {
<a name="l00456"></a>00456          <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l00457"></a>00457          {
<a name="l00458"></a>00458             status = FALSE;
<a name="l00459"></a>00459             <span class="keywordflow">break</span>; <span class="comment">// error</span>
<a name="l00460"></a>00460          } 
<a name="l00461"></a>00461          
<a name="l00462"></a>00462          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#a03d2728f28964e1eb4d78c2bb831718">fat_entry_label</a>( <a class="code" href="a00022.html#c1570dd392605e8ff8f7d4cb16487830">FS_LABEL_READ</a> , NULL ) )
<a name="l00463"></a>00463             <span class="keywordflow">break</span>;
<a name="l00464"></a>00464          <span class="keywordflow">if</span>( <a class="code" href="a00022.html#33817136df196a5f0146574b4e1775b6">FS_ERR_ENTRY_EMPTY</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l00465"></a>00465             <span class="keywordflow">break</span>;
<a name="l00466"></a>00466          <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>++;
<a name="l00467"></a>00467       }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469       <span class="keywordflow">if</span>( TRUE == status )
<a name="l00470"></a>00470       {
<a name="l00471"></a>00471          <span class="comment">// Find OK</span>
<a name="l00472"></a>00472          <span class="keywordflow">if</span>( <a class="code" href="a00022.html#c1570dd392605e8ff8f7d4cb16487830">FS_LABEL_READ</a> == b_action )
<a name="l00473"></a>00473          {
<a name="l00474"></a>00474             <span class="comment">// change field label</span>
<a name="l00475"></a>00475             <span class="keywordflow">if</span>( !<a class="code" href="a00018.html#a03d2728f28964e1eb4d78c2bb831718">fat_entry_label</a>( <a class="code" href="a00022.html#c1570dd392605e8ff8f7d4cb16487830">FS_LABEL_READ</a> , sz_label ) )
<a name="l00476"></a>00476                sz_label[0]=0; <span class="comment">// empty name</span>
<a name="l00477"></a>00477          }<span class="keywordflow">else</span>{
<a name="l00478"></a>00478             <span class="comment">// change field label</span>
<a name="l00479"></a>00479             status = <a class="code" href="a00018.html#a03d2728f28964e1eb4d78c2bb831718">fat_entry_label</a>( <a class="code" href="a00022.html#c5e191f04380ef238255929695f8efcb">FS_LABEL_WRITE</a> , sz_label );
<a name="l00480"></a>00480          }
<a name="l00481"></a>00481       }  
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483    <span class="comment">// Restore index</span>
<a name="l00484"></a>00484    <a class="code" href="a00026.html#503f8d42be2b70cb554589ac7974ed78">nav_gotoindex</a>( &amp;index );
<a name="l00485"></a>00485    <span class="keywordflow">return</span> status;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 
<a name="l00498"></a><a class="code" href="a00027.html#24053c9202d6999e9e56e96b3b89703e">00498</a> U32   <a class="code" href="a00026.html#24053c9202d6999e9e56e96b3b89703e">nav_partition_space</a>( <span class="keywordtype">void</span> )
<a name="l00499"></a>00499 {
<a name="l00500"></a>00500    <a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>();
<a name="l00501"></a>00501 
<a name="l00503"></a>00503    <span class="keywordflow">if</span> (<a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>)
<a name="l00504"></a>00504       <span class="keywordflow">return</span> 0;
<a name="l00505"></a>00505       
<a name="l00506"></a>00506    <span class="keywordflow">return</span> (<a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#2f9e0c9af661ea927729c08280e1105e">u32_CountofCluster</a> * <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#cddebea9972567fdcb5b87327b48125e">u8_BPB_SecPerClus</a>);
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 
<a name="l00519"></a><a class="code" href="a00027.html#44e5b70be51e852438e086225846cea3">00519</a> U32   <a class="code" href="a00026.html#44e5b70be51e852438e086225846cea3">nav_partition_freespace</a>( <span class="keywordtype">void</span> )
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521    <a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>();
<a name="l00522"></a>00522 
<a name="l00524"></a>00524    <span class="keywordflow">if</span> (<a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>)
<a name="l00525"></a>00525       <span class="keywordflow">return</span> 0;
<a name="l00526"></a>00526    <span class="keywordflow">return</span> <a class="code" href="a00018.html#e23270781477be5e6c89b90531c01651">fat_getfreespace</a>();
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 
<a name="l00539"></a><a class="code" href="a00027.html#9e8934635c66157baff2e6bb066ea373">00539</a> U8    <a class="code" href="a00026.html#9e8934635c66157baff2e6bb066ea373">nav_partition_freespace_percent</a>( <span class="keywordtype">void</span> )
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541    <a class="code" href="a00017.html#eeec0bd6755a6be4c4dda2b4669eb0ae">fat_check_device</a>();
<a name="l00542"></a>00542 
<a name="l00544"></a>00544    <span class="keywordflow">if</span> (<a class="code" href="a00018.html#429fbd0498704c3d5864877548040069">FS_TYPE_FAT_UNM</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#74121fb3c8d3a1d018c911650e2ec920">u8_type_fat</a>)
<a name="l00545"></a>00545       <span class="keywordflow">return</span> 0;
<a name="l00546"></a>00546    <span class="keywordflow">return</span> <a class="code" href="a00018.html#14426d5552b72b88ea0d61828c57d6c6">fat_getfreespace_percent</a>();
<a name="l00547"></a>00547 }
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <span class="comment">//**********************************************************************</span>
<a name="l00551"></a>00551 <span class="comment">//****************** File list navigation fonctions ******************** </span>
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 
<a name="l00563"></a><a class="code" href="a00027.html#7ad0aa092d133a156651abe5d871b8eb">00563</a> Bool  <a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>( <span class="keywordtype">void</span> )
<a name="l00564"></a>00564 {
<a name="l00565"></a>00565    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#e9d0f61d0e7b29a4e8e9e95347194f21">fat_check_mount_noopen</a>())
<a name="l00566"></a>00566       <span class="keywordflow">return</span> FALSE;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568    <span class="comment">// No file selected and reset navigation</span>
<a name="l00569"></a>00569    <a class="code" href="a00017.html#56d9a210bc2d4b0b5c46cb24a2e9f690">fat_clear_entry_info_and_ptr</a>();
<a name="l00570"></a>00570    <span class="keywordflow">return</span> TRUE;
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 
<a name="l00579"></a><a class="code" href="a00027.html#dd6435ba1a2f0a8ddc072883c05a1a64">00579</a> Bool  <a class="code" href="a00026.html#dd6435ba1a2f0a8ddc072883c05a1a64">nav_filelist_validpos</a>( <span class="keywordtype">void</span> )
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581    <span class="keywordflow">return</span> <a class="code" href="a00017.html#003f1c81dcb2c7a95f191c30b8a4f258">fat_check_mount_select_noopen</a>();
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 
<a name="l00590"></a><a class="code" href="a00027.html#1d6570347e090b2473510798840a729f">00590</a> Bool  <a class="code" href="a00026.html#1d6570347e090b2473510798840a729f">nav_filelist_fileisnotopen</a>( <span class="keywordtype">void</span> )
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592    <span class="keywordflow">return</span> <a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>();
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 
<a name="l00614"></a><a class="code" href="a00027.html#066eaff61613f07dc5fb1f3313747aef">00614</a> Bool  <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( U16 u16_nb , Bool b_direction )
<a name="l00615"></a>00615 {
<a name="l00616"></a>00616    U16   u16_ptr_save_entry;
<a name="l00617"></a>00617    U16   u16_save_pos_sel_file;
<a name="l00618"></a>00618    Bool  b_save_entry_type;
<a name="l00619"></a>00619    Bool  b_find_last_entry = FALSE;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#e9d0f61d0e7b29a4e8e9e95347194f21">fat_check_mount_noopen</a>())
<a name="l00622"></a>00622       <span class="keywordflow">return</span> FALSE;
<a name="l00623"></a>00623       
<a name="l00624"></a>00624    <span class="comment">// save the current file entry</span>
<a name="l00625"></a>00625    u16_ptr_save_entry      = <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>;
<a name="l00626"></a>00626    u16_save_pos_sel_file   = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>;
<a name="l00627"></a>00627    b_save_entry_type       = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a>;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629    <span class="comment">// loop in directory entry</span>
<a name="l00630"></a>00630    <span class="keywordflow">while</span>( 1 )
<a name="l00631"></a>00631    {
<a name="l00632"></a>00632       <span class="keywordflow">if</span>(( <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> == b_direction )
<a name="l00633"></a>00633       || ( b_find_last_entry ) )
<a name="l00634"></a>00634       {
<a name="l00635"></a>00635          <span class="comment">// if the directory have more 0xFFFE entry file</span>
<a name="l00636"></a>00636          <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#fe6257cc919ba9fad5fad6c1e499f6d6">FS_END_FIND</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> )
<a name="l00637"></a>00637          {
<a name="l00638"></a>00638             <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#89613ba21711697c707a3199bf93b9cf">FS_ERR_FS</a>; <span class="comment">// entry file number no supported by this file system</span>
<a name="l00639"></a>00639             <span class="keywordflow">break</span>;
<a name="l00640"></a>00640          }
<a name="l00641"></a>00641          <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>++;   <span class="comment">// go to next entry file</span>
<a name="l00642"></a>00642       }
<a name="l00643"></a>00643       <span class="keywordflow">else</span>
<a name="l00644"></a>00644       {
<a name="l00645"></a>00645          <span class="keywordflow">if</span> ( <a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a> == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> )
<a name="l00646"></a>00646          {
<a name="l00647"></a>00647             <span class="comment">// No file selected</span>
<a name="l00648"></a>00648             <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#1227e9d3b3f7f0c656cfbb9a0b7915f8">FS_ERR_NO_FIND</a>;
<a name="l00649"></a>00649             <span class="keywordflow">break</span>;
<a name="l00650"></a>00650          }
<a name="l00651"></a>00651          <span class="comment">// if it is the beginning of the directory</span>
<a name="l00652"></a>00652          <span class="keywordflow">if</span> ( 0 == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> )
<a name="l00653"></a>00653          {
<a name="l00654"></a>00654             <span class="comment">// beginning of directory</span>
<a name="l00655"></a>00655             <span class="keywordflow">if</span> ( <a class="code" href="a00022.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a> == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> )
<a name="l00656"></a>00656             {
<a name="l00657"></a>00657                <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#1227e9d3b3f7f0c656cfbb9a0b7915f8">FS_ERR_NO_FIND</a>;
<a name="l00658"></a>00658                <span class="keywordflow">break</span>;
<a name="l00659"></a>00659             }
<a name="l00660"></a>00660             <span class="comment">// end of scan file, find last entry in directory to find last directory entry</span>
<a name="l00661"></a>00661             b_find_last_entry = TRUE;
<a name="l00662"></a>00662          }<span class="keywordflow">else</span>{
<a name="l00663"></a>00663             <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>--;   <span class="comment">// go to previous entry file</span>
<a name="l00664"></a>00664          }
<a name="l00665"></a>00665       }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667       <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l00668"></a>00668       {
<a name="l00669"></a>00669          <span class="keywordflow">if</span>( <a class="code" href="a00022.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a> != <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l00670"></a>00670             <span class="keywordflow">break</span>; <span class="comment">// Error</span>
<a name="l00671"></a>00671       }<span class="keywordflow">else</span>{
<a name="l00672"></a>00672          <span class="comment">// Check the new entry</span>
<a name="l00673"></a>00673          <span class="keywordflow">if</span> ( <a class="code" href="a00017.html#ef13c743905d7e0381b3a461da2ebd7a">fat_entry_check</a>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> ) )
<a name="l00674"></a>00674          {
<a name="l00675"></a>00675            <span class="comment">// a file with good type is found</span>
<a name="l00676"></a>00676 
<a name="l00677"></a>00677            <span class="keywordflow">if</span>( b_find_last_entry )
<a name="l00678"></a>00678              <span class="keywordflow">continue</span>; <span class="comment">// In case of search end of dir, jump good entry</span>
<a name="l00679"></a>00679    
<a name="l00680"></a>00680            <span class="comment">// Update the index position to navigation module</span>
<a name="l00681"></a>00681            <span class="keywordflow">if</span> ( <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> == b_direction )
<a name="l00682"></a>00682               <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>++;
<a name="l00683"></a>00683            <span class="keywordflow">else</span>
<a name="l00684"></a>00684               <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>--;
<a name="l00685"></a>00685    
<a name="l00686"></a>00686            <span class="keywordflow">if</span> (0 == u16_nb)
<a name="l00687"></a>00687            {
<a name="l00688"></a>00688               <span class="comment">// it is the last good file</span>
<a name="l00689"></a>00689               <a class="code" href="a00017.html#56b68ed36f194500ce88c22252e3c317">fat_get_entry_info</a>();
<a name="l00690"></a>00690               <span class="keywordflow">return</span> TRUE;         <span class="comment">// NB FILE FIND</span>
<a name="l00691"></a>00691            }
<a name="l00692"></a>00692            u16_nb--;
<a name="l00693"></a>00693            <span class="keywordflow">continue</span>;
<a name="l00694"></a>00694          }
<a name="l00695"></a>00695       }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697       <span class="comment">// Here error, check if end of directory</span>
<a name="l00698"></a>00698       <span class="keywordflow">if</span>(( <a class="code" href="a00022.html#33817136df196a5f0146574b4e1775b6">FS_ERR_ENTRY_EMPTY</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l00699"></a>00699       || ( <a class="code" href="a00022.html#e8798a89bfc4f49da50fc55b14a5b07f">FS_ERR_OUT_LIST</a>    == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> ) )
<a name="l00700"></a>00700       {
<a name="l00701"></a>00701          <span class="comment">// end of directory</span>
<a name="l00702"></a>00702          <span class="keywordflow">if</span>( b_find_last_entry )
<a name="l00703"></a>00703          {
<a name="l00704"></a>00704             <span class="comment">// end of directory found, then start find last directory</span>
<a name="l00705"></a>00705             b_find_last_entry = FALSE;
<a name="l00706"></a>00706             <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> = <a class="code" href="a00022.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a>;
<a name="l00707"></a>00707             <span class="keywordflow">continue</span>;
<a name="l00708"></a>00708          }
<a name="l00709"></a>00709          <span class="comment">// Here, we are in mode next</span>
<a name="l00710"></a>00710          <span class="keywordflow">if</span> ( <a class="code" href="a00022.html#20f0a7ade1270e3923abafeb33864c55">FS_FILE</a> == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> )
<a name="l00711"></a>00711          {
<a name="l00712"></a>00712             <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#1227e9d3b3f7f0c656cfbb9a0b7915f8">FS_ERR_NO_FIND</a>;  <span class="comment">// No file found</span>
<a name="l00713"></a>00713             <span class="keywordflow">break</span>;   <span class="comment">// end of scan</span>
<a name="l00714"></a>00714          }<span class="keywordflow">else</span>{
<a name="l00715"></a>00715             <span class="comment">// End of find dir</span>
<a name="l00716"></a>00716             <span class="comment">// Restart at the beginning of directory to find file</span>
<a name="l00717"></a>00717             <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> = 0xFFFF;
<a name="l00718"></a>00718             <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> = <a class="code" href="a00022.html#20f0a7ade1270e3923abafeb33864c55">FS_FILE</a>;
<a name="l00719"></a>00719          }
<a name="l00720"></a>00720       }
<a name="l00721"></a>00721    }  <span class="comment">// end of loop while(1)</span>
<a name="l00722"></a>00722 
<a name="l00723"></a>00723    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a>                    = b_save_entry_type;
<a name="l00724"></a>00724    <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>   = u16_ptr_save_entry;
<a name="l00725"></a>00725    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>              = u16_save_pos_sel_file;
<a name="l00726"></a>00726    <span class="keywordflow">return</span> FALSE;
<a name="l00727"></a>00727 }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729 
<a name="l00739"></a><a class="code" href="a00027.html#6b1c198eaa70bcb1babce7ad46a865ed">00739</a> U16   <a class="code" href="a00026.html#6b1c198eaa70bcb1babce7ad46a865ed">nav_filelist_get</a>( <span class="keywordtype">void</span> )
<a name="l00740"></a>00740 {
<a name="l00741"></a>00741    <span class="keywordflow">return</span> <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 
<a name="l00756"></a><a class="code" href="a00027.html#e725a52dd932465bd1c3ebe61af033c5">00756</a> Bool  <a class="code" href="a00026.html#e725a52dd932465bd1c3ebe61af033c5">nav_filelist_goto</a>( U16 u16_newpos )
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758    U16 u16_current_pos;
<a name="l00759"></a>00759    u16_current_pos = <a class="code" href="a00026.html#6b1c198eaa70bcb1babce7ad46a865ed">nav_filelist_get</a>();
<a name="l00760"></a>00760    <span class="keywordflow">if</span> (<a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a> == u16_current_pos)
<a name="l00761"></a>00761    {
<a name="l00762"></a>00762       <span class="keywordflow">return</span> <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( u16_newpos, <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> );
<a name="l00763"></a>00763    }
<a name="l00764"></a>00764    <span class="keywordflow">else</span>
<a name="l00765"></a>00765    {
<a name="l00766"></a>00766       <span class="keywordflow">if</span> (u16_newpos &lt; u16_current_pos)
<a name="l00767"></a>00767       {
<a name="l00768"></a>00768          <span class="keywordflow">return</span> <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( u16_current_pos -u16_newpos -1 , <a class="code" href="a00027.html#bc7fd11102a5b83b18fefaba9e846c10">FS_FIND_PREV</a> );
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770       <span class="keywordflow">if</span> (u16_newpos &gt; u16_current_pos)
<a name="l00771"></a>00771       {
<a name="l00772"></a>00772          <span class="keywordflow">return</span> <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( u16_newpos -u16_current_pos - 1 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> );
<a name="l00773"></a>00773       }
<a name="l00774"></a>00774    }
<a name="l00775"></a>00775    <span class="keywordflow">return</span> TRUE;
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 
<a name="l00793"></a><a class="code" href="a00027.html#017ce6b53af128e5064a06bc8fadec25">00793</a> Bool  <a class="code" href="a00026.html#017ce6b53af128e5064a06bc8fadec25">nav_filelist_findname</a>( <span class="keyword">const</span> <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_name , Bool b_match_case )
<a name="l00794"></a>00794 {
<a name="l00795"></a>00795    <span class="keywordflow">while</span>( 1 )
<a name="l00796"></a>00796    {
<a name="l00797"></a>00797       <span class="keywordflow">if</span> ( !<a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0, <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> ))
<a name="l00798"></a>00798          <span class="keywordflow">return</span> FALSE;
<a name="l00799"></a>00799       <span class="keywordflow">if</span> ( <a class="code" href="a00026.html#10603c2fe89bd66a17cfe3bb49a3fa14">nav_file_name</a>( sz_name , 0 , <a class="code" href="a00022.html#5f61af4710e43b370997c162777f08b3">FS_NAME_CHECK</a> , b_match_case ))
<a name="l00800"></a>00800          <span class="keywordflow">return</span> TRUE;
<a name="l00801"></a>00801    }
<a name="l00802"></a>00802 }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 
<a name="l00814"></a><a class="code" href="a00027.html#4f3b7e6c2f7670c02973654dbc1d550e">00814</a> Bool  <a class="code" href="a00026.html#4f3b7e6c2f7670c02973654dbc1d550e">nav_filelist_eol</a>( <span class="keywordtype">void</span> )
<a name="l00815"></a>00815 {
<a name="l00816"></a>00816    <span class="keywordflow">if</span>( FALSE == <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> ) )
<a name="l00817"></a>00817       <span class="keywordflow">return</span> TRUE;   <span class="comment">// end of list or error (remark: the position haven't changed)</span>
<a name="l00818"></a>00818    
<a name="l00819"></a>00819    <span class="comment">// the next file is the first of the list ?</span>
<a name="l00820"></a>00820    <span class="keywordflow">if</span>( 0 != <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a> )
<a name="l00821"></a>00821    {
<a name="l00822"></a>00822       <span class="comment">// Go to previous position</span>
<a name="l00823"></a>00823       <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#bc7fd11102a5b83b18fefaba9e846c10">FS_FIND_PREV</a> );
<a name="l00824"></a>00824    }<span class="keywordflow">else</span>{
<a name="l00825"></a>00825       <span class="comment">// No select file before eol fnct</span>
<a name="l00826"></a>00826       <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>= <a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a>;
<a name="l00827"></a>00827       <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>           = <a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a>;
<a name="l00828"></a>00828       <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a>                 = <a class="code" href="a00022.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a>;
<a name="l00829"></a>00829    }
<a name="l00830"></a>00830    <span class="keywordflow">return</span> FALSE;
<a name="l00831"></a>00831 }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 
<a name="l00843"></a><a class="code" href="a00027.html#c7da45cc8084fef48a1944772c146ff7">00843</a> Bool  <a class="code" href="a00026.html#c7da45cc8084fef48a1944772c146ff7">nav_filelist_bol</a>( <span class="keywordtype">void</span> )
<a name="l00844"></a>00844 {
<a name="l00845"></a>00845    <span class="keywordflow">if</span>( FALSE == <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#bc7fd11102a5b83b18fefaba9e846c10">FS_FIND_PREV</a> ) )
<a name="l00846"></a>00846       <span class="keywordflow">return</span> TRUE;   <span class="comment">// end of list or error (remark: the position haven't changed)</span>
<a name="l00847"></a>00847    <span class="comment">// Go to previous position</span>
<a name="l00848"></a>00848    <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> );
<a name="l00849"></a>00849    <span class="keywordflow">return</span> FALSE;
<a name="l00850"></a>00850 }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852 
<a name="l00865"></a><a class="code" href="a00027.html#d2c6198a0ef77a90abdc9c289f7a2218">00865</a> Bool  <a class="code" href="a00026.html#d2c6198a0ef77a90abdc9c289f7a2218">nav_filelist_exist</a>( Bool b_type )
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867    Bool status;
<a name="l00868"></a>00868    U16   u16_save_position;
<a name="l00869"></a>00869    
<a name="l00870"></a>00870    <span class="comment">// save current position</span>
<a name="l00871"></a>00871    u16_save_position = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>;
<a name="l00872"></a>00872    status = <a class="code" href="a00026.html#6f711a14b01a8796caf8d6117d61ab09">nav_filelist_first</a>( b_type );
<a name="l00873"></a>00873 
<a name="l00874"></a>00874    <span class="comment">// reselect previous position</span>
<a name="l00875"></a>00875    <a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>();
<a name="l00876"></a>00876    <span class="keywordflow">if</span> ( u16_save_position != <a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a> )
<a name="l00877"></a>00877    {  <span class="comment">// After operation, there are a file selected</span>
<a name="l00878"></a>00878       <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( u16_save_position , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> );
<a name="l00879"></a>00879    }
<a name="l00880"></a>00880    <span class="keywordflow">return</span> status;   
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 
<a name="l00895"></a><a class="code" href="a00027.html#a3116b803ef078138f0d32ac2a92a8cf">00895</a> U16   <a class="code" href="a00026.html#a3116b803ef078138f0d32ac2a92a8cf">nav_filelist_nb</a>( Bool b_type )
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897    U16   u16_save_position;
<a name="l00898"></a>00898    U16   u16_save_number_dir;
<a name="l00899"></a>00899    U16   u16_save_number_file;
<a name="l00900"></a>00900    
<a name="l00901"></a>00901    <span class="comment">// save current position</span>
<a name="l00902"></a>00902    u16_save_position = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904    <span class="comment">// Reset position</span>
<a name="l00905"></a>00905    <span class="keywordflow">if</span> ( !<a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>())
<a name="l00906"></a>00906       <span class="keywordflow">return</span> 0;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908    <span class="comment">// Scan all directory</span>
<a name="l00909"></a>00909    u16_save_number_dir  = 0;
<a name="l00910"></a>00910    u16_save_number_file = 0;
<a name="l00911"></a>00911    <span class="keywordflow">while</span>( <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> ) )
<a name="l00912"></a>00912    {
<a name="l00913"></a>00913       <span class="comment">// Check if file or dir</span>
<a name="l00914"></a>00914       <span class="keywordflow">if</span>( <a class="code" href="a00022.html#20f0a7ade1270e3923abafeb33864c55">FS_FILE</a> == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> )
<a name="l00915"></a>00915          u16_save_number_file++;    <span class="comment">// It is a file</span>
<a name="l00916"></a>00916       <span class="keywordflow">else</span>
<a name="l00917"></a>00917          u16_save_number_dir++;     <span class="comment">// It is a directory</span>
<a name="l00918"></a>00918    }
<a name="l00919"></a>00919    
<a name="l00920"></a>00920    <span class="comment">// reselect previous position</span>
<a name="l00921"></a>00921    <a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>();
<a name="l00922"></a>00922    <span class="keywordflow">if</span> ( u16_save_position != <a class="code" href="a00018.html#2e16c6cfcb3174f7ad19ad3996a69ae7">FS_NO_SEL</a> )
<a name="l00923"></a>00923    {  <span class="comment">// After operation, there are a file selected</span>
<a name="l00924"></a>00924       <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( u16_save_position , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> );
<a name="l00925"></a>00925    }
<a name="l00926"></a>00926    
<a name="l00927"></a>00927    <span class="comment">// Return the value asked</span>
<a name="l00928"></a>00928    <span class="keywordflow">if</span>( <a class="code" href="a00022.html#20f0a7ade1270e3923abafeb33864c55">FS_FILE</a> == b_type )
<a name="l00929"></a>00929       <span class="keywordflow">return</span> u16_save_number_file;
<a name="l00930"></a>00930    <span class="keywordflow">else</span>
<a name="l00931"></a>00931       <span class="keywordflow">return</span> u16_save_number_dir;
<a name="l00932"></a>00932 }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934 
<a name="l00947"></a><a class="code" href="a00027.html#6f711a14b01a8796caf8d6117d61ab09">00947</a> Bool  <a class="code" href="a00026.html#6f711a14b01a8796caf8d6117d61ab09">nav_filelist_first</a>( Bool b_type )
<a name="l00948"></a>00948 {
<a name="l00949"></a>00949    <span class="comment">// Reset position</span>
<a name="l00950"></a>00950    <span class="keywordflow">if</span> ( !<a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>())
<a name="l00951"></a>00951       <span class="keywordflow">return</span> FALSE;
<a name="l00952"></a>00952    
<a name="l00953"></a>00953    <span class="comment">// Find the first file corresponding of type</span>
<a name="l00954"></a>00954    <span class="keywordflow">while</span>( <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> ) )
<a name="l00955"></a>00955    {
<a name="l00956"></a>00956       <span class="comment">// Check if file</span>
<a name="l00957"></a>00957       <span class="keywordflow">if</span>( b_type == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> )
<a name="l00958"></a>00958          <span class="keywordflow">return</span> TRUE;
<a name="l00959"></a>00959    }
<a name="l00960"></a>00960    
<a name="l00961"></a>00961    <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#1227e9d3b3f7f0c656cfbb9a0b7915f8">FS_ERR_NO_FIND</a>;
<a name="l00962"></a>00962    <span class="keywordflow">return</span> FALSE;  <span class="comment">// NO FILE FOUND</span>
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 
<a name="l00978"></a><a class="code" href="a00027.html#d7dbd335c9b54a9ebefddf5308df0409">00978</a> Bool  <a class="code" href="a00026.html#d7dbd335c9b54a9ebefddf5308df0409">nav_filelist_last</a>( Bool b_type )
<a name="l00979"></a>00979 {
<a name="l00980"></a>00980    U16 u16_nb;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982    <span class="comment">// Get nb file of good type</span>
<a name="l00983"></a>00983    u16_nb = <a class="code" href="a00026.html#a3116b803ef078138f0d32ac2a92a8cf">nav_filelist_nb</a>( b_type  );
<a name="l00984"></a>00984    <span class="keywordflow">if</span>( 0 == u16_nb )
<a name="l00985"></a>00985    {
<a name="l00986"></a>00986       <span class="comment">// No file with a good type</span>
<a name="l00987"></a>00987       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#1227e9d3b3f7f0c656cfbb9a0b7915f8">FS_ERR_NO_FIND</a>;
<a name="l00988"></a>00988       <span class="keywordflow">return</span> FALSE;  <span class="comment">// NO FILE FOUND</span>
<a name="l00989"></a>00989    }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991    <span class="comment">// Go to the first file</span>
<a name="l00992"></a>00992    <span class="keywordflow">if</span> ( !<a class="code" href="a00026.html#6f711a14b01a8796caf8d6117d61ab09">nav_filelist_first</a>( b_type ))
<a name="l00993"></a>00993       <span class="keywordflow">return</span> FALSE;
<a name="l00994"></a>00994       
<a name="l00995"></a>00995    <span class="comment">// If there are more one file, then go to last of list</span>
<a name="l00996"></a>00996    <span class="keywordflow">if</span>( 1 == u16_nb )
<a name="l00997"></a>00997       <span class="keywordflow">return</span> TRUE;
<a name="l00998"></a>00998    u16_nb -= 2;
<a name="l00999"></a>00999    <span class="keywordflow">return</span> <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( u16_nb , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> );
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 <span class="comment">//**********************************************************************</span>
<a name="l01004"></a>01004 <span class="comment">//************************ Index fonctions *****************************</span>
<a name="l01005"></a>01005 
<a name="l01006"></a>01006 
<a name="l01016"></a><a class="code" href="a00027.html#47882923fca657fb23001d23b6b5369d">01016</a> <a class="code" href="a00003.html">Fs_index</a> <a class="code" href="a00026.html#47882923fca657fb23001d23b6b5369d">nav_getindex</a>( <span class="keywordtype">void</span> )
<a name="l01017"></a>01017 {
<a name="l01018"></a>01018    <a class="code" href="a00003.html">Fs_index</a> index;
<a name="l01019"></a>01019 
<a name="l01021"></a>01021    index.<a class="code" href="a00003.html#899865da18622a376013236b67e60589">u8_lun</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a>;
<a name="l01022"></a>01022 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l01023"></a>01023 <span class="preprocessor"></span>   index.<a class="code" href="a00003.html#b22d052cbc61c0a53fa3b69d66b5c554">u8_partition</a> = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#af482bc02a186c363c37c93e169fbbd4">u8_partition</a>;
<a name="l01024"></a>01024 <span class="preprocessor">#endif</span>
<a name="l01026"></a>01026 <span class="preprocessor">   index.u32_cluster_sel_dir = fs_g_nav.u32_cluster_sel_dir;</span>
<a name="l01028"></a>01028 <span class="preprocessor">   index.u16_entry_pos_sel_file = fs_g_nav_fast.u16_entry_pos_sel_file;</span>
<a name="l01029"></a>01029 <span class="preprocessor"></span>   <span class="keywordflow">return</span> index;
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 
<a name="l01045"></a><a class="code" href="a00027.html#503f8d42be2b70cb554589ac7974ed78">01045</a> Bool  <a class="code" href="a00026.html#503f8d42be2b70cb554589ac7974ed78">nav_gotoindex</a>( <span class="keyword">const</span> <a class="code" href="a00003.html">Fs_index</a> _MEM_TYPE_SLOW_ *index )
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047    <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#dd247ba4e5086c74c6f106a55617872a">nav_drive_set</a>( index-&gt;u8_lun ))
<a name="l01048"></a>01048       <span class="keywordflow">return</span> FALSE;
<a name="l01049"></a>01049 <span class="preprocessor">#if (FS_MULTI_PARTITION  ==  ENABLED)</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span>   <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#43873b28f4ebbd1f092e7f702ee14c61">nav_partition_set</a>(index-&gt;u8_partition))
<a name="l01051"></a>01051       <span class="keywordflow">return</span> FALSE;
<a name="l01052"></a>01052 <span class="preprocessor">#endif</span>
<a name="l01053"></a>01053 <span class="preprocessor"></span>   <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#aa10a2b4e4db0e4eb602b19b4f9ff9b9">nav_partition_mount</a>())
<a name="l01054"></a>01054       <span class="keywordflow">return</span> FALSE;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     <span class="comment">// Initialisation of the current entry file with index informations</span>
<a name="l01057"></a>01057    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a>   = index-&gt;u32_cluster_sel_dir;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059    <span class="comment">// Reset position</span>
<a name="l01060"></a>01060    <span class="keywordflow">if</span> ( !<a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>())
<a name="l01061"></a>01061       <span class="keywordflow">return</span> FALSE;
<a name="l01062"></a>01062 
<a name="l01063"></a>01063    <span class="comment">// Research the index in directory</span>
<a name="l01064"></a>01064    <span class="keywordflow">while</span>( <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> != index-&gt;u16_entry_pos_sel_file )
<a name="l01065"></a>01065    {
<a name="l01066"></a>01066       <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> ) )
<a name="l01067"></a>01067       {
<a name="l01068"></a>01068          <a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>();
<a name="l01069"></a>01069          <span class="keywordflow">return</span> FALSE;
<a name="l01070"></a>01070       }
<a name="l01071"></a>01071    }
<a name="l01072"></a>01072    <span class="keywordflow">return</span> TRUE;
<a name="l01073"></a>01073 }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075 
<a name="l01076"></a>01076 <span class="comment">//**********************************************************************</span>
<a name="l01077"></a>01077 <span class="comment">//************************ Directory fonctions *************************</span>
<a name="l01078"></a>01078 
<a name="l01079"></a>01079 
<a name="l01089"></a><a class="code" href="a00027.html#9447385c9c400b07b99c61ada1a6ea77">01089</a> Bool  <a class="code" href="a00026.html#9447385c9c400b07b99c61ada1a6ea77">nav_dir_root</a>( <span class="keywordtype">void</span> )
<a name="l01090"></a>01090 {
<a name="l01091"></a>01091    <span class="keywordflow">return</span> <a class="code" href="a00026.html#aa10a2b4e4db0e4eb602b19b4f9ff9b9">nav_partition_mount</a>();
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 
<a name="l01106"></a><a class="code" href="a00027.html#dca006b356e65cb05459f7bd7917a1ed">01106</a> Bool  <a class="code" href="a00026.html#dca006b356e65cb05459f7bd7917a1ed">nav_dir_cd</a>( <span class="keywordtype">void</span> )
<a name="l01107"></a>01107 {
<a name="l01108"></a>01108    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#003f1c81dcb2c7a95f191c30b8a4f258">fat_check_mount_select_noopen</a>())
<a name="l01109"></a>01109       <span class="keywordflow">return</span> FALSE;
<a name="l01110"></a>01110       
<a name="l01111"></a>01111    <span class="comment">// the current entry, is it a directory ?</span>
<a name="l01112"></a>01112    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#e0caae1c6e4a737af4ad0aa5d4171e79">fat_entry_is_dir</a>())
<a name="l01113"></a>01113       <span class="keywordflow">return</span> FALSE;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115    <span class="comment">// Select the current directory</span>
<a name="l01116"></a>01116    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118    <span class="comment">// Go to the first file</span>
<a name="l01119"></a>01119    <span class="keywordflow">if</span>( FALSE == <a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>())
<a name="l01120"></a>01120       <span class="keywordflow">return</span> FALSE;
<a name="l01121"></a>01121    <span class="keywordflow">return</span> TRUE;
<a name="l01122"></a>01122 }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124 
<a name="l01136"></a><a class="code" href="a00027.html#b37aa8fc84aca800a020da78724d729e">01136</a> Bool  <a class="code" href="a00026.html#b37aa8fc84aca800a020da78724d729e">nav_dir_gotoparent</a>( <span class="keywordtype">void</span> )
<a name="l01137"></a>01137 {
<a name="l01138"></a>01138    U32 u32_cluster_old_dir;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140    <span class="keywordflow">if</span> (!<a class="code" href="a00017.html#e9d0f61d0e7b29a4e8e9e95347194f21">fat_check_mount_noopen</a>())
<a name="l01141"></a>01141       <span class="keywordflow">return</span> FALSE;
<a name="l01142"></a>01142    
<a name="l01143"></a>01143    <span class="keywordflow">if</span> (0 == <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a>)
<a name="l01144"></a>01144    {
<a name="l01145"></a>01145       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#94e90e580e7ef16c72c2f2cb187af995">FS_ERR_IS_ROOT</a>;        <span class="comment">// There aren't parent</span>
<a name="l01146"></a>01146       <span class="keywordflow">return</span> FALSE;
<a name="l01147"></a>01147    }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    <span class="comment">// Select directory ".."</span>
<a name="l01150"></a>01150    <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> = 1;
<a name="l01151"></a>01151    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01152"></a>01152       <span class="keywordflow">return</span> FALSE;
<a name="l01153"></a>01153    <a class="code" href="a00017.html#56b68ed36f194500ce88c22252e3c317">fat_get_entry_info</a>();
<a name="l01154"></a>01154    
<a name="l01155"></a>01155    <span class="comment">// Save the sub directory cluster for select the previous sub directory at the end of "cd.."</span>
<a name="l01156"></a>01156    u32_cluster_old_dir = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a>;
<a name="l01157"></a>01157    <span class="comment">// Select the directory ".."</span>
<a name="l01158"></a>01158    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#ed8faad36e96ff2f422ddadd3740713f">u32_cluster_sel_dir</a> = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>;
<a name="l01159"></a>01159 
<a name="l01160"></a>01160    <span class="comment">// Find the old dir in your parent dir</span>
<a name="l01161"></a>01161    <span class="keywordflow">if</span>( FALSE == <a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>())
<a name="l01162"></a>01162       <span class="keywordflow">return</span> FALSE;
<a name="l01163"></a>01163    <span class="comment">// Scan the list</span>
<a name="l01164"></a>01164    <span class="keywordflow">while</span>( <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> ) )
<a name="l01165"></a>01165    {
<a name="l01166"></a>01166       <span class="keywordflow">if</span> (<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> == u32_cluster_old_dir)
<a name="l01167"></a>01167          <span class="keywordflow">return</span> TRUE;   <span class="comment">// It is the old directory</span>
<a name="l01168"></a>01168    }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#89613ba21711697c707a3199bf93b9cf">FS_ERR_FS</a>;   <span class="comment">// File system error</span>
<a name="l01171"></a>01171    <span class="keywordflow">return</span> FALSE;
<a name="l01172"></a>01172 }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 
<a name="l01187"></a><a class="code" href="a00027.html#46a870ca37a6fb671f93596b9bc4b171">01187</a> Bool  <a class="code" href="a00026.html#46a870ca37a6fb671f93596b9bc4b171">nav_dir_name</a>( <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_path  , U8 u8_size_max  )
<a name="l01188"></a>01188 {
<a name="l01189"></a>01189    Bool status;
<a name="l01190"></a>01190    _MEM_TYPE_SLOW_   <a class="code" href="a00003.html">Fs_index</a> index;
<a name="l01191"></a>01191    U8 <a class="code" href="a00017.html#5985f32ca0a3714cb4b55abf404be10c">u8_i</a>, u8_character;
<a name="l01192"></a>01192 
<a name="l01193"></a>01193    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#e9d0f61d0e7b29a4e8e9e95347194f21">fat_check_mount_noopen</a>())
<a name="l01194"></a>01194       <span class="keywordflow">return</span> FALSE;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196    index = <a class="code" href="a00026.html#47882923fca657fb23001d23b6b5369d">nav_getindex</a>();       <span class="comment">// Save current position</span>
<a name="l01197"></a>01197    <span class="keywordflow">if</span> ( <a class="code" href="a00026.html#b37aa8fc84aca800a020da78724d729e">nav_dir_gotoparent</a>() )   <span class="comment">// Go to parent directory and select the current directory</span>
<a name="l01198"></a>01198    {
<a name="l01199"></a>01199       status = <a class="code" href="a00026.html#10603c2fe89bd66a17cfe3bb49a3fa14">nav_file_name</a>( sz_path  , u8_size_max , <a class="code" href="a00022.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> , FALSE  );
<a name="l01200"></a>01200    }
<a name="l01201"></a>01201    <span class="keywordflow">else</span>
<a name="l01202"></a>01202    {
<a name="l01203"></a>01203       <span class="keywordflow">if</span> ( <a class="code" href="a00022.html#94e90e580e7ef16c72c2f2cb187af995">FS_ERR_IS_ROOT</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l01204"></a>01204       {
<a name="l01205"></a>01205          <span class="comment">// Create a device name</span>
<a name="l01206"></a>01206          <span class="keywordflow">for</span>( u8_i = 0 ; u8_i&lt;3 ; u8_i++ )
<a name="l01207"></a>01207          {
<a name="l01208"></a>01208             <span class="keywordflow">switch</span>( u8_i )
<a name="l01209"></a>01209             {
<a name="l01210"></a>01210                <span class="keywordflow">case</span> 0:
<a name="l01211"></a>01211                u8_character = <a class="code" href="a00026.html#cf3be5c3ce9b724a135162437642e091">nav_drive_getname</a>();    <span class="comment">// Letter</span>
<a name="l01212"></a>01212                <span class="keywordflow">break</span>;
<a name="l01213"></a>01213                <span class="keywordflow">case</span> 1:
<a name="l01214"></a>01214                u8_character = <span class="charliteral">':'</span>;                      <span class="comment">// ":"</span>
<a name="l01215"></a>01215                <span class="keywordflow">break</span>;
<a name="l01216"></a>01216                <span class="keywordflow">case</span> 2:
<a name="l01217"></a>01217                u8_character = 0;                        <span class="comment">// end of string</span>
<a name="l01218"></a>01218                <span class="keywordflow">break</span>;
<a name="l01219"></a>01219             }
<a name="l01220"></a>01220             <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01221"></a>01221             {
<a name="l01222"></a>01222                ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] = u8_character;
<a name="l01223"></a>01223             }<span class="keywordflow">else</span>{
<a name="l01224"></a>01224                sz_path [0] = u8_character;
<a name="l01225"></a>01225             }
<a name="l01226"></a>01226             sz_path  += (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01227"></a>01227          }
<a name="l01228"></a>01228          status = TRUE;
<a name="l01229"></a>01229       }
<a name="l01230"></a>01230       <span class="keywordflow">else</span>
<a name="l01231"></a>01231       {
<a name="l01232"></a>01232          status = FALSE;
<a name="l01233"></a>01233       }
<a name="l01234"></a>01234    }
<a name="l01235"></a>01235    <span class="comment">// Reinitialise the current position</span>
<a name="l01236"></a>01236    <a class="code" href="a00026.html#503f8d42be2b70cb554589ac7974ed78">nav_gotoindex</a>( &amp;index );
<a name="l01237"></a>01237    <span class="keywordflow">return</span> status;
<a name="l01238"></a>01238 }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240 
<a name="l01241"></a>01241 <span class="preprocessor">#if (FSFEATURE_WRITE_COMPLET == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE_COMPLET))</span>
<a name="l01253"></a><a class="code" href="a00027.html#3e6857f4edb9c88949bd56e2233da650">01253</a> <span class="preprocessor">Bool  nav_dir_make( const FS_STRING sz_name  )</span>
<a name="l01254"></a>01254 <span class="preprocessor"></span>{
<a name="l01255"></a>01255    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#e9d0f61d0e7b29a4e8e9e95347194f21">fat_check_mount_noopen</a>())
<a name="l01256"></a>01256       <span class="keywordflow">return</span> FALSE;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258    <span class="comment">// Create entry file</span>
<a name="l01259"></a>01259    <span class="keywordflow">if</span> ( !<a class="code" href="a00026.html#27b550ee0cf2326498755b429818b145">nav_file_create</a>( sz_name ))
<a name="l01260"></a>01260       <span class="keywordflow">return</span> FALSE;
<a name="l01261"></a>01261       
<a name="l01262"></a>01262    <span class="comment">// Alloc one cluster for the new dirctory</span>
<a name="l01263"></a>01263    MSB0(<a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>)=0xFF;    <span class="comment">// It is a new cluster list</span>
<a name="l01264"></a>01264    <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#09c9847870bc2202980b54e38ea62fae">u32_size_or_pos</a> = 1;    <span class="comment">// Only one sector (= one cluster)</span>
<a name="l01265"></a>01265    <span class="keywordflow">if</span> ( !<a class="code" href="a00018.html#1fa62b2728e71cff2e95556db7ed1b9c">fat_allocfreespace</a>())
<a name="l01266"></a>01266       <span class="keywordflow">return</span> FALSE;
<a name="l01267"></a>01267 
<a name="l01268"></a>01268    <span class="comment">// Save information on new directory</span>
<a name="l01269"></a>01269    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> = <a class="code" href="a00018.html#6d934f26f97b442c30712e57ee8b21e5">fs_g_seg</a>.<a class="code" href="a00009.html#da7b79119fecdfb1faab2512eb0ee172">u32_addr</a>; <span class="comment">// First cluster of the directory return by alloc_free_space</span>
<a name="l01270"></a>01270    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>    = 0;                 <span class="comment">// The size of the directory is null</span>
<a name="l01271"></a>01271    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>     = <a class="code" href="a00022.html#99004e3e756391a7ac1c4dde4db6864c">FS_ATTR_DIRECTORY</a>; <span class="comment">// Attribut is directory file</span>
<a name="l01272"></a>01272  
<a name="l01273"></a>01273    <span class="comment">// Initialize the values in the new directory</span>
<a name="l01274"></a>01274    <span class="keywordflow">if</span> ( !<a class="code" href="a00018.html#9510bd193c1e70f2307c5b9b07078511">fat_initialize_dir</a>())
<a name="l01275"></a>01275       <span class="keywordflow">return</span> FALSE;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277    <span class="comment">// Write directory information in her entry file</span>
<a name="l01278"></a>01278    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01279"></a>01279       <span class="keywordflow">return</span> FALSE;
<a name="l01280"></a>01280    <a class="code" href="a00017.html#40035dc41d435ed3281155cdf800cf02">fat_write_entry_file</a>();
<a name="l01281"></a>01281    
<a name="l01282"></a>01282    <span class="comment">// Go to position of new directory (it is the last)</span>
<a name="l01283"></a>01283    <span class="keywordflow">return</span> <a class="code" href="a00026.html#d7dbd335c9b54a9ebefddf5308df0409">nav_filelist_last</a>( <a class="code" href="a00022.html#d043d9359eeca08e8c5ea4d9136eb15b">FS_DIR</a> );
<a name="l01284"></a>01284 }
<a name="l01285"></a>01285 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01286"></a>01286 <span class="preprocessor"></span>
<a name="l01287"></a>01287 
<a name="l01301"></a><a class="code" href="a00027.html#661d4a0464a9da163de1e07aa9196f0d">01301</a> Bool  <a class="code" href="a00026.html#661d4a0464a9da163de1e07aa9196f0d">nav_getcwd</a>( <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_path  , U8 u8_size_path , Bool b_view_file_select  )
<a name="l01302"></a>01302 {
<a name="l01303"></a>01303    Bool status;
<a name="l01304"></a>01304    _MEM_TYPE_SLOW_   <a class="code" href="a00003.html">Fs_index</a> index;
<a name="l01305"></a>01305    U8 u8_save_size_path, <a class="code" href="a00017.html#5985f32ca0a3714cb4b55abf404be10c">u8_i</a>;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 
<a name="l01308"></a>01308    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#e9d0f61d0e7b29a4e8e9e95347194f21">fat_check_mount_noopen</a>())
<a name="l01309"></a>01309       <span class="keywordflow">return</span> FALSE;
<a name="l01310"></a>01310 
<a name="l01311"></a>01311    <span class="comment">// Save current position</span>
<a name="l01312"></a>01312    index = <a class="code" href="a00026.html#47882923fca657fb23001d23b6b5369d">nav_getindex</a>();
<a name="l01313"></a>01313 
<a name="l01314"></a>01314 
<a name="l01315"></a>01315    <span class="comment">// Set flag end of path</span>
<a name="l01316"></a>01316    u8_save_size_path = u8_size_path;
<a name="l01317"></a>01317    u8_size_path--;
<a name="l01318"></a>01318    <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01319"></a>01319    {
<a name="l01320"></a>01320       ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[u8_size_path] = 0;
<a name="l01321"></a>01321    }<span class="keywordflow">else</span>{
<a name="l01322"></a>01322       sz_path [u8_size_path]   = 0;
<a name="l01323"></a>01323    }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325    <span class="comment">// Loop for read each dir name of path</span>
<a name="l01326"></a>01326    <span class="keywordflow">while</span>( 1 )    <span class="comment">// Go to parent directory and select the current directory</span>
<a name="l01327"></a>01327    {
<a name="l01328"></a>01328       <span class="keywordflow">if</span>( b_view_file_select )
<a name="l01329"></a>01329       {
<a name="l01330"></a>01330          b_view_file_select = FALSE;
<a name="l01331"></a>01331          <span class="comment">// File selected ?</span>
<a name="l01332"></a>01332          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#909da9e84afbebf8ed5838cbe5002f60">fat_check_select</a>() )
<a name="l01333"></a>01333             <span class="keywordflow">continue</span>;   <span class="comment">// No file selected, then restart loop to read first directory</span>
<a name="l01334"></a>01334       }
<a name="l01335"></a>01335       <span class="keywordflow">else</span>
<a name="l01336"></a>01336       {
<a name="l01337"></a>01337          <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#b37aa8fc84aca800a020da78724d729e">nav_dir_gotoparent</a>() )    <span class="comment">// Go to parent directory and select the current directory</span>
<a name="l01338"></a>01338             <span class="keywordflow">break</span>;
<a name="l01339"></a>01339       }
<a name="l01340"></a>01340    
<a name="l01341"></a>01341       <span class="comment">// Read name</span>
<a name="l01342"></a>01342       <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#10603c2fe89bd66a17cfe3bb49a3fa14">nav_file_name</a>( sz_path  , u8_size_path , <a class="code" href="a00022.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a>, FALSE  ))
<a name="l01343"></a>01343          <span class="keywordflow">break</span>;
<a name="l01344"></a>01344 
<a name="l01345"></a>01345       <span class="comment">// Compute the size of name</span>
<a name="l01346"></a>01346       u8_i = 0;
<a name="l01347"></a>01347       <span class="keywordflow">while</span>( 1 )
<a name="l01348"></a>01348       {
<a name="l01349"></a>01349          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01350"></a>01350          {
<a name="l01351"></a>01351             <span class="keywordflow">if</span>( 0 == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[u8_i])
<a name="l01352"></a>01352                <span class="keywordflow">break</span>;
<a name="l01353"></a>01353          }<span class="keywordflow">else</span>{
<a name="l01354"></a>01354             <span class="keywordflow">if</span>( 0 == sz_path [u8_i])
<a name="l01355"></a>01355                <span class="keywordflow">break</span>;
<a name="l01356"></a>01356          }
<a name="l01357"></a>01357          u8_i++;
<a name="l01358"></a>01358       }
<a name="l01359"></a>01359       
<a name="l01360"></a>01360       <span class="comment">// check size buffer</span>
<a name="l01361"></a>01361       <span class="keywordflow">if</span>( (u8_i+1) == u8_size_path )
<a name="l01362"></a>01362       {
<a name="l01363"></a>01363          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#51829972f3c3b325c18cdddec0962d77">FS_ERR_BUFFER_FULL</a>;   <span class="comment">// The buffer of path name is full</span>
<a name="l01364"></a>01364          <span class="keywordflow">break</span>;
<a name="l01365"></a>01365       }
<a name="l01366"></a>01366       
<a name="l01367"></a>01367       <span class="comment">// Move the name at the end of path</span>
<a name="l01368"></a>01368       <span class="keywordflow">while</span>( 0 != u8_i )
<a name="l01369"></a>01369       {
<a name="l01370"></a>01370          u8_i--;
<a name="l01371"></a>01371          u8_size_path--;
<a name="l01372"></a>01372          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01373"></a>01373          {
<a name="l01374"></a>01374             ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[u8_size_path] = ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[u8_i];
<a name="l01375"></a>01375          }<span class="keywordflow">else</span>{
<a name="l01376"></a>01376             sz_path [u8_size_path]   = sz_path [u8_i];
<a name="l01377"></a>01377          }
<a name="l01378"></a>01378       }
<a name="l01379"></a>01379       <span class="comment">// Set '\' caracter before name</span>
<a name="l01380"></a>01380       u8_size_path--;
<a name="l01381"></a>01381       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01382"></a>01382       {
<a name="l01383"></a>01383          ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[u8_size_path] = <span class="charliteral">'\\'</span>;
<a name="l01384"></a>01384       }<span class="keywordflow">else</span>{
<a name="l01385"></a>01385          sz_path [u8_size_path]   = <span class="charliteral">'\\'</span>;
<a name="l01386"></a>01386       }
<a name="l01387"></a>01387    }
<a name="l01388"></a>01388 
<a name="l01389"></a>01389    <span class="keywordflow">if</span> ( <a class="code" href="a00022.html#94e90e580e7ef16c72c2f2cb187af995">FS_ERR_IS_ROOT</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l01390"></a>01390    {
<a name="l01391"></a>01391       <span class="comment">// End of path -&gt; add device name</span>
<a name="l01392"></a>01392       <span class="keywordflow">if</span>( 2 &gt; u8_size_path )
<a name="l01393"></a>01393       {
<a name="l01394"></a>01394          <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#51829972f3c3b325c18cdddec0962d77">FS_ERR_BUFFER_FULL</a>;   <span class="comment">// The buffer of path name is full</span>
<a name="l01395"></a>01395          status = FALSE;
<a name="l01396"></a>01396       }
<a name="l01397"></a>01397       <span class="keywordflow">else</span>
<a name="l01398"></a>01398       {
<a name="l01399"></a>01399          <span class="comment">// Create a device name</span>
<a name="l01400"></a>01400          <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01401"></a>01401          {
<a name="l01402"></a>01402             ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] = <a class="code" href="a00026.html#cf3be5c3ce9b724a135162437642e091">nav_drive_getname</a>();    <span class="comment">// Letter</span>
<a name="l01403"></a>01403             ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[1] = <span class="charliteral">':'</span>;                    <span class="comment">// ":"</span>
<a name="l01404"></a>01404          }<span class="keywordflow">else</span>{
<a name="l01405"></a>01405             sz_path [0] = <a class="code" href="a00026.html#cf3be5c3ce9b724a135162437642e091">nav_drive_getname</a>();  <span class="comment">// Letter</span>
<a name="l01406"></a>01406             sz_path [1] = <span class="charliteral">':'</span>;                     <span class="comment">// ":"</span>
<a name="l01407"></a>01407          }
<a name="l01408"></a>01408 
<a name="l01409"></a>01409          <span class="comment">// Move all path at the beginning of buffer</span>
<a name="l01410"></a>01410          u8_i = 2;
<a name="l01411"></a>01411          <span class="keywordflow">while</span>( u8_save_size_path != u8_size_path )
<a name="l01412"></a>01412          {
<a name="l01413"></a>01413             <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01414"></a>01414             {
<a name="l01415"></a>01415                ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[u8_i] = ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[u8_size_path];
<a name="l01416"></a>01416             }<span class="keywordflow">else</span>{
<a name="l01417"></a>01417                sz_path [u8_i] = sz_path [u8_size_path];
<a name="l01418"></a>01418             }
<a name="l01419"></a>01419             u8_i++;
<a name="l01420"></a>01420             u8_size_path++;
<a name="l01421"></a>01421          }
<a name="l01422"></a>01422          status = TRUE;
<a name="l01423"></a>01423       }
<a name="l01424"></a>01424    }
<a name="l01425"></a>01425    <span class="keywordflow">else</span>
<a name="l01426"></a>01426    {  <span class="comment">// Error system</span>
<a name="l01427"></a>01427       status = FALSE;
<a name="l01428"></a>01428    }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430    <span class="comment">// Reinitialise the current position</span>
<a name="l01431"></a>01431    <a class="code" href="a00026.html#503f8d42be2b70cb554589ac7974ed78">nav_gotoindex</a>( &amp;index );
<a name="l01432"></a>01432    <span class="keywordflow">return</span> status;
<a name="l01433"></a>01433 }
<a name="l01434"></a>01434 
<a name="l01435"></a>01435 
<a name="l01452"></a><a class="code" href="a00027.html#3d3f2ed17daf26a7aedc2a561cee2558">01452</a> Bool  <a class="code" href="a00026.html#3d3f2ed17daf26a7aedc2a561cee2558">nav_setcwd</a>( <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_path , Bool b_match_case , Bool b_create )
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454    _MEM_TYPE_SLOW_   <a class="code" href="a00003.html">Fs_index</a> index;
<a name="l01455"></a>01455    <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_save_path = 0;
<a name="l01456"></a>01456    Bool b_create_name = FALSE;
<a name="l01457"></a>01457 
<a name="l01458"></a>01458    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#f6f4a9e2d8e7b6dd557871b6bc2c2ee0">fat_check_noopen</a>())
<a name="l01459"></a>01459       <span class="keywordflow">return</span> FALSE;
<a name="l01460"></a>01460 
<a name="l01461"></a>01461    <span class="comment">// Save current position</span>
<a name="l01462"></a>01462    index = <a class="code" href="a00026.html#47882923fca657fb23001d23b6b5369d">nav_getindex</a>();
<a name="l01463"></a>01463 
<a name="l01464"></a>01464    <span class="comment">// Check syntact "\path..."</span>
<a name="l01465"></a>01465    <span class="keywordflow">if</span>( (( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ((<span class="charliteral">'\\'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0]) || (<span class="charliteral">'/'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0])) )
<a name="l01466"></a>01466    ||  ((!<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ((<span class="charliteral">'\\'</span>  == sz_path [0]) || (<span class="charliteral">'/'</span>  == sz_path [0])) ) )
<a name="l01467"></a>01467    {
<a name="l01468"></a>01468       <span class="comment">// Go to root dir of current drive</span>
<a name="l01469"></a>01469       <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#9447385c9c400b07b99c61ada1a6ea77">nav_dir_root</a>())
<a name="l01470"></a>01470          <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01471"></a>01471       sz_path  += (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01472"></a>01472    }<span class="keywordflow">else</span>
<a name="l01473"></a>01473    
<a name="l01474"></a>01474    <span class="comment">// Check syntact "x:\path..."</span>
<a name="l01475"></a>01475    <span class="keywordflow">if</span>( (( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; (( <span class="charliteral">':'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[1] ) &amp;&amp; ((<span class="charliteral">'\\'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[2] ) || (<span class="charliteral">'/'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[2]))) )
<a name="l01476"></a>01476    ||  ((!<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; (( <span class="charliteral">':'</span>  == sz_path [1] ) &amp;&amp; ((<span class="charliteral">'\\'</span>  == sz_path [2] ) || (<span class="charliteral">'/'</span>  == sz_path [2]))) ) )
<a name="l01477"></a>01477    {
<a name="l01478"></a>01478       <span class="comment">// Go to drive</span>
<a name="l01479"></a>01479       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01480"></a>01480       {
<a name="l01481"></a>01481          <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#dd247ba4e5086c74c6f106a55617872a">nav_drive_set</a>( ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0]-<span class="charliteral">'A'</span> ) )
<a name="l01482"></a>01482             <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01483"></a>01483       }<span class="keywordflow">else</span>{
<a name="l01484"></a>01484          <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#dd247ba4e5086c74c6f106a55617872a">nav_drive_set</a>( sz_path [0]-<span class="charliteral">'A'</span> ) )
<a name="l01485"></a>01485             <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01486"></a>01486       }
<a name="l01487"></a>01487       <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#aa10a2b4e4db0e4eb602b19b4f9ff9b9">nav_partition_mount</a>())
<a name="l01488"></a>01488          <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01489"></a>01489       sz_path  += 3*(Is_unicode? 2 : 1 );
<a name="l01490"></a>01490    }<span class="keywordflow">else</span>
<a name="l01491"></a>01491 
<a name="l01492"></a>01492    <span class="comment">// Check syntact ".\path..."</span>
<a name="l01493"></a>01493    <span class="keywordflow">if</span>( (( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; (( <span class="charliteral">'.'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] ) &amp;&amp; ((<span class="charliteral">'\\'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[1] ) || (<span class="charliteral">'/'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[1] ))) )
<a name="l01494"></a>01494    ||  ((!<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; (( <span class="charliteral">'.'</span>  == sz_path [0] ) &amp;&amp; ((<span class="charliteral">'\\'</span>  == sz_path [1] ) || (<span class="charliteral">'/'</span>  == sz_path [1] ))) ) )
<a name="l01495"></a>01495    {
<a name="l01496"></a>01496       <span class="comment">// Search in current directory</span>
<a name="l01497"></a>01497       sz_path  += 2*(<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01498"></a>01498    }<span class="keywordflow">else</span>
<a name="l01499"></a>01499    
<a name="l01500"></a>01500    {
<a name="l01501"></a>01501       <span class="comment">// Check syntact "..\..\path..."</span>
<a name="l01502"></a>01502       <span class="keywordflow">if</span>( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a> )
<a name="l01503"></a>01503       {
<a name="l01504"></a>01504          <span class="keywordflow">while</span>(( <span class="charliteral">'.'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] )
<a name="l01505"></a>01505          &amp;&amp;    ( <span class="charliteral">'.'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[1] )
<a name="l01506"></a>01506          &amp;&amp;    ((<span class="charliteral">'\\'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[2]) || (<span class="charliteral">'/'</span>  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[2]) || (0  == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[2])) )
<a name="l01507"></a>01507          {
<a name="l01508"></a>01508             <span class="comment">// Go to parent directory</span>
<a name="l01509"></a>01509             <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#b37aa8fc84aca800a020da78724d729e">nav_dir_gotoparent</a>() )
<a name="l01510"></a>01510                <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01511"></a>01511             sz_path  += (2*2); <span class="comment">// jump ".."</span>
<a name="l01512"></a>01512             <span class="keywordflow">if</span>( 0 != ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0])
<a name="l01513"></a>01513                sz_path  += (2*1); <span class="comment">// jump "/"</span>
<a name="l01514"></a>01514          }
<a name="l01515"></a>01515       }<span class="keywordflow">else</span>{
<a name="l01516"></a>01516          <span class="keywordflow">while</span>(( <span class="charliteral">'.'</span>  == sz_path [0] )
<a name="l01517"></a>01517          &amp;&amp;    ( <span class="charliteral">'.'</span>  == sz_path [1] )
<a name="l01518"></a>01518          &amp;&amp;    ((<span class="charliteral">'\\'</span>  == sz_path [2]) || (<span class="charliteral">'/'</span>  == sz_path [2]) || (0  == sz_path [2])) )
<a name="l01519"></a>01519          {
<a name="l01520"></a>01520          <span class="comment">// Go to parent directory</span>
<a name="l01521"></a>01521          <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#b37aa8fc84aca800a020da78724d729e">nav_dir_gotoparent</a>() )
<a name="l01522"></a>01522             <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01523"></a>01523             sz_path  += 2; <span class="comment">// jump ".."</span>
<a name="l01524"></a>01524             <span class="keywordflow">if</span>( 0 != sz_path [0])
<a name="l01525"></a>01525                sz_path  +=1; <span class="comment">// jump "/"</span>
<a name="l01526"></a>01526          }
<a name="l01527"></a>01527       }
<a name="l01528"></a>01528    }
<a name="l01529"></a>01529 
<a name="l01530"></a>01530    <span class="comment">// Reset list to start the search at the beginning</span>
<a name="l01531"></a>01531    <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>())
<a name="l01532"></a>01532       <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534    <span class="keywordflow">while</span>( 1 )
<a name="l01535"></a>01535    {
<a name="l01536"></a>01536       <span class="keywordflow">if</span>( (( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ( 0 == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] ) )
<a name="l01537"></a>01537       ||  ((!<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ( 0 == sz_path [0] ) ) )
<a name="l01538"></a>01538       {
<a name="l01539"></a>01539          <span class="keywordflow">return</span> TRUE;   <span class="comment">// path (without file) is find or create</span>
<a name="l01540"></a>01540       }
<a name="l01541"></a>01541       <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#017ce6b53af128e5064a06bc8fadec25">nav_filelist_findname</a>( sz_path  , b_match_case  ))
<a name="l01542"></a>01542       {
<a name="l01543"></a>01543          <span class="comment">// Fileor folder not found</span>
<a name="l01544"></a>01544          <span class="keywordflow">if</span>( !b_create )
<a name="l01545"></a>01545             <span class="keywordflow">goto</span> nav_setcwd_fail;   <span class="comment">// don't creat path then exit</span>
<a name="l01546"></a>01546          <span class="comment">// Set flag to create path</span>
<a name="l01547"></a>01547          b_create_name = TRUE;
<a name="l01548"></a>01548          sz_save_path = sz_path;
<a name="l01549"></a>01549       }
<a name="l01550"></a>01550       
<a name="l01551"></a>01551       <span class="keywordflow">while</span>( 1 )
<a name="l01552"></a>01552       {
<a name="l01553"></a>01553          sz_path  += (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01554"></a>01554          <span class="keywordflow">if</span>( (( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ( 0 == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] ) )
<a name="l01555"></a>01555          ||  ((!<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ( 0 == sz_path [0] ) ) )
<a name="l01556"></a>01556          {
<a name="l01557"></a>01557             <span class="comment">// Is it the last name of path and it is a file</span>
<a name="l01558"></a>01558             <span class="keywordflow">if</span>( b_create_name )
<a name="l01559"></a>01559             {
<a name="l01560"></a>01560                <span class="comment">// the file must be create</span>
<a name="l01561"></a>01561                <a class="code" href="a00026.html#27b550ee0cf2326498755b429818b145">nav_file_create</a>( sz_save_path );
<a name="l01562"></a>01562             }
<a name="l01563"></a>01563             <span class="keywordflow">break</span>;   <span class="comment">// file of path is found or created, then end of set_cwd</span>
<a name="l01564"></a>01564          }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566          <span class="keywordflow">if</span>( (( <a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ((<span class="charliteral">'\\'</span> == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] ) || (<span class="charliteral">'/'</span> == ((<a class="code" href="a00022.html#4b07eeef6c66c629ec6708f8eee35f58">FS_STR_UNICODE</a>)sz_path )[0] )) )
<a name="l01567"></a>01567          ||  ((!<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>) &amp;&amp; ((<span class="charliteral">'\\'</span> == sz_path [0] ) || (<span class="charliteral">'/'</span> == sz_path [0] )) ) )
<a name="l01568"></a>01568          {
<a name="l01569"></a>01569             <span class="comment">// Is it a folder name</span>
<a name="l01570"></a>01570             <span class="keywordflow">if</span>( b_create_name )
<a name="l01571"></a>01571             {
<a name="l01572"></a>01572                <span class="comment">// The folder don't exist and it must be create</span>
<a name="l01573"></a>01573                <a class="code" href="a00026.html#3e6857f4edb9c88949bd56e2233da650">nav_dir_make</a>( sz_save_path );
<a name="l01574"></a>01574             }
<a name="l01575"></a>01575             <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#e0caae1c6e4a737af4ad0aa5d4171e79">fat_entry_is_dir</a>() )
<a name="l01576"></a>01576                <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01577"></a>01577             <span class="comment">// jump '\'</span>
<a name="l01578"></a>01578             sz_path  += (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01579"></a>01579             <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#dca006b356e65cb05459f7bd7917a1ed">nav_dir_cd</a>())
<a name="l01580"></a>01580                <span class="keywordflow">goto</span> nav_setcwd_fail;
<a name="l01581"></a>01581             <span class="keywordflow">break</span>;
<a name="l01582"></a>01582          }
<a name="l01583"></a>01583       }
<a name="l01584"></a>01584       
<a name="l01585"></a>01585    }
<a name="l01586"></a>01586       
<a name="l01587"></a>01587 nav_setcwd_fail:
<a name="l01588"></a>01588    <span class="comment">// Reinitialise the current position</span>
<a name="l01589"></a>01589    <a class="code" href="a00026.html#503f8d42be2b70cb554589ac7974ed78">nav_gotoindex</a>( &amp;index );
<a name="l01590"></a>01590    <span class="keywordflow">return</span> FALSE;
<a name="l01591"></a>01591 }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593 
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 
<a name="l01596"></a>01596 <span class="comment">//**********************************************************************</span>
<a name="l01597"></a>01597 <span class="comment">//*********************** File control fonctions ***********************</span>
<a name="l01598"></a>01598 
<a name="l01599"></a>01599 
<a name="l01619"></a><a class="code" href="a00027.html#10603c2fe89bd66a17cfe3bb49a3fa14">01619</a> Bool  <a class="code" href="a00026.html#10603c2fe89bd66a17cfe3bb49a3fa14">nav_file_name</a>( <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_name , U8 u8_size_max , Bool b_mode , Bool b_match_case  )
<a name="l01620"></a>01620 {
<a name="l01621"></a>01621    U16  u16_ptr_save_entry;
<a name="l01622"></a>01622    Bool  b_readshortname = FALSE;
<a name="l01623"></a>01623 
<a name="l01624"></a>01624    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>())
<a name="l01625"></a>01625       <span class="keywordflow">return</span> FALSE;
<a name="l01626"></a>01626 
<a name="l01628"></a>01628    <span class="keywordflow">if</span>( (<a class="code" href="a00022.html#a07ca9c4f511c7e1f326c27aeecb7178">FS_NAME_GET</a> == b_mode)
<a name="l01629"></a>01629    &amp;&amp;  (0 == u8_size_max) )
<a name="l01630"></a>01630    {
<a name="l01631"></a>01631       <span class="keywordflow">return</span> TRUE;
<a name="l01632"></a>01632    }
<a name="l01633"></a>01633 
<a name="l01634"></a>01634    <span class="comment">// save the current file entry</span>
<a name="l01635"></a>01635    u16_ptr_save_entry = <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>;
<a name="l01636"></a>01636    <span class="comment">// if it is the beginning of the directory</span>
<a name="l01637"></a>01637    <span class="keywordflow">if</span> ( 0 == <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> )
<a name="l01638"></a>01638    {
<a name="l01639"></a>01639       b_readshortname = TRUE;   <span class="comment">// It isn't possibled to have a long name</span>
<a name="l01640"></a>01640    }
<a name="l01641"></a>01641    <span class="keywordflow">else</span>
<a name="l01642"></a>01642    {
<a name="l01643"></a>01643       <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>--; <span class="comment">// Go to eventualy first long name entry</span>
<a name="l01644"></a>01644    }
<a name="l01645"></a>01645 
<a name="l01646"></a>01646    <span class="comment">// loop in directory entry</span>
<a name="l01647"></a>01647    <span class="keywordflow">while</span>( 1 )
<a name="l01648"></a>01648    {
<a name="l01649"></a>01649       <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01650"></a>01650          <span class="keywordflow">break</span>; <span class="comment">// error</span>
<a name="l01651"></a>01651 
<a name="l01652"></a>01652       <span class="keywordflow">if</span> ( b_readshortname )
<a name="l01653"></a>01653       { 
<a name="l01654"></a>01654          <span class="comment">// It is necessary to read short name</span>
<a name="l01655"></a>01655          <span class="keywordflow">return</span> <a class="code" href="a00017.html#6bc798e9f4eac3457cc61e9cd9ba70b9">fat_entry_shortname</a>( sz_name , u8_size_max , b_mode  );
<a name="l01656"></a>01656       }
<a name="l01657"></a>01657 
<a name="l01658"></a>01658       <span class="comment">// Check or read the long file name of this entry</span>
<a name="l01659"></a>01659       <span class="keywordflow">if</span> ( <a class="code" href="a00017.html#c0bdbd911ecf04b3fcebbc2e4ae33166">fat_entry_longname</a>( sz_name , u8_size_max , b_mode , b_match_case  ))
<a name="l01660"></a>01660       {
<a name="l01661"></a>01661          <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> = u16_ptr_save_entry;
<a name="l01662"></a>01662          <span class="keywordflow">return</span> TRUE;
<a name="l01663"></a>01663       }
<a name="l01664"></a>01664       
<a name="l01665"></a>01665       <span class="keywordflow">if</span> ( <a class="code" href="a00022.html#2dad540bd4ed9c78eff34ba269371d8d">FS_NO_LAST_LFN_ENTRY</a> != <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )
<a name="l01666"></a>01666       {
<a name="l01667"></a>01667          <span class="comment">// Go to the main (short name) entry file</span>
<a name="l01668"></a>01668          <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> = u16_ptr_save_entry;
<a name="l01669"></a>01669 
<a name="l01670"></a>01670          <span class="keywordflow">if</span> ( <a class="code" href="a00022.html#934f48a8e1cb558d75ec00bbd242030d">FS_ERR_ENTRY_BAD</a> == <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> )   <span class="comment">// It isn't a long name entry</span>
<a name="l01671"></a>01671          {  <span class="comment">// There aren't long file name</span>
<a name="l01672"></a>01672             b_readshortname = TRUE;   <span class="comment">// It is mandatory to use the short name</span>
<a name="l01673"></a>01673             <span class="keywordflow">continue</span>;                 <span class="comment">// restart the loop</span>
<a name="l01674"></a>01674          }
<a name="l01675"></a>01675          <span class="comment">// here, the status is error system or file name diffferent of name checked</span>
<a name="l01676"></a>01676          <span class="keywordflow">break</span>;
<a name="l01677"></a>01677       }
<a name="l01678"></a>01678       <span class="comment">// Increment the buffer to store the next name with the continuation</span>
<a name="l01679"></a>01679       sz_name += <a class="code" href="a00018.html#bbdca2b90701f373bf6c865c88c99697">FS_SIZE_LFN_ENTRY</a> * (<a class="code" href="a00018.html#4ad00946d48b5c25c6734344ecf974c1">Is_unicode</a>? 2 : 1 );
<a name="l01680"></a>01680       u8_size_max -= <a class="code" href="a00018.html#bbdca2b90701f373bf6c865c88c99697">FS_SIZE_LFN_ENTRY</a>;
<a name="l01681"></a>01681 
<a name="l01682"></a>01682       <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>--;   <span class="comment">// go to previous long file name entry</span>
<a name="l01683"></a>01683 
<a name="l01684"></a>01684    }  <span class="comment">// end of loop while(1)</span>
<a name="l01685"></a>01685    <span class="keywordflow">return</span> FALSE;
<a name="l01686"></a>01686 }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688 
<a name="l01693"></a><a class="code" href="a00027.html#c3989dc4a26fbbdf0726fafae6fe4648">01693</a> U32   <a class="code" href="a00026.html#c3989dc4a26fbbdf0726fafae6fe4648">nav_file_lgt</a>( <span class="keywordtype">void</span> )
<a name="l01694"></a>01694 {
<a name="l01695"></a>01695    <span class="keywordflow">return</span> <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>;
<a name="l01696"></a>01696 }
<a name="l01697"></a>01697 
<a name="l01698"></a>01698 
<a name="l01703"></a><a class="code" href="a00027.html#88385884567371f5d139c8f2b4b03a50">01703</a> U16   <a class="code" href="a00026.html#88385884567371f5d139c8f2b4b03a50">nav_file_lgtsector</a>( <span class="keywordtype">void</span> )
<a name="l01704"></a>01704 {
<a name="l01705"></a>01705    <span class="keywordflow">return</span> (<a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> &gt;&gt; <a class="code" href="a00018.html#90491f94e13d340a9d3f98e57a66e9d3">FS_SHIFT_B_TO_SECTOR</a>);
<a name="l01706"></a>01706 }
<a name="l01707"></a>01707 
<a name="l01708"></a>01708 
<a name="l01714"></a><a class="code" href="a00027.html#414f55acdda5d91d87d0959155c4e615">01714</a> Bool  <a class="code" href="a00026.html#414f55acdda5d91d87d0959155c4e615">nav_file_isreadonly</a>( <span class="keywordtype">void</span> )
<a name="l01715"></a>01715 {
<a name="l01716"></a>01716    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>() )
<a name="l01717"></a>01717       <span class="keywordflow">return</span> TRUE;   <span class="comment">// No file selected</span>
<a name="l01718"></a>01718    <span class="keywordflow">if</span>( <a class="code" href="a00015.html#f4b64acad5f46d01e082d7a7301078df">mem_wr_protect</a>( <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#43065262a1a7560b143e0b48cbf5ccbd">u8_lun</a> ) )
<a name="l01719"></a>01719       <span class="keywordflow">return</span> TRUE;   <span class="comment">// Disk protected</span>
<a name="l01720"></a>01720    <span class="keywordflow">return</span> (0!=(<a class="code" href="a00022.html#1205ff33f705779959e1bc40f6d8374f">FS_ATTR_READ_ONLY</a> &amp; <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>));
<a name="l01721"></a>01721 }
<a name="l01722"></a>01722 
<a name="l01723"></a>01723 
<a name="l01729"></a><a class="code" href="a00027.html#0e9d8d4d0a438b0803c57c775e6c3b9c">01729</a> Bool  <a class="code" href="a00026.html#0e9d8d4d0a438b0803c57c775e6c3b9c">nav_file_isdir</a>( <span class="keywordtype">void</span> )
<a name="l01730"></a>01730 {
<a name="l01731"></a>01731    <span class="keywordflow">return</span> <a class="code" href="a00017.html#e0caae1c6e4a737af4ad0aa5d4171e79">fat_entry_is_dir</a>();
<a name="l01732"></a>01732 }
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 
<a name="l01742"></a><a class="code" href="a00027.html#4a3e65b107c26de2f7ff4fb1d2a854e3">01742</a> Bool  <a class="code" href="a00026.html#4a3e65b107c26de2f7ff4fb1d2a854e3">nav_file_checkext</a>( <span class="keyword">const</span> <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_filterext )
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744    <span class="keywordflow">if</span> ( <a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>() )
<a name="l01745"></a>01745    {
<a name="l01746"></a>01746       <span class="comment">// read directory</span>
<a name="l01747"></a>01747       <span class="keywordflow">if</span> ( <a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01748"></a>01748       {
<a name="l01749"></a>01749          <span class="comment">// Check the entry with filter</span>
<a name="l01750"></a>01750          <span class="keywordflow">if</span> ( <a class="code" href="a00017.html#d690d22df98e6c1fa927c38b1d1a0fae">fat_entry_checkext</a>( (<a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a>) sz_filterext ) )
<a name="l01751"></a>01751             <span class="keywordflow">return</span> TRUE;
<a name="l01752"></a>01752       }
<a name="l01753"></a>01753    }
<a name="l01754"></a>01754    <span class="keywordflow">return</span> FALSE;
<a name="l01755"></a>01755 }
<a name="l01756"></a>01756 
<a name="l01757"></a>01757 
<a name="l01768"></a><a class="code" href="a00027.html#f3db073297dcfda3195606a50f2607e0">01768</a> Bool  <a class="code" href="a00026.html#f3db073297dcfda3195606a50f2607e0">nav_file_dateget</a>( <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_date , Bool type_date )
<a name="l01769"></a>01769 {
<a name="l01770"></a>01770    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>())
<a name="l01771"></a>01771       <span class="keywordflow">return</span> FALSE;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773    <span class="comment">// read directory</span>
<a name="l01774"></a>01774    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01775"></a>01775       <span class="keywordflow">return</span> FALSE;
<a name="l01776"></a>01776    
<a name="l01777"></a>01777    <a class="code" href="a00018.html#51041500c2e36ab39aad19b54e93d504">fat_get_date</a>( sz_date , type_date );
<a name="l01778"></a>01778    <span class="keywordflow">return</span> TRUE;
<a name="l01779"></a>01779 }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781 
<a name="l01786"></a><a class="code" href="a00027.html#577b3a7ebdc2c85ee56cbba554af9b87">01786</a> U8    <a class="code" href="a00026.html#577b3a7ebdc2c85ee56cbba554af9b87">nav_file_attributget</a>( <span class="keywordtype">void</span> )
<a name="l01787"></a>01787 {
<a name="l01788"></a>01788    <span class="keywordflow">return</span> <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>;
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 
<a name="l01792"></a>01792 
<a name="l01793"></a>01793 <span class="preprocessor">#if (FSFEATURE_WRITE_COMPLET == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE_COMPLET))</span>
<a name="l01804"></a><a class="code" href="a00027.html#2095f8c45dad704dfee904b360ebf45b">01804</a> <span class="preprocessor">Bool  nav_file_dateset( const FS_STRING sz_date , Bool type_date )</span>
<a name="l01805"></a>01805 <span class="preprocessor"></span>{
<a name="l01806"></a>01806    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>())
<a name="l01807"></a>01807       <span class="keywordflow">return</span> TRUE;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809    <span class="comment">// read directory</span>
<a name="l01810"></a>01810    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01811"></a>01811       <span class="keywordflow">return</span> FALSE;
<a name="l01812"></a>01812       
<a name="l01813"></a>01813    <a class="code" href="a00018.html#838253d384d03898e6fcb2b3a7687e43">fat_set_date</a>( sz_date , type_date );
<a name="l01814"></a>01814    <span class="keywordflow">return</span> <a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>();  <span class="comment">// In case of error during writing data, flush the data before exit fonction</span>
<a name="l01815"></a>01815 }
<a name="l01816"></a>01816 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01817"></a>01817 <span class="preprocessor"></span>
<a name="l01818"></a>01818 
<a name="l01819"></a>01819 <span class="preprocessor">#if (FSFEATURE_WRITE_COMPLET == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE_COMPLET))</span>
<a name="l01827"></a><a class="code" href="a00027.html#2983932f3bf791ef93f633b5b786a04a">01827</a> <span class="preprocessor">Bool  nav_file_attributset( U8 u8_attribut )</span>
<a name="l01828"></a>01828 <span class="preprocessor"></span>{
<a name="l01829"></a>01829    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#47e29fedbed4084c9f8ec6f27b51015d">fat_check_mount_select</a>())
<a name="l01830"></a>01830       <span class="keywordflow">return</span> FALSE;
<a name="l01831"></a>01831 
<a name="l01832"></a>01832    <span class="comment">// read directory</span>
<a name="l01833"></a>01833    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01834"></a>01834       <span class="keywordflow">return</span> FALSE;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836    <span class="comment">// save the new attribut with a filter attribut</span>
<a name="l01837"></a>01837    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a> &amp;= (~(<a class="code" href="a00022.html#1205ff33f705779959e1bc40f6d8374f">FS_ATTR_READ_ONLY</a>|<a class="code" href="a00022.html#df87e26693107dd4b2f6f31327c6d52c">FS_ATTR_HIDDEN</a>|<a class="code" href="a00022.html#568a047cd2a5eb946b9ebb1f561cfa71">FS_ATTR_SYSTEM</a>|<a class="code" href="a00022.html#6983c8dea538d1ad6e43f7737f4776a3">FS_ATTR_ARCHIVE</a>));
<a name="l01838"></a>01838    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a> |= u8_attribut &amp; (<a class="code" href="a00022.html#1205ff33f705779959e1bc40f6d8374f">FS_ATTR_READ_ONLY</a>|<a class="code" href="a00022.html#df87e26693107dd4b2f6f31327c6d52c">FS_ATTR_HIDDEN</a>|<a class="code" href="a00022.html#568a047cd2a5eb946b9ebb1f561cfa71">FS_ATTR_SYSTEM</a>|<a class="code" href="a00022.html#6983c8dea538d1ad6e43f7737f4776a3">FS_ATTR_ARCHIVE</a>);
<a name="l01839"></a>01839    <a class="code" href="a00017.html#40035dc41d435ed3281155cdf800cf02">fat_write_entry_file</a>();
<a name="l01840"></a>01840    <span class="keywordflow">return</span> <a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>();  <span class="comment">// In case of error during writing data, flush the data before exit fonction</span>
<a name="l01841"></a>01841 }
<a name="l01842"></a>01842 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01843"></a>01843 <span class="preprocessor"></span>
<a name="l01844"></a>01844 
<a name="l01845"></a>01845 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l01855"></a><a class="code" href="a00027.html#8cf46891df029a9f3b62503d2c3cc065">01855</a> <span class="preprocessor">Bool  nav_file_del( Bool b_only_empty )</span>
<a name="l01856"></a>01856 <span class="preprocessor"></span>{
<a name="l01857"></a>01857    U8 u8_folder_level = 0xFF;
<a name="l01858"></a>01858 
<a name="l01859"></a>01859    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#003f1c81dcb2c7a95f191c30b8a4f258">fat_check_mount_select_noopen</a>())
<a name="l01860"></a>01860       <span class="keywordflow">return</span> FALSE;
<a name="l01861"></a>01861 
<a name="l01862"></a>01862    <span class="keywordflow">goto</span> nav_file_del_test_dir_or_file;
<a name="l01863"></a>01863      
<a name="l01864"></a>01864    <span class="comment">// loop to scan and delete ALL folders and ALL files</span>
<a name="l01865"></a>01865    <span class="keywordflow">while</span>(1)
<a name="l01866"></a>01866    {
<a name="l01867"></a>01867       <span class="keywordflow">while</span>(1)
<a name="l01868"></a>01868       {
<a name="l01869"></a>01869          <span class="keywordflow">if</span>( <a class="code" href="a00026.html#066eaff61613f07dc5fb1f3313747aef">nav_filelist_set</a>( 0 , <a class="code" href="a00027.html#793c4ce9436637d68ab25dc859abc35a">FS_FIND_NEXT</a> ) )
<a name="l01870"></a>01870          {
<a name="l01871"></a>01871             <span class="keywordflow">if</span>( b_only_empty )
<a name="l01872"></a>01872             {
<a name="l01873"></a>01873                <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#4bd395871fad334222e972d4c62bf206">FS_ERR_DIR_NOT_EMPTY</a>;      <span class="comment">// Erase only the empty directory</span>
<a name="l01874"></a>01874                <span class="keywordflow">return</span> FALSE;
<a name="l01875"></a>01875             }
<a name="l01876"></a>01876             <span class="keywordflow">break</span>; <span class="comment">// a next file and directory is found in current directory</span>
<a name="l01877"></a>01877          }
<a name="l01878"></a>01878          
<a name="l01879"></a>01879          <span class="comment">// No dir in current dir then go to parent dir</span>
<a name="l01880"></a>01880          <span class="comment">// Remark, nav_dir_gotoparent() routine go to in parent dir and select the children dir in list</span>
<a name="l01881"></a>01881          <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#b37aa8fc84aca800a020da78724d729e">nav_dir_gotoparent</a>() )
<a name="l01882"></a>01882             <span class="keywordflow">return</span> FALSE;
<a name="l01883"></a>01883          
<a name="l01884"></a>01884          <span class="comment">// delete folder entry name and cluster list</span>
<a name="l01885"></a>01885          <span class="keywordflow">if</span> ( !<a class="code" href="a00018.html#797fc629a4a513e6a5f2951720da5d47">fat_delete_file</a>( TRUE ))
<a name="l01886"></a>01886             <span class="keywordflow">return</span> FALSE;
<a name="l01887"></a>01887 
<a name="l01888"></a>01888          <span class="keywordflow">if</span>( 0 == u8_folder_level )
<a name="l01889"></a>01889          {
<a name="l01890"></a>01890             <span class="comment">// end of del folder</span>
<a name="l01891"></a>01891             <span class="keywordflow">return</span> TRUE; <span class="comment">//********* END OF DEL TREE **************</span>
<a name="l01892"></a>01892          }
<a name="l01893"></a>01893          u8_folder_level--;
<a name="l01894"></a>01894 
<a name="l01895"></a>01895       } <span class="comment">// end of second while (1)</span>
<a name="l01896"></a>01896       
<a name="l01897"></a>01897 nav_file_del_test_dir_or_file:
<a name="l01898"></a>01898       <span class="keywordflow">if</span>( <a class="code" href="a00026.html#0e9d8d4d0a438b0803c57c775e6c3b9c">nav_file_isdir</a>())
<a name="l01899"></a>01899       {
<a name="l01900"></a>01900          <span class="comment">// here, a new directory is found and is selected</span>
<a name="l01901"></a>01901          <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#dca006b356e65cb05459f7bd7917a1ed">nav_dir_cd</a>())
<a name="l01902"></a>01902             <span class="keywordflow">return</span> FALSE;
<a name="l01903"></a>01903          u8_folder_level++;
<a name="l01904"></a>01904       }
<a name="l01905"></a>01905       <span class="keywordflow">else</span>
<a name="l01906"></a>01906       {
<a name="l01907"></a>01907          <span class="comment">// here, a new file is found and is selected</span>
<a name="l01908"></a>01908          <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#07f36d38eda0af16ef7ef899129d7e7b">fat_check_nav_access_file</a>( TRUE ) )
<a name="l01909"></a>01909             <span class="keywordflow">return</span> FALSE;
<a name="l01910"></a>01910          <span class="comment">// delete file entry name and cluster list</span>
<a name="l01911"></a>01911          <span class="keywordflow">if</span> ( !<a class="code" href="a00018.html#797fc629a4a513e6a5f2951720da5d47">fat_delete_file</a>( TRUE ))
<a name="l01912"></a>01912             <span class="keywordflow">return</span> FALSE;
<a name="l01913"></a>01913          <span class="keywordflow">if</span>( 0xFF == u8_folder_level )
<a name="l01914"></a>01914             <span class="keywordflow">break</span>;   <span class="comment">// only one file to del</span>
<a name="l01915"></a>01915       } <span class="comment">// if dir OR file</span>
<a name="l01916"></a>01916    } <span class="comment">// end of first while(1)</span>
<a name="l01917"></a>01917    
<a name="l01918"></a>01918    <span class="comment">// Reset selection</span>
<a name="l01919"></a>01919    <a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>();
<a name="l01920"></a>01920    <span class="keywordflow">return</span> <a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>();  <span class="comment">// In case of error during writing data, flush the data before exit fonction</span>
<a name="l01921"></a>01921 }
<a name="l01922"></a>01922 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01923"></a>01923 <span class="preprocessor"></span>
<a name="l01924"></a>01924 
<a name="l01925"></a>01925 <span class="preprocessor">#if (FSFEATURE_WRITE_COMPLET == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE_COMPLET))</span>
<a name="l01933"></a><a class="code" href="a00027.html#db4a11790eddec97933f80ea44dbefa8">01933</a> <span class="preprocessor">Bool  nav_file_rename( const FS_STRING sz_name  )</span>
<a name="l01934"></a>01934 <span class="preprocessor"></span>{
<a name="l01935"></a>01935    U16 u16_save_entry_pos;
<a name="l01936"></a>01936    Bool b_save_entry_type;
<a name="l01937"></a>01937    U8 u8_attr;
<a name="l01938"></a>01938    U32 u32_cluster;
<a name="l01939"></a>01939    U32 u32_size;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#003f1c81dcb2c7a95f191c30b8a4f258">fat_check_mount_select_noopen</a>())
<a name="l01942"></a>01942       <span class="keywordflow">return</span> FALSE;
<a name="l01943"></a>01943 
<a name="l01944"></a>01944    <span class="keywordflow">if</span>( !<a class="code" href="a00017.html#07f36d38eda0af16ef7ef899129d7e7b">fat_check_nav_access_file</a>( TRUE ) )
<a name="l01945"></a>01945       <span class="keywordflow">return</span> FALSE;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947    <span class="comment">// save information for create new name before delete the current name in case of error in creation</span>
<a name="l01948"></a>01948    u16_save_entry_pos = <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a>;
<a name="l01949"></a>01949    b_save_entry_type  = <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a>;
<a name="l01950"></a>01950    <span class="comment">// Get file attributs</span>
<a name="l01951"></a>01951    u8_attr = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>;
<a name="l01952"></a>01952    u32_cluster = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a>;
<a name="l01953"></a>01953    u32_size = <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>;
<a name="l01954"></a>01954       
<a name="l01955"></a>01955    <span class="comment">// Create entry file</span>
<a name="l01956"></a>01956    <span class="keywordflow">if</span> ( !<a class="code" href="a00026.html#27b550ee0cf2326498755b429818b145">nav_file_create</a>( sz_name  ))
<a name="l01957"></a>01957       <span class="keywordflow">return</span> FALSE; <span class="comment">// error</span>
<a name="l01958"></a>01958    <span class="comment">// Modify current file</span>
<a name="l01959"></a>01959    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#1a35321a99150ba643f87cb6c79ec3e5">fat_read_dir</a>())
<a name="l01960"></a>01960       <span class="keywordflow">return</span> FALSE;
<a name="l01961"></a>01961    
<a name="l01962"></a>01962    <span class="comment">// Set file attributs</span>
<a name="l01963"></a>01963    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a> = u8_attr;
<a name="l01964"></a>01964    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> = u32_cluster;
<a name="l01965"></a>01965    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a> = u32_size;
<a name="l01966"></a>01966    <a class="code" href="a00017.html#40035dc41d435ed3281155cdf800cf02">fat_write_entry_file</a>();
<a name="l01967"></a>01967    
<a name="l01968"></a>01968    <span class="comment">// delete entry file name</span>
<a name="l01969"></a>01969    <a class="code" href="a00018.html#14ab00294275fb02f822b22d7dcc6b13">fs_g_nav_fast</a>.<a class="code" href="a00006.html#9f50297ed427918e54da99b8c4fbaf04">u16_entry_pos_sel_file</a> = u16_save_entry_pos; <span class="comment">// go to previous entry name</span>
<a name="l01970"></a>01970    <span class="keywordflow">if</span> ( !<a class="code" href="a00018.html#797fc629a4a513e6a5f2951720da5d47">fat_delete_file</a>(FALSE) )
<a name="l01971"></a>01971       <span class="keywordflow">return</span> FALSE; <span class="comment">// error</span>
<a name="l01972"></a>01972    
<a name="l01973"></a>01973    <span class="keywordflow">if</span> ( !<a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>() )
<a name="l01974"></a>01974       <span class="keywordflow">return</span> FALSE; <span class="comment">// error</span>
<a name="l01975"></a>01975 
<a name="l01976"></a>01976    <span class="comment">// Go to position of new entry (it is the last file or directory )</span>
<a name="l01977"></a>01977    <span class="keywordflow">return</span> <a class="code" href="a00026.html#d7dbd335c9b54a9ebefddf5308df0409">nav_filelist_last</a>( b_save_entry_type );
<a name="l01978"></a>01978 }
<a name="l01979"></a>01979 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
<a name="l01980"></a>01980 <span class="preprocessor"></span>
<a name="l01981"></a>01981 <span class="preprocessor">#if (FSFEATURE_WRITE == (FS_LEVEL_FEATURES &amp; FSFEATURE_WRITE))</span>
<a name="l01982"></a>01982 <span class="preprocessor"></span>
<a name="l01994"></a><a class="code" href="a00027.html#27b550ee0cf2326498755b429818b145">01994</a> Bool  <a class="code" href="a00026.html#27b550ee0cf2326498755b429818b145">nav_file_create</a>( <span class="keyword">const</span> <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_name  )
<a name="l01995"></a>01995 {
<a name="l01996"></a>01996 
<a name="l01997"></a>01997    <span class="comment">// Check if a setting file already exists</span>
<a name="l01998"></a>01998    <span class="keywordflow">if</span> (!<a class="code" href="a00026.html#7ad0aa092d133a156651abe5d871b8eb">nav_filelist_reset</a>())          <span class="comment">// Go to neginning of file list</span>
<a name="l01999"></a>01999       <span class="keywordflow">return</span> FALSE;
<a name="l02000"></a>02000    <span class="keywordflow">if</span> (<a class="code" href="a00026.html#017ce6b53af128e5064a06bc8fadec25">nav_filelist_findname</a>(sz_name , FALSE)) <span class="comment">// Search name in file list (no case sensitive)</span>
<a name="l02001"></a>02001    {
<a name="l02002"></a>02002       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#620feae4af460b0f591356b6408e7b45">FS_ERR_FILE_EXIST</a>;
<a name="l02003"></a>02003       <span class="keywordflow">return</span> FALSE;  <span class="comment">// File exist -&gt; it is impossible to create this name</span>
<a name="l02004"></a>02004    }
<a name="l02005"></a>02005    <span class="comment">// FYC: here, the selection is at the end of the list</span>
<a name="l02006"></a>02006    <span class="comment">// Create entry file</span>
<a name="l02007"></a>02007    <span class="keywordflow">if</span> ( !<a class="code" href="a00018.html#da2110d711208b46e93eb269da40bdf1">fat_create_entry_file_name</a>( sz_name ))
<a name="l02008"></a>02008       <span class="keywordflow">return</span> FALSE; <span class="comment">// error</span>
<a name="l02009"></a>02009    <span class="comment">// By default the informations about the new file is egal to 0 (a free entry in a cluster is filled of 0) </span>
<a name="l02010"></a>02010    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#eaa27a06eca82fa0f65d848def8a4b87">u32_cluster</a> = 0;     <span class="comment">// No first cluster</span>
<a name="l02011"></a>02011    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#6ffedc3932826a337dfb3e656a09edcc">u32_size</a>    = 0;     <span class="comment">// The size is null</span>
<a name="l02012"></a>02012    <a class="code" href="a00018.html#fcc9a3eb6084fd54807483346dfc5d09">fs_g_nav_entry</a>.<a class="code" href="a00005.html#c4f33191c9fd60c7520012bbe6005267">u8_attr</a>     = 0;     <span class="comment">// Attribut is a file</span>
<a name="l02013"></a>02013 
<a name="l02014"></a>02014    <span class="comment">// It is the last FILE of the list</span>
<a name="l02015"></a>02015    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#b0213ed9fc205b282b4c1d92adfa7460">u16_pos_sel_file</a>++;
<a name="l02016"></a>02016    <a class="code" href="a00018.html#5c5e563664aa146853ff976ce0b412ec">fs_g_nav</a>.<a class="code" href="a00004.html#f36b5e65540c67c04d0ca489e2f52332">b_mode_nav</a> = <a class="code" href="a00022.html#20f0a7ade1270e3923abafeb33864c55">FS_FILE</a>;
<a name="l02017"></a>02017    <span class="keywordflow">return</span> <a class="code" href="a00017.html#578ab4800128cde17c0820a5027c1c06">fat_cache_flush</a>();
<a name="l02018"></a>02018 }
<a name="l02019"></a>02019 
<a name="l02020"></a>02020 
<a name="l02030"></a><a class="code" href="a00027.html#13a6b054cd7e59bd3e916702f35f7dde">02030</a> Bool  <a class="code" href="a00026.html#13a6b054cd7e59bd3e916702f35f7dde">nav_file_copy</a>( <span class="keywordtype">void</span> )
<a name="l02031"></a>02031 {
<a name="l02032"></a>02032    _MEM_TYPE_SLOW_ <a class="code" href="a00003.html">Fs_index</a> index;
<a name="l02033"></a>02033    U8 nav_id_save;
<a name="l02034"></a>02034    Bool  status;
<a name="l02035"></a>02035 
<a name="l02036"></a>02036    <span class="keywordflow">if</span>( <a class="code" href="a00026.html#0e9d8d4d0a438b0803c57c775e6c3b9c">nav_file_isdir</a>() )
<a name="l02037"></a>02037    {
<a name="l02038"></a>02038       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#0ecd8f596c1810209c4428aa28be0850">FS_ERR_COPY_DIR</a>; <span class="comment">// Impossible to copy a directory</span>
<a name="l02039"></a>02039       <span class="keywordflow">return</span> FALSE;
<a name="l02040"></a>02040    }
<a name="l02041"></a>02041    <span class="comment">// Get reference of copy file </span>
<a name="l02042"></a>02042    index = <a class="code" href="a00026.html#47882923fca657fb23001d23b6b5369d">nav_getindex</a>();
<a name="l02043"></a>02043 
<a name="l02044"></a>02044    <span class="comment">// In "copy file" navigator select the copy file</span>
<a name="l02045"></a>02045    nav_id_save = <a class="code" href="a00026.html#4a9efd8a5ff4c599be7994c009f0fb5f">nav_get</a>();      
<a name="l02046"></a>02046    <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( <a class="code" href="a00014.html#c0610bdf5a370b9b7e17a892662ed502">FS_NAV_ID_COPYFILE</a> );
<a name="l02047"></a>02047    status = <a class="code" href="a00026.html#503f8d42be2b70cb554589ac7974ed78">nav_gotoindex</a>( &amp;index );
<a name="l02048"></a>02048    <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( nav_id_save );
<a name="l02049"></a>02049 
<a name="l02050"></a>02050    <span class="keywordflow">return</span> status;
<a name="l02051"></a>02051 }
<a name="l02052"></a>02052 
<a name="l02053"></a>02053 
<a name="l02065"></a><a class="code" href="a00027.html#b55eb40d89b96055f71e71533380fdd0">02065</a> Bool  <a class="code" href="a00026.html#b55eb40d89b96055f71e71533380fdd0">nav_file_paste_start</a>( <span class="keyword">const</span> <a class="code" href="a00022.html#80aede4102ec34e739482902f716915a">FS_STRING</a> sz_name  )
<a name="l02066"></a>02066 {
<a name="l02067"></a>02067    U8 nav_id_save;
<a name="l02068"></a>02068    Bool status;
<a name="l02069"></a>02069 
<a name="l02070"></a>02070    <span class="keywordflow">if</span>( <a class="code" href="a00016.html#3d068dfd6cc43279a8f57456a9898754">ID_STREAM_ERR</a> != <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> )
<a name="l02071"></a>02071    {
<a name="l02072"></a>02072      
<a name="l02073"></a>02073       <a class="code" href="a00022.html#3eebd84ddd08a3d4163af24e2722de3c">fs_g_status</a> = <a class="code" href="a00022.html#d5768fc011554b78b4c9fa11ede3b1b9">FS_ERR_COPY_RUNNING</a>;  <span class="comment">// A copy action is always running</span>
<a name="l02074"></a>02074       <span class="keywordflow">return</span> FALSE;
<a name="l02075"></a>02075    }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077    <span class="comment">// Create file to paste</span>
<a name="l02078"></a>02078    <span class="keywordflow">if</span>( !<a class="code" href="a00026.html#27b550ee0cf2326498755b429818b145">nav_file_create</a>( sz_name  ) )
<a name="l02079"></a>02079       <span class="keywordflow">return</span> FALSE;
<a name="l02080"></a>02080    <span class="comment">// Open file in write mode with size 0</span>
<a name="l02081"></a>02081    <span class="keywordflow">if</span>( !<a class="code" href="a00020.html#310a118fba8ffb01c998e5087f32d815">file_open</a>( <a class="code" href="a00022.html#ff44d5e228757d47e44edb5e58282579">FOPEN_MODE_W_PLUS</a> ))
<a name="l02082"></a>02082       <span class="keywordflow">return</span> FALSE;
<a name="l02083"></a>02083 
<a name="l02084"></a>02084    <span class="comment">// Open file to copy</span>
<a name="l02085"></a>02085    nav_id_save = <a class="code" href="a00026.html#4a9efd8a5ff4c599be7994c009f0fb5f">nav_get</a>();      
<a name="l02086"></a>02086    <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( <a class="code" href="a00014.html#c0610bdf5a370b9b7e17a892662ed502">FS_NAV_ID_COPYFILE</a> );
<a name="l02087"></a>02087    status = <a class="code" href="a00020.html#310a118fba8ffb01c998e5087f32d815">file_open</a>(<a class="code" href="a00022.html#438cf836f3fb6b9064a6215b8d1d6b91">FOPEN_MODE_R</a>);
<a name="l02088"></a>02088    <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( nav_id_save );
<a name="l02089"></a>02089 
<a name="l02090"></a>02090    <span class="comment">// If error then close "paste file"</span>
<a name="l02091"></a>02091    <span class="keywordflow">if</span>( !status )
<a name="l02092"></a>02092    {
<a name="l02093"></a>02093       <a class="code" href="a00020.html#7f4f3b65455595cb5be0f7cd7d12e02d">file_close</a>();
<a name="l02094"></a>02094       <span class="keywordflow">return</span> FALSE;
<a name="l02095"></a>02095    }<span class="keywordflow">else</span>{
<a name="l02096"></a>02096       <span class="comment">// Signal start copy</span>
<a name="l02097"></a>02097       <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> = <a class="code" href="a00016.html#3d068dfd6cc43279a8f57456a9898754">ID_STREAM_ERR</a>-1;
<a name="l02098"></a>02098       <span class="keywordflow">return</span> TRUE;
<a name="l02099"></a>02099    }
<a name="l02100"></a>02100 }
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 
<a name="l02112"></a><a class="code" href="a00027.html#c3bfe1b329ff30efaaad183cffa49f03">02112</a> U8    <a class="code" href="a00026.html#c3bfe1b329ff30efaaad183cffa49f03">nav_file_paste_state</a>( Bool b_stop )
<a name="l02113"></a>02113 {
<a name="l02114"></a>02114    _MEM_TYPE_SLOW_ <a class="code" href="a00002.html">Fs_file_segment</a> segment_src;
<a name="l02115"></a>02115    _MEM_TYPE_SLOW_ <a class="code" href="a00002.html">Fs_file_segment</a> segment_dest;
<a name="l02116"></a>02116 
<a name="l02117"></a>02117    <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> status_stream;
<a name="l02118"></a>02118    U8 status_copy;
<a name="l02119"></a>02119    U8 nav_id_save;
<a name="l02120"></a>02120 
<a name="l02121"></a>02121    nav_id_save = <a class="code" href="a00026.html#4a9efd8a5ff4c599be7994c009f0fb5f">nav_get</a>();   <span class="comment">// Get current navigator</span>
<a name="l02122"></a>02122 
<a name="l02123"></a>02123    <span class="comment">// Check, if copy is running</span>
<a name="l02124"></a>02124    <span class="keywordflow">if</span>( <a class="code" href="a00016.html#3d068dfd6cc43279a8f57456a9898754">ID_STREAM_ERR</a> == <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> )
<a name="l02125"></a>02125       <span class="keywordflow">return</span> <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02126"></a>02126 
<a name="l02127"></a>02127    <span class="keywordflow">if</span>( b_stop )
<a name="l02128"></a>02128    {
<a name="l02129"></a>02129       status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02130"></a>02130    }
<a name="l02131"></a>02131    <span class="keywordflow">else</span>
<a name="l02132"></a>02132    {
<a name="l02133"></a>02133       <span class="keywordflow">if</span>( (<a class="code" href="a00016.html#3d068dfd6cc43279a8f57456a9898754">ID_STREAM_ERR</a>-1) != <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> )
<a name="l02134"></a>02134       {
<a name="l02135"></a>02135          <span class="comment">// it isn't the beginning of copy action, then check current stream</span>
<a name="l02136"></a>02136          status_stream = <a class="code" href="a00015.html#bc5895af9a6e16c6e0f90cdce48bdb3a">stream_state</a>( <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> );
<a name="l02137"></a>02137          <span class="keywordflow">switch</span>( status_stream )  
<a name="l02138"></a>02138          {
<a name="l02139"></a>02139          <span class="keywordflow">case</span> <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e291a647d0a662ac6400be3b843dfae52c65">CTRL_BUSY</a>:
<a name="l02140"></a>02140             status_copy = <a class="code" href="a00022.html#a2e2285edc2ee3ef3a4ba10af70524ef">COPY_BUSY</a>;
<a name="l02141"></a>02141             <span class="keywordflow">break</span>;
<a name="l02142"></a>02142          <span class="keywordflow">case</span> <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>:
<a name="l02143"></a>02143             status_copy = <a class="code" href="a00022.html#49311dbf1b3e2f5d778938655895b17a">COPY_FINISH</a>;
<a name="l02144"></a>02144             <span class="keywordflow">break</span>;
<a name="l02145"></a>02145          <span class="keywordflow">case</span> <a class="code" href="a00016.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>:
<a name="l02146"></a>02146          <span class="keywordflow">default</span>:
<a name="l02147"></a>02147             status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02148"></a>02148             <span class="keywordflow">break</span>;
<a name="l02149"></a>02149          }
<a name="l02150"></a>02150       }<span class="keywordflow">else</span>{
<a name="l02151"></a>02151          status_copy = <a class="code" href="a00022.html#49311dbf1b3e2f5d778938655895b17a">COPY_FINISH</a>;
<a name="l02152"></a>02152       }
<a name="l02153"></a>02153    
<a name="l02154"></a>02154       <span class="comment">// Compute a new stream</span>
<a name="l02155"></a>02155       <span class="keywordflow">if</span>( <a class="code" href="a00022.html#49311dbf1b3e2f5d778938655895b17a">COPY_FINISH</a> == status_copy )
<a name="l02156"></a>02156       {
<a name="l02157"></a>02157          <a class="code" href="a00015.html#21c3bfd3da12736296fe092d97cc7acc">stream_stop</a>( <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> );
<a name="l02158"></a>02158 
<a name="l02159"></a>02159          <span class="comment">// check eof source file</span>
<a name="l02160"></a>02160          <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( <a class="code" href="a00014.html#c0610bdf5a370b9b7e17a892662ed502">FS_NAV_ID_COPYFILE</a> );
<a name="l02161"></a>02161          <span class="keywordflow">if</span>( 0 == <a class="code" href="a00020.html#bed52ba7230c6eecf100a3709b9ed74e">file_eof</a>() )
<a name="l02162"></a>02162          {
<a name="l02163"></a>02163             status_copy = <a class="code" href="a00022.html#a2e2285edc2ee3ef3a4ba10af70524ef">COPY_BUSY</a>;
<a name="l02164"></a>02164             segment_src.u32_size_or_pos = 0xFFFF; <span class="comment">// Get the maximum segment supported by navigation (U16)</span>
<a name="l02165"></a>02165             <span class="keywordflow">if</span>( !<a class="code" href="a00020.html#d0fc50dbdd1849e9fe0e81b215ce9335">file_read</a>( &amp;segment_src ))
<a name="l02166"></a>02166             {
<a name="l02167"></a>02167                status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02168"></a>02168             }
<a name="l02169"></a>02169          }
<a name="l02170"></a>02170          <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( nav_id_save );
<a name="l02171"></a>02171    
<a name="l02172"></a>02172          <span class="comment">// check destination file</span>
<a name="l02173"></a>02173          <span class="keywordflow">if</span>( <a class="code" href="a00022.html#a2e2285edc2ee3ef3a4ba10af70524ef">COPY_BUSY</a> == status_copy )
<a name="l02174"></a>02174          {
<a name="l02175"></a>02175             segment_dest.u32_size_or_pos = segment_src.u32_size_or_pos; <span class="comment">// Ask the segment no more larger than source segment</span>
<a name="l02176"></a>02176             <span class="keywordflow">if</span>( !<a class="code" href="a00020.html#1b5c29ddedddd73a1279b9920ea1642f">file_write</a>( &amp;segment_dest ))
<a name="l02177"></a>02177             {
<a name="l02178"></a>02178                status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02179"></a>02179             }
<a name="l02180"></a>02180          }
<a name="l02181"></a>02181 
<a name="l02182"></a>02182          <span class="comment">// Start new stream</span>
<a name="l02183"></a>02183          <span class="keywordflow">if</span>( <a class="code" href="a00022.html#a2e2285edc2ee3ef3a4ba10af70524ef">COPY_BUSY</a> == status_copy )
<a name="l02184"></a>02184          {
<a name="l02185"></a>02185             <span class="comment">// Compute a minimal segment</span>
<a name="l02186"></a>02186             <span class="keywordflow">if</span>( segment_src.u32_size_or_pos &gt; segment_dest.u32_size_or_pos )
<a name="l02187"></a>02187             {
<a name="l02188"></a>02188                <span class="comment">// reposition source file</span>
<a name="l02189"></a>02189                <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( <a class="code" href="a00014.html#c0610bdf5a370b9b7e17a892662ed502">FS_NAV_ID_COPYFILE</a> );
<a name="l02190"></a>02190                <span class="keywordflow">if</span>( !<a class="code" href="a00020.html#2599f935c7e1b69f2650e0943091ddca">file_seek</a>( (U32)(segment_src.u32_size_or_pos - segment_dest.u32_size_or_pos)*<a class="code" href="a00018.html#3d8dbd6dd4c5150d859e8926f69e88b9">FS_SIZE_OF_SECTOR</a> , <a class="code" href="a00021.html#f546c33414158e18f0a25b795f402ccf">FS_SEEK_CUR_RE</a> ))
<a name="l02191"></a>02191                {
<a name="l02192"></a>02192                   status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02193"></a>02193                }
<a name="l02194"></a>02194                <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( nav_id_save );
<a name="l02195"></a>02195                segment_src.u32_size_or_pos = segment_dest.u32_size_or_pos; <span class="comment">// Update source to start a correct transfer</span>
<a name="l02196"></a>02196             }
<a name="l02197"></a>02197          }
<a name="l02198"></a>02198          <span class="keywordflow">if</span>( <a class="code" href="a00022.html#a2e2285edc2ee3ef3a4ba10af70524ef">COPY_BUSY</a> == status_copy )
<a name="l02199"></a>02199          {
<a name="l02200"></a>02200             g_id_trans_memtomem = <a class="code" href="a00015.html#0cd4af35ac08482fa4eca9afdd511345">stream_mem_to_mem</a>( segment_src.u8_lun , segment_src.u32_addr , segment_dest.u8_lun , segment_dest.u32_addr , segment_src.u32_size_or_pos );               
<a name="l02201"></a>02201             <span class="keywordflow">if</span>( <a class="code" href="a00016.html#3d068dfd6cc43279a8f57456a9898754">ID_STREAM_ERR</a> == g_id_trans_memtomem )
<a name="l02202"></a>02202                   status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02203"></a>02203          }
<a name="l02204"></a>02204       }
<a name="l02205"></a>02205    }
<a name="l02206"></a>02206 
<a name="l02207"></a>02207    <span class="comment">// Check end of copy</span>
<a name="l02208"></a>02208    <span class="keywordflow">if</span>( <a class="code" href="a00022.html#a2e2285edc2ee3ef3a4ba10af70524ef">COPY_BUSY</a> != status_copy )
<a name="l02209"></a>02209    {
<a name="l02210"></a>02210       U32 u32_size_exact;
<a name="l02211"></a>02211 
<a name="l02212"></a>02212       <span class="comment">// Stop copy</span>
<a name="l02213"></a>02213       <a class="code" href="a00015.html#21c3bfd3da12736296fe092d97cc7acc">stream_stop</a>( <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> );
<a name="l02214"></a>02214       <a class="code" href="a00026.html#b4aa634e7d90eb225f80597a0e80125d">g_id_trans_memtomem</a> = <a class="code" href="a00016.html#3d068dfd6cc43279a8f57456a9898754">ID_STREAM_ERR</a>;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216       <span class="comment">// Get exact size and close the source file</span>
<a name="l02217"></a>02217       <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( <a class="code" href="a00014.html#c0610bdf5a370b9b7e17a892662ed502">FS_NAV_ID_COPYFILE</a> );
<a name="l02218"></a>02218       u32_size_exact = <a class="code" href="a00026.html#c3989dc4a26fbbdf0726fafae6fe4648">nav_file_lgt</a>();
<a name="l02219"></a>02219       <a class="code" href="a00020.html#7f4f3b65455595cb5be0f7cd7d12e02d">file_close</a>();
<a name="l02220"></a>02220       <a class="code" href="a00026.html#7fac26539a62daf547b5eb159f6a43d4">nav_select</a>( nav_id_save );
<a name="l02221"></a>02221 
<a name="l02222"></a>02222       <span class="comment">// If no error then set the exact size on the destination file</span>
<a name="l02223"></a>02223       <span class="keywordflow">if</span>( <a class="code" href="a00022.html#49311dbf1b3e2f5d778938655895b17a">COPY_FINISH</a> == status_copy )
<a name="l02224"></a>02224       {
<a name="l02225"></a>02225          <span class="keywordflow">if</span>( !<a class="code" href="a00020.html#2599f935c7e1b69f2650e0943091ddca">file_seek</a>( u32_size_exact , <a class="code" href="a00021.html#5b33d405a458db1db212d345b21454f8">FS_SEEK_SET</a> ))
<a name="l02226"></a>02226          {
<a name="l02227"></a>02227             status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02228"></a>02228          }<span class="keywordflow">else</span>{
<a name="l02229"></a>02229             <span class="keywordflow">if</span>( !<a class="code" href="a00020.html#07a8faa41a278961fccc5c0793b01ab1">file_set_eof</a>() )
<a name="l02230"></a>02230             {
<a name="l02231"></a>02231                status_copy = <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a>;
<a name="l02232"></a>02232             }
<a name="l02233"></a>02233          }
<a name="l02234"></a>02234       }
<a name="l02235"></a>02235       <a class="code" href="a00020.html#7f4f3b65455595cb5be0f7cd7d12e02d">file_close</a>();
<a name="l02236"></a>02236       <span class="comment">// If error then delete the destination file</span>
<a name="l02237"></a>02237       <span class="keywordflow">if</span>( <a class="code" href="a00022.html#fd3d634f2538bd115434b5c9ac6147b1">COPY_FAIL</a> == status_copy )
<a name="l02238"></a>02238       {
<a name="l02239"></a>02239          <a class="code" href="a00026.html#8cf46891df029a9f3b62503d2c3cc065">nav_file_del</a>( TRUE );
<a name="l02240"></a>02240       }
<a name="l02241"></a>02241    }
<a name="l02242"></a>02242    <span class="keywordflow">return</span> status_copy;
<a name="l02243"></a>02243 }
<a name="l02244"></a>02244 <span class="preprocessor">#endif  // FS_LEVEL_FEATURES</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Sep 20 12:17:16 2007 for AVR32 UC3 - FSACCESS Services by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>
